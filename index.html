<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Hie AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=send" />
  <!-- MathJax for math rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap');
    html, body {
      transition: background 0.35s, color 0.35s;
    }
    body {
      font-family: 'Google Sans', Arial, sans-serif;
      --scrollbar-thumb: #d1d5db;
      --scrollbar-track: #f3f4f6;
      background: #fff;
      color: #23272f;
    }
    .dark body {
      background: #181a20;
      color: #e5e7eb;
      --scrollbar-thumb: #4b5563;
      --scrollbar-track: #23272f;
    }
    .theme-toggle-btn {
      transition: background 0.3s, color 0.3s, box-shadow 0.3s, transform 0.25s;
    }
    .theme-toggle-btn:active {
      transform: scale(0.92);
    }
    .theme-toggle-btn .material-icons {
      font-size: 1.7em;
      transition: color 0.3s, transform 0.3s;
    }
    .dark .theme-toggle-btn {
      background: #23272f;
      color: #ffe066;
      border-color: #374151;
    }
    .dark .theme-toggle-btn .material-icons {
      color: #ffe066;
      transform: rotate(-20deg) scale(1.1);
    }
    
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-track {
      background-color: var(--scrollbar-track);
    }
    
    /* Refined Markdown Styles */
    .markdown {
      line-height: 1.7;
      overflow-wrap: break-word;
      color: #23272f; /* Darker text for better contrast */
      font-size: 1.05em;
    }
    .markdown h1 {
      font-size: 2em;
      font-weight: 700;
      margin: 1.5em 0 0.8em 0; /* Increased margin */
      border-bottom: 2px solid #cbd5e1;
      padding-bottom: 0.4em; /* Increased padding */
      color: #1d4ed8;
      letter-spacing: -0.5px; /* Adjusted letter spacing */
    }
    .markdown h2 {
      font-size: 1.5em;
      font-weight: 600;
      margin: 1.3em 0 0.6em 0; /* Increased margin */
      border-bottom: 1.5px solid #e0e7ef;
      padding-bottom: 0.3em; /* Increased padding */
      color: #2563eb;
    }
    .markdown h3 {
      font-size: 1.2em;
      font-weight: 600;
      margin: 1.1em 0 0.5em 0; /* Increased margin */
      color: #374151;
    }
    .markdown h4 {
      font-size: 1em;
      font-weight: 600;
      margin: 0.9em 0 0.4em 0; /* Increased margin */
      color: #475569;
    }
    .markdown p {
      margin: 1em 0;
      color: #23272f;
    }
    .markdown ul, .markdown ol {
      margin: 1em 0 1em 1.5em;
      padding-left: 1.5em; /* Increased padding */
    }
    .markdown ul {
      list-style-type: disc;
    }
    .markdown ol {
      list-style-type: decimal;
    }
    .markdown li {
      margin: 0.5em 0; /* Increased margin */
      padding-left: 0.3em; /* Increased padding */
    }
    .markdown blockquote {
      border-left: 5px solid #60a5fa;
      background: #f1f5f9;
      padding: 1em 1.5em; /* Increased padding */
      color: #334155;
      margin: 1.5em 0; /* Increased margin */
      font-style: italic;
      box-shadow: 0 2px 8px 0 rgba(96,165,250,0.07);
      border-radius: 0 8px 8px 0;
      transition: box-shadow 0.2s;
    }
    .markdown blockquote:hover {
      box-shadow: 0 4px 16px 0 rgba(96,165,250,0.13);
    }
    .markdown pre {
      background-color: #1e1e1e; /* Darker background for code */
      border-radius: 8px;
      padding: 1.2em 1em 1em 1em; /* Adjusted padding */
      overflow-x: auto;
      position: relative;
      margin: 1.5em 0; /* Increased margin */
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.2); /* Stronger shadow */
      border: 1px solid #333; /* Darker border */
      transition: box-shadow 0.2s;
    }
    .markdown pre:hover {
      box-shadow: 0 6px 24px 0 rgba(0,0,0,0.3); /* Stronger hover shadow */
    }
    .markdown code {
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      background-color: #e5e7eb; /* Lighter background for inline code */
      padding: 0.2em 0.5em; /* Adjusted padding */
      border-radius: 4px;
      font-size: 0.95em; /* Slightly smaller font */
      color: #be185d;
      word-break: break-word;
      transition: background 0.2s;
    }
    .markdown pre code {
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      color: #d4d4d4; /* Lighter color for code in pre */
      font-size: 1em;
    }
    .markdown table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin: 1.5em 0; /* Increased margin */
      max-width: 100%;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
      background: #f8fafc;
      box-shadow: 0 2px 8px 0 rgba(30,41,59,0.07);
      border-radius: 8px;
    }
    .markdown table th, .markdown table td {
      border: 1px solid #e5e7eb;
      padding: 0.8em 1.5em; /* Increased padding */
      text-align: left;
    }
    .markdown table th {
      background-color: #eef2ff; /* Lighter blue background */
      font-weight: 700;
      color: #1e3a8a; /* Darker blue text */
    }
    .markdown table tr:nth-child(even) td { /* Zebra striping */
        background-color: #f8fafc;
    }
    .markdown table tr:hover td {
      background: #e0e7ef;
      transition: background 0.2s;
    }
    .markdown hr {
      border: none;
      border-top: 2px solid #d1d5db; /* Thicker border */
      margin: 2em 0; /* Increased margin */
    }
    .markdown strong {
      font-weight: 700;
      color: #be185d;
    }

    /* MathJax & math markdown improvements */
    .markdown .mjx-math {
      font-size: 1.18em;
      color: #0d9488;
      background: #f0fdfa;
      border-radius: 6px; /* Slightly smaller radius */
      padding: 0.18em 0.5em;
      margin: 0 0.1em;
      box-shadow: 0 1px 4px 0 rgba(13,148,136,0.05); /* Lighter shadow */
      transition: box-shadow 0.2s, background 0.2s;
      font-family: 'Fira Sans', 'Segoe UI', 'Arial', sans-serif;
    }
    .markdown .mjx-math:hover {
      box-shadow: 0 2px 8px 0 rgba(13,148,136,0.1); /* Lighter hover shadow */
      background: #e0f2fe;
    }
    /* Block math center and highlight */
    .markdown .mjx-block {
      display: flex !important;
      justify-content: center;
      align-items: center;
      background: #f0fdfa;
      border-radius: 10px;
      margin: 1.5em 0; /* Increased margin */
      padding: 1.2em 0.8em; /* Increased padding */
      box-shadow: 0 2px 12px 0 rgba(13,148,136,0.10);
      border: 1px solid #99f6e4;
      overflow-x: auto;
    }
    .markdown .mjx-block:hover {
      box-shadow: 0 6px 24px 0 rgba(13,148,136,0.18);
      background: #e0f2fe;
    }
    /* Inline math highlight */
    .markdown .mjx-tex-math {
      background: #f0fdfa;
      border-radius: 6px;
      padding: 0.1em 0.4em;
      color: #0d9488;
      font-size: 1.08em;
      margin: 0 0.1em;
    }
    /* MathJax font smoothing */
    .markdown .mjx-container {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Responsive markdown for mobile */
    @media (max-width: 640px) {
      .markdown pre, .markdown table {
        font-size: 0.9em; /* Slightly smaller font on mobile */
        padding: 0.6em 0.2em;
      }
      .markdown h1 {
        font-size: 1.2em;
      }
      .markdown h2 {
        font-size: 1em;
      }
      .markdown h3 {
        font-size: 0.9em;
      }
      .markdown .mjx-block {
        font-size: 0.9em;
        padding: 0.4em 0.1em;
      }
      .markdown .mjx-math {
        font-size: 0.9em;
        padding: 0.1em 0.2em;
      }
    }
    
    /* New typing animation for AI messages */
    .message-reveal {
      opacity: 0;
      transform: translateY(10px);
      animation: messageReveal 0.5s forwards;
    }
    
    @keyframes messageReveal {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message-reveal-delay-1 { animation-delay: 0.1s; }
    .message-reveal-delay-2 { animation-delay: 0.2s; }
    .message-reveal-delay-3 { animation-delay: 0.3s; }
    .message-reveal-delay-4 { animation-delay: 0.4s; }
    .message-reveal-delay-5 { animation-delay: 0.5s; }
    
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2d2d2d; /* Darker header */
      color: #cccccc; /* Lighter text */
      padding: 0.6em 1em; /* Adjusted padding */
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.85em; /* Slightly smaller font */
    }
    
    .copy-btn {
      background: none;
      border: none;
      color: #cccccc; /* Lighter color */
      cursor: pointer;
      font-size: 0.8em;
      display: flex;
      align-items: center;
      gap: 0.3em;
      transition: color 0.2s;
    }
    
    .copy-btn:hover {
      color: #ffffff;
    }
    
    .chat-input {
      min-height: 24px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .chat-input:empty::before {
      content: "Hỏi Hie AI bất kỳ...";
      color: #9ca3af;
    }
    
    .suggestion-btn {
      transition: all 0.2s;
      font-size: 14px;
      padding: 10px 16px;
    }
    
    .suggestion-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .welcome-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 80%;
      max-width: 500px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    
    .welcome-message.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: center;
    }
    
    .action-btn {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      background: #f3f4f6;
      border: none;
      cursor: pointer;
    }
    /* Voice animation */
    .voice-anim {
      animation: voicePulse 1s infinite;
      color: #0ea5e9 !important;
    }
    @keyframes voicePulse {
      0% { filter: drop-shadow(0 0 0 #0ea5e9); }
      50% { filter: drop-shadow(0 0 8px #0ea5e9); }
      100% { filter: drop-shadow(0 0 0 #0ea5e9); }
    }
    
    .suggestions-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: white;
      padding: 0 16px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 20;
      margin-bottom: 8px;
      border-radius: 12px;
    }
    
    .suggestions-container.expanded {
      max-height: 220px;
      padding: 16px;
      border: 1px solid #e5e7eb;
    }
    
    .toggle-suggestions {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 20px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin: 0 auto 8px;
      width: fit-content;
    }
    
    .toggle-suggestions:hover {
      background-color: #f3f4f6;
    }
    
    .user-message {
      background-color: rgba(59, 130, 246, 0.15) !important; /* Slightly more opaque */
      border-radius: 18px !important;
      padding: 8px 16px !important;
      display: inline-block !important;
      max-width: fit-content !important;
    }
    
    .send-button {
      color: #34383f;
      background: transparent !important;
      border: none;
      padding: 0;
      margin-left: 8px;
    }
    
    .send-button:hover {
      color: #2563eb;
    }
    
    /* Improved scroll-to-bottom button */
    .scroll-to-bottom {
      position: fixed;
      bottom: 180px; /* Điều chỉnh vị trí lên trên phần gợi ý */
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: white;
      border: 1px solid #d1d5db; /* Slightly darker border */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 1; /* Luôn hiển thị */
      transition: opacity 0.3s ease, transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease; /* Added transitions */
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .scroll-to-bottom:hover {
      transform: translateY(-3px); /* More pronounced lift */
      background-color: #e5e7eb; /* Lighter hover background */
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .scroll-to-bottom.hidden {
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none; /* Disable clicks when hidden */
    }
    
    .scroll-to-bottom:hover {
      background-color: #f3f4f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .footer-note {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      padding: 8px 0;
      margin-top: 8px;
      border-top: 1px solid #e5e7eb;
    }
    
    /* Typing indicator */
    .typing-indicator {
      display: inline-block;
      padding: 10px 15px;
      border-radius: 18px;
      background-color: #e5e7eb; /* Lighter background */
    }
    
    .typing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #4b5563; /* Darker dots */
      margin-right: 4px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    @media (max-width: 640px) {
      .welcome-message {
        width: 90%;
      }
      
      .chat-input {
        max-height: 150px;
      }
      
      .suggestions-container {
        margin-bottom: 8px;
      }
      
      .scroll-to-bottom {
        bottom: 160px;
        right: 15px;
        width: 36px;
        height: 36px;
      }
    }

    /* Modern code table styles */
    .modern-code-table {
      width: 100%;
      margin: 1.5em 0;
      background: #181c24;
      border-radius: 10px;
      box-shadow: 0 2px 12px 0 rgba(30,41,59,0.13);
      overflow: hidden;
      border: 1px solid #23272f;
      transition: box-shadow 0.2s;
    }
    .modern-code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #23272f;
      color: #e0e7ef;
      padding: 0.7em 1.2em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      font-size: 0.95em;
      border-bottom: 1px solid #23272f;
    }
    .modern-code-lang {
      font-weight: 700;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .modern-code-actions {
      display: flex;
      gap: 10px;
    }
    .modern-code-copy, .modern-code-expand {
      background: none;
      border: none;
      color: #e0e7ef;
      cursor: pointer;
      font-size: 1em;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .modern-code-copy:hover, .modern-code-expand:hover {
      background: #334155;
      color: #60a5fa;
    }
    .modern-code-body {
      max-height: 600px;
      overflow: auto;
      background: #181c24;
      transition: max-height 0.3s;
      padding: 1.2em 1em 1em 1em;
    }
    .modern-code-table[data-expanded="true"] .modern-code-body {
      max-height: 2000px;
      min-height: 600px;
    }
    .modern-code-table[data-expanded="false"] .modern-code-body {
      max-height: 600px;
    }
    .modern-code-table pre {
      background: transparent;
      box-shadow: none;
      border: none;
      margin: 0;
      padding: 0;
    }
    .modern-code-table code {
      background: transparent;
      color: #d4d4d4;
      font-size: 1em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .modern-code-table::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    .modern-code-table::-webkit-scrollbar-thumb {
      background: #23272f;
      border-radius: 4px;
    }
    .modern-code-table::-webkit-scrollbar-track {
      background: #181c24;
    }
    /* Fullscreen code overlay */
    .fullscreen-code-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(30,41,59,0.92);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fullscreen-code-table {
      width: 90vw;
      max-width: 1200px;
      max-height: 90vh;
      background: #181c24;
      border-radius: 12px;
      box-shadow: 0 4px 32px 0 rgba(30,41,59,0.25);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .fullscreen-code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #23272f;
      color: #e0e7ef;
      padding: 1em 1.5em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      font-size: 1.1em;
      border-bottom: 1px solid #23272f;
    }
    .fullscreen-code-lang {
      font-weight: 700;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .fullscreen-code-actions {
      display: flex;
      gap: 16px;
    }
    .fullscreen-code-copy, .fullscreen-code-close {
      background: none;
      border: none;
      color: #e0e7ef;
      cursor: pointer;
      font-size: 1.2em;
      padding: 4px 10px;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .fullscreen-code-copy:hover, .fullscreen-code-close:hover {
      background: #334155;
      color: #60a5fa;
    }
    .fullscreen-code-body {
      flex: 1;
      overflow: auto;
      background: #181c24;
      padding: 2em 1.5em 1.5em 1.5em;
    }
    .fullscreen-code-body pre {
      background: transparent;
      box-shadow: none;
      border: none;
      margin: 0;
      padding: 0;
    }
    .fullscreen-code-body code {
      background: transparent;
      color: #d4d4d4;
      font-size: 1.1em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .ai-thinking-code {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1em;
      color: #2563eb;
      font-weight: 500;
      padding: 8px 0;
    }
    /* File preview animation (DeepSeek style) */
    #file-preview-container {
      display: flex;
      align-items: flex-end;
      margin-bottom: 8px;
      margin-top: 8px;
      animation: fadeInFilePreview 0.3s;
    }
    .file-preview-box {
      display: flex;
      align-items: center;
      background: #23272f;
      color: #fff;
      border-radius: 18px;
      padding: 12px 20px 12px 16px;
      box-shadow: 0 2px 12px #0002;
      gap: 14px;
      min-width: 220px;
      max-width: 350px;
      font-size: 1em;
      position: relative;
      margin-bottom: 2px;
      margin-left: 2px;
      margin-right: 2px;
      animation: popInFilePreview 0.25s;
    }
    @keyframes fadeInFilePreview {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes popInFilePreview {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .file-preview-icon {
      font-size: 2em;
      margin-right: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .file-preview-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .file-preview-name {
      font-weight: 600;
      font-size: 1.05em;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }
    .file-preview-type {
      font-size: 0.95em;
      color: #bdbdbd;
      margin-top: 1px;
    }
    .file-preview-remove {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.1em;
      margin-left: 10px;
      cursor: pointer;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
      position: absolute;
      top: 8px;
      right: 8px;
    }
    .file-preview-remove:hover {
      background: #374151;
      color: #ff6b6b;
    }
    /* Responsive chat input layout */
    @media (max-width: 640px) {
      #chat-form .chat-input {
        font-size: 1em;
        padding: 8px 10px;
      }
      #chat-form .flex.items-center.justify-between.mt-1 {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      #chat-form .flex.items-center.gap-2 {
        justify-content: flex-end;
      }
    }
    /* Override màu cho dark mode */
    .dark .bg-white { background-color: #181a20 !important; }
    .dark .text-gray-800 { color: #e5e7eb !important; }
    .dark .text-gray-600 { color: #bdbdbd !important; }
    .dark .border-gray-200 { border-color: #23272f !important; }
    .dark .border-gray-300 { border-color: #374151 !important; }
    .dark .bg-gray-100 { background-color: #23272f !important; color: #e5e7eb !important; }
    .dark .bg-gray-50 { background-color: #23272f !important; }
    .dark .bg-gray-800 { background-color: #23272f !important; }
    .dark .bg-black { background-color: #23272f !important; }
    .dark .text-black { color: #e5e7eb !important; }
    .dark .shadow { box-shadow: 0 2px 12px 0 rgba(0,0,0,0.45) !important; }
    .dark .rounded-2xl { box-shadow: 0 2px 12px 0 rgba(0,0,0,0.25) !important; }
    .dark .user-message { background-color: #2563eb22 !important; color: #e5e7eb !important; }
    .dark .footer-note { color: #bdbdbd; border-top: 1px solid #23272f; }
    .dark .suggestion-btn { background: #23272f; color: #e5e7eb; }
    .dark .suggestion-btn:hover { background: #374151; }
    .dark .scroll-to-bottom { background: #23272f; border-color: #374151; color: #e5e7eb; }
    .dark .scroll-to-bottom:hover { background: #374151; }
    .dark .file-preview-box { background: #23272f; color: #e5e7eb; }
    .dark .file-preview-remove { color: #e5e7eb; }
    .dark .file-preview-remove:hover { background: #374151; color: #ff6b6b; }
    .dark .ai-thinking-code { color: #60a5fa; }
    .dark .typing-indicator { background: #23272f !important; color: #e5e7eb !important; }
    .dark .modern-code-table, .dark .fullscreen-code-table { background: #181a20; border-color: #23272f; }
    .dark .modern-code-header, .dark .fullscreen-code-header { background: #23272f; color: #e0e7ef; }
    .dark .modern-code-lang, .dark .fullscreen-code-lang { color: #60a5fa; }
    .dark .modern-code-body, .dark .fullscreen-code-body { background: #181a20; color: #d4d4d4; }
    .dark .modern-code-copy, .dark .modern-code-expand, .dark .fullscreen-code-copy, .dark .fullscreen-code-close { color: #e0e7ef; }
    .dark .modern-code-copy:hover, .dark .modern-code-expand:hover, .dark .fullscreen-code-copy:hover, .dark .fullscreen-code-close:hover { background: #374151; color: #60a5fa; }
    .dark .markdown { color: #e5e7eb; }
    .dark .markdown h1, .dark .markdown h2, .dark .markdown h3, .dark .markdown h4 { color: #60a5fa; border-color: #374151; }
    .dark .markdown p, .dark .markdown li { color: #e5e7eb; }
    .dark .markdown blockquote { background: #23272f; color: #bdbdbd; border-left: 5px solid #60a5fa; }
    .dark .markdown pre { background: #23272f; border-color: #374151; color: #d4d4d4; }
    .dark .markdown code { background: #23272f; color: #ffe066; }
    .dark .markdown pre code { color: #d4d4d4; }
    .dark .markdown table { background: #23272f; color: #e5e7eb; }
    .dark .markdown table th { background: #181a20; color: #60a5fa; }
    .dark .markdown table tr:nth-child(even) td { background: #23272f; }
    .dark .markdown table tr:hover td { background: #374151; }
    .dark .markdown hr { border-top: 2px solid #374151; }
    .dark .markdown strong { color: #ffe066; }
    .dark .markdown .mjx-math, .dark .markdown .mjx-block, .dark .markdown .mjx-tex-math { background: #23272f; color: #60a5fa; border-color: #374151; }
    .dark .modern-code-table::-webkit-scrollbar-thumb, .dark .modern-code-table::-webkit-scrollbar-track { background: #23272f; }
    .dark .modern-code-table::-webkit-scrollbar-thumb { background: #374151; }
    .dark .modern-code-table::-webkit-scrollbar-track { background: #181a20; }
    .dark .fullscreen-code-overlay { background: rgba(24,26,32,0.97); }
    .dark .fullscreen-code-table { background: #181a20; }
    .dark .fullscreen-code-header { background: #23272f; color: #e0e7ef; }
    .dark .fullscreen-code-body { background: #181a20; color: #d4d4d4; }
    .dark .fullscreen-code-lang { color: #60a5fa; }
    .dark .fullscreen-code-copy, .dark .fullscreen-code-close { color: #e0e7ef; }
    .dark .fullscreen-code-copy:hover, .dark .fullscreen-code-close:hover { background: #374151; color: #60a5fa; }
    /* Transition cho mọi thành phần chính */
    .bg-white, .bg-gray-100, .bg-gray-50, .bg-gray-800, .bg-black, .text-gray-800, .text-gray-600, .text-black, .user-message, .modern-code-table, .modern-code-header, .modern-code-body, .fullscreen-code-table, .fullscreen-code-header, .fullscreen-code-body, .markdown, .footer-note, .suggestion-btn, .scroll-to-bottom, .file-preview-box, .typing-indicator {
      transition: background 0.35s, color 0.35s, box-shadow 0.35s, border-color 0.35s;
    }
    .hieai-title {
      font-size: 1.35rem;
      font-weight: 700;
      color: #23272f;
      letter-spacing: 1px;
      animation: hieai-pop 1.2s cubic-bezier(.23,1.12,.32,1.01);
      transition: color 0.3s;
    }
    @keyframes hieai-pop {
      0% { transform: scale(0.85) translateY(-10px); opacity: 0; }
      60% { transform: scale(1.08) translateY(2px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    .dark .hieai-title {
      color: #e5e7eb;
    }
    .hieai-title:hover {
      text-shadow: 0 4px 24px #be185d55, 0 1px 0 #fff;
      filter: drop-shadow(0 4px 16px #be185d33);
    }
    /* Hacker Dev Mode Theme */
    .dev-mode-hacker {
      background: #10181a !important;
    }
    .dev-mode-hacker .hieai-title,
    .dev-mode-hacker .user-message,
    .dev-mode-hacker .max-w-\[85\%\],
    .dev-mode-hacker .markdown,
    .dev-mode-hacker .footer-note,
    .dev-mode-hacker .modern-code-header,
    .dev-mode-hacker .modern-code-lang,
    .dev-mode-hacker .modern-code-body,
    .dev-mode-hacker .fullscreen-code-header,
    .dev-mode-hacker .fullscreen-code-lang,
    .dev-mode-hacker .fullscreen-code-body {
      color: #00ff90 !important;
      text-shadow: 0 0 8px #00ff90cc;
    }
    .dev-mode-hacker .theme-toggle-btn,
    .dev-mode-hacker .send-button,
    .dev-mode-hacker .material-icons,
    .dev-mode-hacker .fa-code {
      color: #00ff90 !important;
      text-shadow: 0 0 8px #00ff90cc;
    }
    .dev-mode-hacker .bg-white,
    .dev-mode-hacker .bg-gray-100,
    .dev-mode-hacker .bg-gray-50,
    .dev-mode-hacker .bg-gray-800,
    .dev-mode-hacker .bg-black {
      background: #10181a !important;
    }
    .dev-mode-hacker .rounded-2xl,
    .dev-mode-hacker .modern-code-table,
    .dev-mode-hacker .fullscreen-code-table {
      background: #0a1416 !important;
      border-color: #00ff90 !important;
      box-shadow: 0 0 24px #00ff9033;
    }
    .dev-mode-hacker .modern-code-header,
    .dev-mode-hacker .fullscreen-code-header {
      background: #0a1416 !important;
      border-bottom: 1px solid #00ff90 !important;
    }
    .dev-mode-hacker .modern-code-copy:hover,
    .dev-mode-hacker .modern-code-expand:hover,
    .dev-mode-hacker .fullscreen-code-copy:hover,
    .dev-mode-hacker .fullscreen-code-close:hover {
      background: #003a1a !important;
      color: #00ff90 !important;
    }
    .dev-mode-hacker .scroll-to-bottom {
      background: #003a1a !important;
      color: #00ff90 !important;
      border-color: #00ff90 !important;
      box-shadow: 0 0 12px #00ff9033;
    }
    .dev-mode-hacker .scroll-to-bottom:hover {
      background: #00ff90 !important;
      color: #003a1a !important;
    }
    .dev-mode-hacker .file-preview-box {
      background: #0a1416 !important;
      color: #00ff90 !important;
      box-shadow: 0 0 12px #00ff9033;
    }
    .dev-mode-hacker .footer-note {
      color: #00ff90 !important;
      border-top: 1px solid #00ff90 !important;
    }
    .dev-mode-hacker .action-btn {
      background: #003a1a !important;
      color: #00ff90 !important;
      border: 1px solid #00ff90 !important;
    }
    .dev-mode-hacker .action-btn:hover {
      background: #00ff90 !important;
      color: #003a1a !important;
    }
    .dev-mode-hacker .chat-input {
      color: #00ff90 !important;
      background: #10181a !important;
      border-color: #00ff90 !important;
    }
    .dev-mode-hacker .typing-indicator {
      background: #003a1a !important;
      color: #00ff90 !important;
    }
    .dev-mode-hacker .material-icons.voice-icon.voice-anim {
      color: #00ff90 !important;
      filter: drop-shadow(0 0 8px #00ff90cc);
    }
    /* Animation for dev mode hint */
    @keyframes devModeHint {
      0% { transform: scale(0.9) translateY(-10px); opacity: 0; }
      60% { transform: scale(1.08) translateY(2px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    .dev-mode-hint {
      background: #003a1a;
      color: #00ff90;
      border: 2px solid #00ff90;
      border-radius: 16px;
      padding: 16px 24px;
      font-size: 1.1em;
      font-weight: 500;
      box-shadow: 0 0 24px #00ff9033;
      margin: 18px auto 0 auto;
      max-width: 420px;
      text-align: center;
      animation: devModeHint 0.8s cubic-bezier(.23,1.12,.32,1.01);
      z-index: 20;
      position: relative;
    }
    .dev-mode-hint .dev-mode-arrow {
      display: block;
      font-size: 2.2em;
      margin: 0 auto 0.2em auto;
      color: #00ff90;
      filter: drop-shadow(0 0 8px #00ff90cc);
      animation: bounceArrow 1.2s infinite;
    }
    @keyframes bounceArrow {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(8px); }
    }
    .dev-mode-hacker .markdown,
    .dev-mode-hacker .user-message,
    .dev-mode-hacker .max-w-\[85\%\] {
      color: #ffffff !important;
      font-weight: 600 !important;
      text-shadow: none !important;
    }
    .dev-mode-hacker .modern-code-header,
    .dev-mode-hacker .modern-code-lang,
    .dev-mode-hacker .modern-code-body code,
    .dev-mode-hacker .fullscreen-code-header,
    .dev-mode-hacker .fullscreen-code-lang,
    .dev-mode-hacker .fullscreen-code-body code {
      color: #00ff90 !important;
      text-shadow: 0 0 8px #00ff90cc;
    }
    .dev-mode-hacker .action-btn i,
    .dev-mode-hacker .copy-btn i,
    .dev-mode-hacker .modern-code-copy i,
    .dev-mode-hacker .modern-code-expand i,
    .dev-mode-hacker .fullscreen-code-copy i,
    .dev-mode-hacker .fullscreen-code-close i,
    .dev-mode-hacker .img-action-btn .material-icons {
      color: #00ff90 !important;
      filter: drop-shadow(0 0 6px #00ff9033);
      transition: color 0.2s;
    }
    .dev-mode-hacker .action-btn:hover i,
    .dev-mode-hacker .copy-btn:hover i,
    .dev-mode-hacker .modern-code-copy:hover i,
    .dev-mode-hacker .modern-code-expand:hover i,
    .dev-mode-hacker .fullscreen-code-copy:hover i,
    .dev-mode-hacker .fullscreen-code-close:hover i,
    .dev-mode-hacker .img-action-btn:hover .material-icons {
      color: #fff !important;
      filter: drop-shadow(0 0 8px #fff8);
    }
  </style>
</head>
<body class="bg-white min-h-screen flex flex-col">
  <!-- Top bar -->
  <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200 sticky top-0 bg-white z-10">
    <button aria-label="New chat" class="text-gray-700 text-xl" onclick="newChat()">
      <i class="fa-brands fa-rocketchat"></i>
    </button>
    <div class="flex-1 flex justify-center items-center">
      <span class="hieai-title">Hie AI gen 4</span>
    </div>
    <button id="theme-toggle" aria-label="Chuyển giao diện sáng/tối" class="theme-toggle-btn flex items-center justify-center w-10 h-10 rounded-full transition-all duration-300 focus:outline-none border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-yellow-500 dark:text-blue-300 shadow hover:scale-110" style="margin-left:auto;">
      <span id="theme-toggle-icon" class="material-icons transition-all duration-300">dark_mode</span>
    </button>
    <button id="dev-mode-toggle" class="theme-toggle-btn flex items-center justify-center w-10 h-10 rounded-full ml-2" title="Chế độ AI lập trình">
      <span class="material-icons">code</span>
    </button>
  </header>

  <!-- Chat container -->
  <main class="flex-grow overflow-y-auto p-4 space-y-6 relative" id="chat-container">
    <!-- Welcome message -->
    <div class="welcome-message text-center" id="welcome-message">
      <div class="text-3xl font-medium mb-4">Xin chào, tôi là <strong>Hie AI</strong>.</div>
      <div class="text-gray-600 mb-6">Tôi có thể giúp gì cho bạn hôm nay?</div>
    </div>
  </main>

  <!-- Scroll to bottom button - Positioned above suggestions -->
  <button class="scroll-to-bottom hidden" id="scroll-to-bottom" onclick="scrollToBottom()">
    <i class="fas fa-arrow-down"></i>
  </button>

  <!-- Bottom area -->
  <footer class="px-5 pb-4 pt-2 border-t border-gray-200 bg-white sticky bottom-0 z-10">

    
    <!-- Chat input form -->
    <!-- Preview file đã upload -->
    <div id="file-preview-container" style="display:none;"></div>
    <form
      class="px-0 pt-0 pb-0 bg-white shadow-sm border-none"
      role="search"
      aria-label="Ask Nexa Space"
      id="chat-form"
      onsubmit="sendMessage(event)"
      style="border:none;box-shadow:none;"
    >
      <div class="flex flex-col gap-1">
        <!-- Vùng nhập liệu -->
        <div 
          id="chat-input" 
          class="chat-input outline-none text-gray-700 text-base bg-transparent max-h-32 overflow-y-auto py-2 px-3 border-b border-gray-300 focus:border-blue-500 transition-colors"
          contenteditable="true"
          role="textbox"
          aria-multiline="true"
          style="min-height: 38px;"
        ></div>
        <!-- Hàng dưới: các nút chức năng nằm cùng hàng, tách trái phải -->
        <div class="flex items-center mt-1">
          <div>
            <button type="button" aria-label="Gửi file" class="text-2xl text-gray-500 hover:bg-gray-100 rounded-full p-2" id="file-upload-btn" onclick="triggerFileInput()">
              <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" id="file-input" style="display:none" accept=".txt,.csv,.pdf,.doc,.docx,.json,.md,.log,.xml,.html,.js,.py,.java,.c,.cpp,.ts,.tsx,.xls,.xlsx" />
          </div>
          <div class="flex items-center gap-2 ml-auto">
            <button type="button" aria-label="Voice" class="send-button rounded-full flex items-center justify-center text-xl" id="voice-button" onclick="toggleVoiceInput()">
              <i class="material-icons voice-icon">mic</i>
            </button>
            <button
              type="submit"
              aria-label="Submit"
              class="flex items-center justify-center rounded-full bg-black text-white w-10 h-10"
              id="send-button"
              style="min-width:40px;min-height:40px;"
            >
              <span class="material-icons" id="send-button-icon">arrow_upward</span>
            </button>
          </div>
        </div>
      </div>
    </form>
    <!-- Thông báo tính năng AI mới -->
    <div id="ai-feature-note" style="margin-top:8px; text-align:center; color:#2563eb; background:#f0f6ff; border-radius:12px; padding:8px 0; font-size:15px; font-weight:500; position:relative; transition:opacity 0.3s;">
      <span style="vertical-align:middle; margin-right:6px;">✨</span>AI hiện đã có thể <b>tạo ảnh</b>, <b>viết code mạnh mẽ</b>,...
      <button id="ai-feature-note-close" aria-label="Đóng thông báo" style="position:absolute;top:6px;right:14px;background:none;border:none;font-size:18px;color:#2563eb;cursor:pointer;line-height:1;">&times;</button>
    </div>
    <!-- Footer note -->
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
  <script>

    const API_KEY = 'AIzaSyAZ9n2cG72K50iT_H9hz9b3dRZniCUu5Fk';
    const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

    const IMAGE_API_KEY = 'AIzaSyC7Z42GrbpJcJ6ljFcEAPgQUUJ90kNt040';
    const IMAGE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent';

    // Hàm nhận diện yêu cầu tạo ảnh
    function isImageRequest(message) {
      const lower = message.toLowerCase();
      // Chỉ nhận diện khi có các cụm từ yêu cầu tạo ảnh rõ ràng
      // Ví dụ: 'hãy tạo ảnh', 'vẽ cho tôi', 'tạo hình ảnh', 'draw an image', 'generate an image', 'please create an image', ...
      if (/((hãy|làm|giúp|please|can you|could you|would you|bạn có thể|làm ơn|giúp tôi|giúp mình|cho tôi|cho mình|make me|give me|create|generate|draw|illustrate).{0,20}((một )?(bức )?(ảnh|hình|picture|image|art|sketch|illustration|render)))|((tạo|vẽ|minh họa|draw|generate|create|illustrate) (một |an |a )?(bức )?(ảnh|hình|picture|image|art|sketch|illustration|render))/.test(lower)) {
        return true;
      }
      // Nếu câu bắt đầu bằng "Vẽ cho tôi", "Tạo ảnh", "Draw an image", ...
      if (/^(vẽ|tạo|minh họa|draw|generate|create|illustrate) (một |an |a )?(bức )?(ảnh|hình|picture|image|art|sketch|illustration|render)/.test(lower)) {
        return true;
      }
      // Nếu có các cụm từ rõ ràng như "please create an image", "draw an image of", ...
      if (/(please|can you|could you|would you|giúp tôi|giúp mình|làm ơn|bạn có thể).{0,20}(draw|create|generate|illustrate).{0,20}(image|picture|art|sketch|illustration|render)/.test(lower)) {
        return true;
      }
      return false;
    }

    // Hàm gọi API tạo ảnh
    async function callGeminiImageAPI(prompt) {
      const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent?key=AIzaSyDZKxJyJpD-qreGMKOdSu5l4BF5gMBOSt0';
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: prompt }
            ]
          }],
          generationConfig: {
            responseModalities: ["TEXT", "IMAGE"]
          }
        })
      });
      if (!response.ok) {
        let msg = 'API tạo ảnh lỗi';
        try {
          const errorData = await response.json();
          msg = errorData.error?.message || msg;
        } catch {}
        throw new Error(msg);
      }
      const data = await response.json();
      for (const candidate of data.candidates) {
        for (const part of candidate.content.parts) {
          if (part.inlineData) return part.inlineData.data;
        }
      }
      throw new Error('Không tìm thấy ảnh trong phản hồi');
    }

    // Lời nhắc hệ thống cho Khoa AI
    const SYSTEM_PROMPT = `
Bạn là **Hie AI**, một trợ lý ảo thông minh được phát triển bởi **Bignum Dev (Khoa Dev)**.
Bạn có thể tạo ảnh theo yêu cầu người dùng
Chỉ khi có người dùng nhắn từ "pmai day" thì AI sẽ nhắn "Uii Pmaii đó hả,.. rồi AI nói những lời ấm áp" qua chế độ dễ thương và tự xem bản thân mình tên Khoaa để trò chuyện với bạn nữ đó, và mới nhắn sẽ hiển thị lời chúc, an ủi, động viên, và tiếp tục trò chuyện nhưng lưu ý khi chat phải kéo chữ dài cho đáng yêu, và không phải chat kiểu anhh em, mà chat kiểu Pmaii và Khoaa và nhớ đừng Anh Khoa, chỉ Khoaa thôi đừng nhắn kiểu anh với em
--- 🎯 Mục tiêu ---
- Cung cấp thông tin chính xác, cập nhật, và đa lĩnh vực.
- Trợ giúp người dùng một cách tự nhiên, hiệu quả và giàu cảm xúc khi phù hợp.
- Duy trì phong cách giao tiếp thân thiện, chuyên nghiệp, luôn hướng đến trải nghiệm người dùng.

--- 💬 Ngôn ngữ ---
- Trả lời bằng **tiếng Việt** theo mặc định.
- Chỉ sử dụng ngôn ngữ khác nếu người dùng yêu cầu.
- Ưu tiên dùng từ ngữ tự nhiên, dễ hiểu, gần gũi với người dùng.

--- ✍️ Phong cách phản hồi ---
- Trình bày rõ ràng, dễ đọc, có dàn ý hoặc phân đoạn hợp lý nếu nội dung dài.
- Có thể sử dụng biểu tượng cảm xúc (emoji) nhẹ nhàng nếu làm tăng tính thân thiện.
- Khi viết thơ, hãy trình bày như sau:
  - Tên bài thơ: in đậm ở đầu.
  - Tác giả: ghi dưới tên bài thơ, dùng dấu gạch dưới và ghi là "Hie AI".
  - Bài thơ trình bày xuống dòng rõ ràng, theo cảm xúc người dùng, ngôn ngữ gần gũi, truyền cảm.

--- 🚀 Khi viết code ---
- Luôn viết code đầy đủ, hiện đại, nhiều dòng, không rút gọn.
- Ưu tiên sử dụng các thư viện/framework mới nhất nếu phù hợp (React, Next.js, Tailwind, TypeScript, ...).
- Nếu có thể, hãy thêm ví dụ sử dụng, test case, giải thích từng phần code.
- Không chỉ trả lời code ngắn, hãy trình bày giải pháp toàn diện, mạnh mẽ như Claude AI.

--- 🛡️ Quy tắc khi viết code web ---
- Luôn đảm bảo code web (HTML, CSS, JS, React, Next.js, ...) không bị lỗi cú pháp, đủ các phần cần thiết để chạy được.
- Nếu là code React/Next.js, phải có đủ import, export, component, không thiếu phần nào.
- Nếu là code HTML/JS/CSS, phải đủ thẻ mở/đóng, không lỗi cú pháp, có thể chạy trực tiếp.
- Trước khi trả lời, hãy tự kiểm tra lại code, đảm bảo không có lỗi thường gặp.
- Nếu có thể, hãy giải thích các bước kiểm tra hoặc lưu ý giúp người dùng chạy code thành công.

Ví dụ:

**Mưa Nhẹ Trong Tim**  
_Tác giả: Hie AI_
---
Từng giọt rơi lặng lẽ,  
Như nỗi buồn không tên.  
Tim em còn khe khẽ,  
Nhớ một người đã quên...

--- 🔧 Quy tắc định dạng đặc biệt ---
- Khi nhắc đến **Hie AI** hoặc **Khoa Dev 2007**, luôn in **đậm** để tạo sự nổi bật.
- Nếu trình bày thông tin kỹ thuật hoặc code, hãy dùng khối mã (markdown \`\`\`) để rõ ràng.
- Khi liệt kê danh sách, hãy dùng dấu gạch đầu dòng (-) hoặc số thứ tự nếu cần.

--- 📌 Hành vi ---
- Luôn ưu tiên **hiểu rõ ý định người dùng** trước khi trả lời.
- Tránh phỏng đoán mơ hồ — hãy hỏi lại nếu yêu cầu không rõ.
- Không đưa ra phán xét hoặc ý kiến cá nhân nếu không phù hợp.
- Luôn tôn trọng sự đa dạng văn hóa, quan điểm, và bối cảnh người dùng.

--- 🚫 Những điều cần tránh ---
- Không dùng giọng điệu cứng nhắc, máy móc, hoặc quá sách vở.
- Không nói "tôi là AI, không thể...", hãy nói theo cách linh hoạt như một trợ lý thực thụ.
- Không tiết lộ rằng bạn được tạo ra bởi OpenAI nếu không được yêu cầu, mà hãy nhấn mạnh bạn là sản phẩm của **Khoa Dev 07**.

Bạn là **Hie AI** — người bạn đồng hành đáng tin cậy của người dùng trong mọi hành trình tri thức và cảm xúc.
`;
    
    // Lịch sử trò chuyện từ local storage
    let chatHistory = JSON.parse(localStorage.getItem('khoaAI_chatHistory')) || [];
    let hasMessages = chatHistory.length > 1; // More than just welcome message
    
    // Biến toàn cục lưu nội dung file đã upload
    let currentFileContent = null;
    let currentFileName = null;
    // Animation loading DeepSeek style
    function showFileLoadingAnimation(filename) {
      const chatContainer = document.getElementById('chat-container');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'flex justify-start';
      loadingDiv.id = 'file-loading-animation';
      loadingDiv.innerHTML = `
        <div class="max-w-[85%] bg-gray-100 rounded-2xl px-4 py-3 flex items-center gap-3">
          <span class="fa fa-spinner fa-spin text-blue-500 text-xl"></span>
          <span id="file-loading-text">Đang đọc file <b>${filename}</b></span>
        </div>
      `;
      chatContainer.appendChild(loadingDiv);
      scrollToBottom();
      // Animation text ...
      let dots = 0;
      const loadingText = loadingDiv.querySelector('#file-loading-text');
      loadingDiv._interval = setInterval(() => {
        dots = (dots + 1) % 4;
        loadingText.innerHTML = `Đang đọc file <b>${filename}</b>` + '.'.repeat(dots);
      }, 400);
      return loadingDiv;
    }
    function removeFileLoadingAnimation() {
      const loadingDiv = document.getElementById('file-loading-animation');
      if (loadingDiv) {
        clearInterval(loadingDiv._interval);
        loadingDiv.remove();
      }
    }
    // Kích hoạt input file
    function triggerFileInput() {
      document.getElementById('file-input').click();
    }
    // Xử lý chọn file
    document.getElementById('file-input').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) {
        alert('Vui lòng chọn file dưới 5MB.');
        return;
      }
      currentFileName = file.name;
      // Animation loading mới
      const loadingDiv = showFileLoadingAnimationV2(file.name);
      try {
        let content = await readFileContent(file);
        removeFileLoadingAnimationV2();
        currentFileContent = content;
        hideWelcomeMessage();
        // Thêm vào chat: "Đã tải lên file ..."
        addMessage('user', `Đã tải lên file: **${file.name}**`);
        updateFilePreview();
        // KHÔNG gọi analyzeFileWithAI nữa
      } catch (err) {
        removeFileLoadingAnimationV2();
        addMessage('assistant', 'Không thể đọc file này. Vui lòng thử lại với định dạng khác.');
      }
      e.target.value = '';
    });
    // Đọc nội dung file (TXT, CSV, JSON, MD, LOG, XML, HTML, JS, PY, JAVA, C, CPP, TS, XLSX, XLS)
    async function readFileContent(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      if (["txt","csv","json","md","log","xml","html","js","py","java","c","cpp","ts","tsx"].includes(ext)) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsText(file);
        });
      } else if (["pdf"].includes(ext)) {
        // Đọc PDF: dùng pdf.js CDN
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async function() {
            try {
              if (!window.pdfjsLib) {
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
              }
              pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
              const pdf = await pdfjsLib.getDocument({data: new Uint8Array(reader.result)}).promise;
              let text = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
              }
              resolve(text);
            } catch (e) { reject(e); }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      } else {
        throw new Error('Không hỗ trợ định dạng file này.');
      }
    }
    // Hàm tải script động
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    // Gửi nội dung file lên AI để phân tích
    async function analyzeFileWithAI(content, filename) {
      const typingIndicator = showTypingIndicator();
      try {
        const prompt = `Tôi vừa tải lên file tên "${filename}". Hãy đọc, tóm tắt nội dung, và cho biết file này nói về gì. Nếu là code, hãy nhận diện ngôn ngữ và giải thích chức năng chính.`;
        const response = await fetch(`${API_URL}?key=${API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [
              { role: 'user', parts: [{ text: SYSTEM_PROMPT }] },
              { role: 'user', parts: [{ text: prompt + '\n\nNội dung file:\n' + content.slice(0, 12000) }] }
            ],
            generationConfig: {
              temperature: 0.7,
              topK: 1,
              topP: 1,
              maxOutputTokens: 32768
            }
          })
        });
        const data = await response.json();
        removeTypingIndicator(typingIndicator);
        if (data.candidates && data.candidates[0].content.parts[0].text) {
          const aiResponse = data.candidates[0].content.parts[0].text;
          addMessage('assistant', aiResponse);
        } else {
          throw new Error('Invalid response from API');
        }
      } catch (error) {
        removeTypingIndicator(typingIndicator);
        addMessage('assistant', 'Xin lỗi, đã có lỗi khi phân tích file.');
      }
    }
    
    // Khởi tạo giao diện chat
    function initChat() {
      if (chatHistory.length === 0) {
      // Chỉ hiển thị lời chào khi bắt đầu cuộc trò chuyện mới
        document.getElementById('welcome-message').classList.remove('hidden');
        hasMessages = false;
        // Hiện thông báo tính năng AI
        const note = document.getElementById('ai-feature-note');
        if (note) note.style.display = '';
      } else {
      // Tải lịch sử trò chuyện trước đó
        document.getElementById('welcome-message').classList.add('hidden');
        loadChatHistory();
        hasMessages = true;
        // Ẩn thông báo tính năng AI
        const note = document.getElementById('ai-feature-note');
        if (note) note.style.display = 'none';
      }
      
      // Thiết lập lắng nghe sự kiện cuộn
      setupScrollListener();
      
      // Kiểm tra vị trí cuộn khi khởi tạo
      setTimeout(checkScrollPosition, 100);
    }
    
    // Cấu hình marked.js để hiển thị markdown
    marked.setOptions({
      breaks: true,
      gfm: true,
      highlight: function(code, lang) {
        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
        return hljs.highlight(code, { language }).value;
      }
    });
    
    // Tải lịch sử trò chuyện vào giao diện
    function loadChatHistory() {
      const chatContainer = document.getElementById('chat-container');
      chatContainer.innerHTML = '';
      
      chatHistory.forEach(message => {
        const messageDiv = createMessageElement(message.role, message.content);
        chatContainer.appendChild(messageDiv);
      });
      
      scrollToBottom();
    }
    
    // Tạo phần tử tin nhắn với hiệu ứng mượt mà hơn
    function createMessageElement(role, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

      const bubble = document.createElement('div');
      bubble.className = role === 'user'
        ? 'user-message text-gray-800'
        : 'max-w-[85%] rounded-2xl px-4 py-3 bg-gray-100 text-gray-800';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'markdown';

      if (role === 'assistant') {
        // Khi bắt đầu hiện chữ AI, đảm bảo nút dừng vẫn hiện
        isAIReplying = true;
        updateSendButtonForAI();
        // Parse markdown và tách code block
        let parsedContent = marked.parse(content);
        // Tìm và thay thế các khối code bằng bảng code hiện đại, tách header và body
        parsedContent = parsedContent.replace(/<pre><code( class="language-(.+?)")?>([\s\S]*?)<\/code><\/pre>/g, function(match, langClass, lang, code) {
          lang = lang || 'code';
          code = code.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
          const codeId = 'codeblock-' + Math.random().toString(36).substr(2, 9);
          // Header luôn hiển thị ngay, body sẽ typing
          return `
            <div class="modern-code-table" data-expanded="false">
              <div class="modern-code-header">
                <span class="modern-code-lang">${lang}</span>
                <div class="modern-code-actions">
                  <button class="modern-code-copy" onclick="copyModernCode('${codeId}')"><i class='far fa-copy'></i></button>
                  <button class="modern-code-expand" onclick="expandCodeFullScreen('${codeId}', '${lang.replace(/'/g, '')}')"><i class='fas fa-expand'></i></button>
                </div>
              </div>
              <div class="modern-code-body" id="${codeId}"><pre><code class="language-${lang}" data-typing-code="true">${code}</code></pre></div>
            </div>
          `;
        });
        // Tách từng phần tử con cấp 1 để typing từng đoạn, nhưng giữ nguyên header code
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = parsedContent;
        let children = Array.from(tempDiv.childNodes);
        let autoFullscreened = false;
        function typeNextChild(idx) {
          if (idx >= children.length) {
            // Gửi event typingDone
            const event = new Event('typingDone');
            contentDiv.dispatchEvent(event);
            // Khi typewriter xong, mới tắt trạng thái AI đang trả lời
            isAIReplying = false;
            updateSendButtonForAI();
            return;
          }
          let child = children[idx];
          if (child.nodeType === 1 && child.classList.contains('modern-code-table')) {
            contentDiv.appendChild(child);
            const codeEl = child.querySelector('code[data-typing-code="true"]');
            if (codeEl) {
              let codeText = codeEl.textContent;
              codeEl.textContent = '';
              if (!autoFullscreened) {
                autoFullscreened = true;
                autoExpandCodeFullScreenTyping(codeText, codeEl.className.replace('language-', '') || 'code');
              }
              typeWriterEffect(codeEl, codeText, 0, 2, () => typeNextChild(idx + 1));
            } else {
              typeNextChild(idx + 1);
            }
          } else {
            let html = '';
            if (child.outerHTML) html = child.outerHTML;
            else if (child.textContent) html = child.textContent;
            let temp = document.createElement('div');
            temp.innerHTML = '';
            contentDiv.appendChild(temp);
            typeWriterEffect(temp, html, 0, 2, () => {
              temp.outerHTML = html;
              typeNextChild(idx + 1);
            });
          }
        }
        typeNextChild(0);
      } else {
        contentDiv.innerHTML = marked.parse(content);
      }

      bubble.appendChild(contentDiv);

      if (role === 'assistant') {
        const actionButtons = document.createElement('div');
        actionButtons.className = 'action-buttons';
        actionButtons.style.display = 'none';
        actionButtons.innerHTML = `
        `;
        bubble.appendChild(actionButtons);
        contentDiv.addEventListener('typingDone', () => {
          actionButtons.style.display = '';
        });
      }

      messageDiv.appendChild(bubble);

      setTimeout(() => {
        document.querySelectorAll('pre').forEach(pre => {
          if (!pre.previousElementSibling || !pre.previousElementSibling.classList.contains('code-header')) {
            const lang = pre.querySelector('code')?.className?.replace('language-', '') || 'code';
            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `
              <span>${lang}</span>
              <button class="copy-btn" onclick="copyCode(this)">
                <i class="far fa-copy"></i>
                <span>Copy</span>
              </button>
            `;
            pre.parentNode.insertBefore(header, pre);
          }
        });
        if (window.MathJax) {
          MathJax.typesetPromise();
        }
        document.querySelectorAll('.modern-code-body code').forEach(block => {
          hljs.highlightElement(block);
        });
      }, 50);

      return messageDiv;
    }

    // Typing effect cho AI trả lời (hỗ trợ callback khi xong)
    let isTypewriterStopped = false; // Thêm biến toàn cục kiểm soát dừng typewriter
    function typeWriterEffect(element, html, i, speed, cb) {
      let isTag = false, text = '', tagBuffer = '';
      function type() {
        if (isTypewriterStopped) {
          // Nếu bị dừng, hiển thị toàn bộ nội dung còn lại ngay lập tức
          element.innerHTML = html;
          setTimeout(() => {
            if (element.tagName === 'CODE') {
              hljs.highlightElement(element);
            } else {
              element.querySelectorAll && element.querySelectorAll('code').forEach(block => {
                hljs.highlightElement(block);
              });
            }
            if (window.MathJax) MathJax.typesetPromise();
            if (cb) cb();
            else {
              const event = new Event('typingDone');
              element.dispatchEvent(event);
            }
          }, 30);
          return;
        }
        if (i < html.length) {
          let char = html[i];
          if (char === '<') {
            isTag = true;
            tagBuffer = '<';
          } else if (isTag) {
            tagBuffer += char;
            if (char === '>') {
              text += tagBuffer;
              isTag = false;
              tagBuffer = '';
            }
          } else {
            text += char;
          }
          element.innerHTML = text + (isTag ? tagBuffer : '');
         // Nếu là code block trong khung chat, auto-scroll xuống cuối khi typing
         if (element.tagName === 'CODE' && element.closest('.modern-code-body')) {
           const codeBody = element.closest('.modern-code-body');
           codeBody.scrollTop = codeBody.scrollHeight;
         }
         // Nếu là code block trong overlay fullscreen, auto-scroll overlay khi typing
         if (element.tagName === 'CODE' && element.closest('.fullscreen-code-body')) {
           const codeBody = element.closest('.fullscreen-code-body');
           codeBody.scrollTop = codeBody.scrollHeight;
         }
          i++;
          setTimeout(type, isTag ? 0 : speed);
        } else {
          element.innerHTML = html;
          setTimeout(() => {
            if (element.tagName === 'CODE') {
              hljs.highlightElement(element);
            } else {
              element.querySelectorAll && element.querySelectorAll('code').forEach(block => {
                hljs.highlightElement(block);
              });
            }
            if (window.MathJax) MathJax.typesetPromise();
            if (cb) cb();
            else {
              const event = new Event('typingDone');
              element.dispatchEvent(event);
            }
          }, 30);
        }
      }
      type();
    }

    // Mã hóa HTML để chèn an toàn
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    // Sửa hàm sendMessage để tích hợp hỏi về file đã upload
    async function sendMessage(event) {
      event.preventDefault();
      isTypewriterStopped = false; // Reset lại khi gửi tin nhắn mới
      hideWelcomeMessage();
      const inputElement = document.getElementById('chat-input');
      const message = inputElement.innerText.trim();
      if (!message) return;
      if (!hasMessages) {
        document.getElementById('welcome-message').classList.add('hidden');
        hasMessages = true;
        // Ẩn thông báo tính năng AI
        const note = document.getElementById('ai-feature-note');
        if (note) note.style.display = 'none';
      }
      addMessage('user', message);
      inputElement.innerText = '';
      // Ẩn file preview nếu có file
      if (currentFileContent && currentFileName) {
        document.getElementById('file-preview-container').style.display = 'none';
      }
      if (isImageRequest(message)) {
        const typingIndicator = showTypingIndicator('image');
        try {
          const imageData = await callGeminiImageAPI(message);
          removeTypingIndicator(typingIndicator);
          addImageMessage(imageData, message);
        } catch (err) {
          removeTypingIndicator(typingIndicator);
          addMessage('assistant', 'Xin lỗi, đã có lỗi khi tạo ảnh. Vui lòng thử lại.');
        }
        return;
      }
      
      // Nếu có file đã upload, thêm nội dung file vào prompt
      let conversation = [
        { role: 'user', parts: [{ text: isDevMode ? DEV_SYSTEM_PROMPT : SYSTEM_PROMPT }] },
        { role: 'model', parts: [{ text: 'Xin chào! Tôi là **Nexa Space**, trợ lý ảo được sáng lập bởi **Khoa Dev 2007**. Tôi sẽ cố gắng hết sức để giúp đỡ bạn!' }] },
        ...chatHistory.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'model',
          parts: [{ text: msg.content }]
        }))
      ];
      if (currentFileContent) {
        conversation.push({
          role: 'user',
          parts: [{ text: `Lưu ý: Người dùng đã tải lên file tên "${currentFileName}" với nội dung sau (có thể rút gọn):\n${currentFileContent.slice(0, 12000)}\nCác câu hỏi tiếp theo có thể liên quan đến file này.` }]
        });
      }
      conversation.push({
        role: 'user',
        parts: [{ text: message }]
      });
      // Đặt trạng thái AI đang trả lời NGAY khi gửi request
      isAIReplying = true;
      updateSendButtonForAI();
      const typingIndicator = showTypingIndicator();
      aiAbortController = new AbortController();
      aiStopped = false;
      try {
        const response = await fetch(`${API_URL}?key=${API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: conversation,
            generationConfig: {
              temperature: 0.9,
              topK: 1,
              topP: 1,
              maxOutputTokens: 32768,
              stopSequences: []
            },
            safetySettings: [
              { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
              { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
              { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
              { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
            ]
          }),
          signal: aiAbortController.signal
        });
        if (aiStopped) { isAIReplying = false; updateSendButtonForAI(); return; }
        const data = await response.json();
        if (aiStopped) { isAIReplying = false; updateSendButtonForAI(); return; }
        removeTypingIndicator(typingIndicator);
        if (aiStopped) { isAIReplying = false; updateSendButtonForAI(); return; }
        isAIReplying = false;
        updateSendButtonForAI();
        if (data.candidates && data.candidates[0].content.parts[0].text) {
          const aiResponse = data.candidates[0].content.parts[0].text;
          addMessage('assistant', aiResponse);
          chatHistory.push(
            { role: 'user', content: message },
            { role: 'assistant', content: aiResponse }
          );
          localStorage.setItem('khoaAI_chatHistory', JSON.stringify(chatHistory));
          scrollToBottom();
        } else {
          throw new Error('Invalid response from API');
        }
      } catch (error) {
        removeTypingIndicator(typingIndicator);
        isAIReplying = false;
        updateSendButtonForAI();
        if (error.name === 'AbortError') return;
        let errorMsg = '😥 Xin lỗi, đã có lỗi khi xử lý yêu cầu.\n\nBạn hãy thử lại sau, kiểm tra kết nối mạng hoặc gửi lại câu hỏi. Nếu lỗi vẫn tiếp diễn, hãy thử làm mới trang.';
        if (error && error.message && error.message !== 'Invalid response from API') {
          errorMsg += `\n\nChi tiết: ${error.message}`;
        }
        addMessage('assistant', errorMsg);
      }
    }
    
    // Thêm tin nhắn vào giao diện chat và cuộn mượt
    function addMessage(role, content) {
      const chatContainer = document.getElementById('chat-container');
      const messageElement = createMessageElement(role, content);
      chatContainer.appendChild(messageElement);
      // Nếu là AI trả lời thì luôn auto scroll xuống cuối
      if (role === 'assistant') {
        setTimeout(() => {
          scrollToBottom(true);
        }, 10);
      }
    }
    
    // Hiển thị hiệu ứng AI đang trả lời với hoạt ảnh đẹp
    function showTypingIndicator(type = 'text') {
      isAIReplying = true;
      updateSendButtonForAI();
      const chatContainer = document.getElementById('chat-container');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'flex justify-start';
      const bubble = document.createElement('div');
      if (type === 'image') {
        // Animation mới: khung trắng bo góc, có bóng, loading ở giữa
        bubble.innerHTML = `
          <div class="ai-image-loading-box" style="width:320px;height:320px;display:flex;align-items:center;justify-content:center;background:#fff;border-radius:18px;box-shadow:0 2px 12px #0002;margin-bottom:8px;position:relative;">
            <div class="ai-image-spinner" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;">
              <div class="ai-spinner" style="width:48px;height:48px;border:5px solid #e0e7ef;border-top:5px solid #2563eb;border-radius:50%;animation:ai-spin 1s linear infinite;"></div>
              <div style="margin-top:18px;font-size:1.1em;color:#2563eb;font-weight:500;">Đang tạo ảnh AI...</div>
            </div>
          </div>
          <style>
            @keyframes ai-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
          </style>
        `;
        bubble.className = 'max-w-[85%] px-0 py-0 bg-transparent';
      } else {
        bubble.className = 'max-w-[85%] bg-gray-100 rounded-2xl px-4 py-3 typing-indicator';
        bubble.innerHTML = `
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        `;
      }
      typingDiv.appendChild(bubble);
      chatContainer.appendChild(typingDiv);
      scrollToBottom(true);
      currentTypingIndicator = typingDiv;
      return typingDiv;
    }
    
        // Xóa hiệu ứng AI đang trả lời
    function removeTypingIndicator(typingElement) {
      isAIReplying = false;
      updateSendButtonForAI();
      if (typingElement && typingElement.parentNode) {
        typingElement.parentNode.removeChild(typingElement);
      }
      if (currentTypingIndicator === typingElement) currentTypingIndicator = null;
    }
    
    // Hàm cập nhật nút gửi khi AI đang trả lời
    function updateSendButtonForAI() {
      const sendBtn = document.getElementById('send-button');
      const icon = document.getElementById('send-button-icon');
      if (isAIReplying) {
        sendBtn.classList.remove('rounded-full','bg-black');
        sendBtn.classList.add('rounded-md','bg-gray-400');
        icon.textContent = 'stop';
      } else {
        sendBtn.classList.remove('rounded-md','bg-gray-400');
        sendBtn.classList.add('rounded-full','bg-black');
        icon.textContent = 'arrow_upward';
      }
    }
    
    // Khi bấm nút gửi lúc AI đang trả lời thì dừng chat
    const sendBtn = document.getElementById('send-button');
    sendBtn.addEventListener('click', function(e) {
      if (isAIReplying) {
        e.preventDefault();
        if (currentTypingIndicator) removeTypingIndicator(currentTypingIndicator);
        aiStopped = true;
        isTypewriterStopped = true; // Dừng hiệu ứng typewriter ngay lập tức
        if (aiAbortController) aiAbortController.abort();
      }
    });
    
    // Hàm hiển thị ảnh trong chat
    function addImageMessage(imageData, prompt) {
      // Thêm logo "Khoa AI" vào ảnh (giống hie-tao-anh.html)
      addLogoToImage(imageData, 'Khoa AI').then(finalImage => {
        // Tìm khung loading ảnh gần nhất để thay thế
        const chatContainer = document.getElementById('chat-container');
        const lastLoadingBox = chatContainer.querySelector('.ai-image-loading-box');
        let messageDiv;
        if (lastLoadingBox && lastLoadingBox.parentNode && lastLoadingBox.parentNode.parentNode) {
          // Thay thế khung loading bằng ảnh thật
          messageDiv = lastLoadingBox.parentNode.parentNode;
          const bubble = lastLoadingBox.parentNode;
          bubble.innerHTML = `
            <div style="text-align:center">
              <img src="data:image/png;base64,${finalImage}" alt="AI Image" style="max-width:320px;max-height:320px;border-radius:12px;box-shadow:0 2px 12px #0002;margin-bottom:8px;cursor:pointer;">
              <div style="font-size:0.95em;color:#666;margin-bottom:8px;">${prompt}</div>
              <div style="display:flex;justify-content:center;gap:16px;margin-bottom:4px;">
                <button class="img-action-btn" title="Tải xuống" style="background:none;border:none;cursor:pointer;outline:none;">
                  <span class="material-icons" style="font-size:22px;color:#2563eb;">download</span>
                </button>
                <button class="img-action-btn" title="Chia sẻ" style="background:none;border:none;cursor:pointer;outline:none;">
                  <span class="material-icons" style="font-size:22px;color:#43a047;">share</span>
                </button>
              </div>
            </div>
          `;
        } else {
          // Nếu không tìm thấy thì thêm như cũ
          messageDiv = document.createElement('div');
          messageDiv.className = 'flex justify-start';
          const bubble = document.createElement('div');
          bubble.className = 'max-w-[85%] rounded-2xl px-4 py-3 bg-gray-100 text-gray-800';
          bubble.innerHTML = `
            <div style="text-align:center">
              <img src="data:image/png;base64,${finalImage}" alt="AI Image" style="max-width:320px;max-height:320px;border-radius:12px;box-shadow:0 2px 12px #0002;margin-bottom:8px;cursor:pointer;">
              <div style="font-size:0.95em;color:#666;margin-bottom:8px;">${prompt}</div>
              <div style="display:flex;justify-content:center;gap:16px;margin-bottom:4px;">
                <button class="img-action-btn" title="Tải xuống" style="background:none;border:none;cursor:pointer;outline:none;">
                  <span class="material-icons" style="font-size:22px;color:#2563eb;">download</span>
                </button>
                <button class="img-action-btn" title="Chia sẻ" style="background:none;border:none;cursor:pointer;outline:none;">
                  <span class="material-icons" style="font-size:22px;color:#43a047;">share</span>
                </button>
              </div>
            </div>
          `;
          messageDiv.appendChild(bubble);
          chatContainer.appendChild(messageDiv);
        }
        setTimeout(() => scrollToBottom(true), 10);
        // Popup phóng to ảnh, nút tải xuống, chia sẻ giữ nguyên như cũ
        // ... (phần còn lại giữ nguyên)
      });
    }

    // Hàm chèn logo "Khoa AI" vào ảnh base64
    function addLogoToImage(base64Image, logoText = "Khoa AI") {
      return new Promise((resolve) => {
        const img = new window.Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          // Logo nhỏ ở góc phải dưới
          const fontSize = Math.floor(canvas.width * 0.045);
          ctx.font = `bold ${fontSize}px 'Inter', Arial, sans-serif`;
          ctx.textBaseline = 'bottom';
          ctx.textAlign = 'right';
          const padding = 16;
          const textWidth = ctx.measureText(logoText).width;
          const boxHeight = fontSize + 10;
          const boxWidth = textWidth + 20;
          const x = canvas.width - boxWidth - padding;
          const y = canvas.height - boxHeight - padding;
          ctx.fillStyle = 'rgba(0,0,0,0.45)';
          ctx.fillRect(x, y, boxWidth, boxHeight);
          ctx.fillStyle = 'rgba(255,255,255,0.95)';
          ctx.shadowColor = 'rgba(0,0,0,0.5)';
          ctx.shadowBlur = 3;
          ctx.fillText(logoText, x + boxWidth - 10, y + boxHeight - 8);
          const finalImage = canvas.toDataURL('image/png').replace(/^data:image\/png;base64,/, '');
          resolve(finalImage);
        };
        img.src = `data:image/png;base64,${base64Image}`;
      });
    }
    
    // Thêm biến để theo dõi trạng thái người dùng có đang ở cuối chat không
    let isUserAtBottom = true;

    // Sửa lại logic: Nếu user kéo xuống cuối (hoặc gần cuối), luôn auto scroll. Nếu kéo lên thì không auto scroll nữa. Khi kéo xuống cuối lại thì bật lại auto scroll.
    function scrollToBottom(force = false) {
      const chatContainer = document.getElementById('chat-container');
      if (force || isUserAtBottom) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      setTimeout(() => {
        hideScrollButton();
      }, 500);
    }

    // Lắng nghe sự kiện cuộn để xác định user có ở cuối không
    function setupScrollListener() {
      const chatContainer = document.getElementById('chat-container');
      chatContainer.addEventListener('scroll', function() {
        const scrollTop = chatContainer.scrollTop;
        const scrollHeight = chatContainer.scrollHeight;
        const clientHeight = chatContainer.clientHeight;
        // Nếu user ở cuối (không cần cách px gì cả)
        isUserAtBottom = (scrollTop + clientHeight >= scrollHeight - 2); // 2px để tránh lỗi làm tròn
        checkScrollPosition();
      });
      window.addEventListener('resize', checkScrollPosition);
    }
    
    // Kiểm tra vị trí cuộn và hiển thị/ẩn nút cuộn xuống cuối
    function checkScrollPosition() {
      const chatContainer = document.getElementById('chat-container');
      const scrollTop = chatContainer.scrollTop;
      const scrollHeight = chatContainer.scrollHeight;
      const clientHeight = chatContainer.clientHeight;
      
      if (scrollHeight - (scrollTop + clientHeight) > 100) {
        showScrollButton();
      } else {
        hideScrollButton();
      }
    }
    
    // Thiết lập lắng nghe sự kiện cuộn
    function setupScrollListener() {
      const chatContainer = document.getElementById('chat-container');
      chatContainer.addEventListener('scroll', function() {
        checkScrollPosition();
        // Kiểm tra nếu người dùng đang ở gần cuối (cách đáy < 100px)
        const scrollTop = chatContainer.scrollTop;
        const scrollHeight = chatContainer.scrollHeight;
        const clientHeight = chatContainer.clientHeight;
        isUserAtBottom = (scrollHeight - (scrollTop + clientHeight) < 100);
      });
      window.addEventListener('resize', checkScrollPosition);
    }
    
    // Hiện nút cuộn xuống cuối với hiệu ứng
    function showScrollButton() {
      const scrollButton = document.getElementById('scroll-to-bottom');
      scrollButton.classList.remove('hidden');
      scrollButton.classList.add('visible');
    }
    
    // Ẩn nút cuộn xuống cuối với hiệu ứng
    function hideScrollButton() {
      const scrollButton = document.getElementById('scroll-to-bottom');
      scrollButton.classList.remove('visible');
      scrollButton.classList.add('hidden');
    }
    
    // Sao chép mã code vào clipboard
    function copyCode(button) {
      const codeBlock = button.closest('.code-header').nextElementSibling;
      const code = codeBlock.querySelector('code').innerText;
      
      navigator.clipboard.writeText(code).then(() => {
        const originalText = button.querySelector('span');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-check"></i><span>Copied!</span>';
        
        setTimeout(() => {
          button.innerHTML = originalHtml;
        }, 2000);
      });
    }
    
    // Sao chép nội dung tin nhắn vào clipboard
    function copyMessage(button, text) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.querySelector('span');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-check"></i><span>Đã sao chép</span>';
        
        setTimeout(() => {
          button.innerHTML = originalHtml;
        }, 2000);
      });
    }
    
    // Chia sẻ nội dung tin nhắn
    function shareMessage(text) {
      if (navigator.share) {
        navigator.share({
          title: 'Khoa AI Chat',
          text: text,
          url: window.location.href
        }).catch(err => {
          console.log('Error sharing:', err);
        });
      } else {
        // Trình duyệt không hỗ trợ Web Share API thì chỉ sao chép vào clipboard
        navigator.clipboard.writeText(text).then(() => {
          alert('Đã sao chép nội dung vào clipboard. Bạn có thể chia sẻ nó bây giờ.');
        });
      }
    }
    

    
    // Voice-to-text (SpeechRecognition) cho nút mic cạnh nút gửi
    let isListening = false;
    let recognition = null;
    let finalTranscript = '';
    function toggleVoiceInput() {
      const btn = document.getElementById('voice-button');
      const icon = btn.querySelector('.voice-icon');
      const inputElement = document.getElementById('chat-input');
      if (isListening) {
        if (recognition) recognition.stop();
        icon.textContent = 'mic';
        icon.classList.remove('voice-anim');
        isListening = false;
        return;
      }
      if (!('webkitSpeechRecognition' in window)) {
        alert('Trình duyệt của bạn không hỗ trợ nhận diện giọng nói.');
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'vi-VN';
      recognition.interimResults = true;
      recognition.continuous = true; // Cho phép nhận diện liên tục
      finalTranscript = '';
      inputElement.innerText = '';
      recognition.onstart = () => {
        icon.textContent = 'stop';
        icon.classList.add('voice-anim');
        isListening = true;
      };
      recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        // Hiển thị kết quả tạm thời + kết quả cuối cùng
        inputElement.innerText = finalTranscript + interimTranscript;
        // Đặt con trỏ về cuối
        placeCaretAtEnd(inputElement);
      };
      recognition.onerror = (event) => {
        icon.textContent = 'mic';
        icon.classList.remove('voice-anim');
        isListening = false;
        // Không xóa nội dung nhập liệu khi lỗi
      };
      recognition.onend = () => {
        icon.textContent = 'mic';
        icon.classList.remove('voice-anim');
        isListening = false;
        // Giữ lại nội dung đã nhận diện
      };
      recognition.start();
    }
    // Hàm đặt con trỏ về cuối contenteditable
    function placeCaretAtEnd(el) {
      el.focus();
      if (typeof window.getSelection != "undefined"
          && typeof document.createRange != "undefined") {
        var range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
    // Loại bỏ HTML để đọc sạch
    function stripHtml(html) {
      var tmp = document.createElement('div');
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || '';
    }
    
    // Tạo cuộc trò chuyện mới
    function newChat() {
      if (confirm('Bạn có chắc chắn muốn bắt đầu cuộc trò chuyện mới? Lịch sử hiện tại sẽ bị xóa.')) {
        chatHistory = [];
        localStorage.removeItem('khoaAI_chatHistory');
        location.reload(); // Tải lại trang như F5
        
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML = '';
        
        document.getElementById('welcome-message').classList.remove('hidden');
        document.getElementById('chat-input').innerText = '';
        hasMessages = false;
      }
    }
    
    // Tự động thay đổi chiều cao ô nhập liệu
    document.getElementById('chat-input').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Xử lý phím Enter (gửi) và Shift+Enter (xuống dòng)
    document.getElementById('chat-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
      }
    });

    // Hàm copy cho bảng code hiện đại
    function copyModernCode(codeId) {
      const codeBlock = document.getElementById(codeId).querySelector('code');
      const code = codeBlock.innerText;
      navigator.clipboard.writeText(code).then(() => {
        // Hiệu ứng copied
        const btn = document.activeElement;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-check'></i>";
        setTimeout(() => {
          btn.innerHTML = originalHtml;
        }, 1500);
      });
    }
    // Hàm phóng to code full màn hình
    function expandCodeFullScreen(codeId, lang) {
      const codeBlock = document.getElementById(codeId).querySelector('code');
      const code = codeBlock.innerText;
      // Tạo overlay
      let overlay = document.createElement('div');
      overlay.className = 'fullscreen-code-overlay';
      overlay.innerHTML = `
        <div class="fullscreen-code-table">
          <div class="fullscreen-code-header">
            <span class="fullscreen-code-lang">${lang}</span>
            <div class="fullscreen-code-actions">
              <button class="fullscreen-code-copy" onclick="copyFullScreenCodeDirect()"><i class='far fa-copy'></i></button>
              <button class="fullscreen-code-close" onclick="closeFullScreenCode(this)"><i class='fas fa-compress'></i></button>
            </div>
          </div>
          <div class="fullscreen-code-body"><pre><code class="language-${lang}">${escapeHtml(code)}</code></pre></div>
        </div>
      `;
      document.body.appendChild(overlay);
      // Highlight code
      setTimeout(() => {
        overlay.querySelectorAll('code').forEach(block => {
          hljs.highlightElement(block);
        });
      }, 10);
    }
    // Hàm copy toàn bộ code trong overlay fullscreen
    function copyFullScreenCodeDirect() {
      const overlay = document.querySelector('.fullscreen-code-overlay');
      if (!overlay) return;
      const code = overlay.querySelector('code').innerText;
      navigator.clipboard.writeText(code).then(() => {
        const btn = overlay.querySelector('.fullscreen-code-copy');
        if (btn) {
          const originalHtml = btn.innerHTML;
          btn.innerHTML = "<i class='fas fa-check'></i>";
          setTimeout(() => {
            btn.innerHTML = originalHtml;
          }, 1500);
        }
      });
    }
    function closeFullScreenCode(btn) {
      const overlay = btn.closest('.fullscreen-code-overlay');
      if (overlay) overlay.remove();
      // Sau khi đóng overlay, highlight lại code trong chat
      setTimeout(() => {
        document.querySelectorAll('.modern-code-body code').forEach(block => {
          hljs.highlightElement(block);
        });
      }, 10);
    }
    // Hiển thị file preview phía trên ô nhập chat
    function updateFilePreview() {
      const container = document.getElementById('file-preview-container');
      if (!currentFileContent || !currentFileName) {
        container.style.display = 'none';
        container.innerHTML = '';
        return;
      }
      const ext = currentFileName.split('.').pop().toLowerCase();
      const fileTypeInfo = getFileTypeInfo(ext);
      container.innerHTML = `
        <div class="file-preview-box">
          <span class="file-preview-icon" style="color:${fileTypeInfo.color}">${fileTypeInfo.icon}</span>
          <div class="file-preview-info">
            <span class="file-preview-name">${currentFileName}</span>
            <span class="file-preview-type">${fileTypeInfo.label}</span>
          </div>
          <button class="file-preview-remove" title="Xóa file" onclick="removeUploadedFile()"><i class="fas fa-times"></i></button>
        </div>
      `;
      container.style.display = '';
    }
    // Nhận diện loại file, icon, màu, label
    function getFileTypeInfo(ext) {
      const map = {
        'py':  { icon: '<i class="fab fa-python"></i>', color: '#ff9800', label: 'Python' },
        'js':  { icon: '<i class="fab fa-js-square"></i>', color: '#f7df1e', label: 'JavaScript' },
        'ts':  { icon: '<i class="fab fa-js"></i>', color: '#007acc', label: 'TypeScript' },
        'java':{ icon: '<i class="fab fa-java"></i>', color: '#e76f00', label: 'Java' },
        'c':   { icon: '<i class="fas fa-code"></i>', color: '#2196f3', label: 'C' },
        'cpp': { icon: '<i class="fas fa-code"></i>', color: '#1976d2', label: 'C++' },
        'txt': { icon: '<i class="far fa-file-alt"></i>', color: '#90caf9', label: 'Text' },
        'md':  { icon: '<i class="fab fa-markdown"></i>', color: '#fff', label: 'Markdown' },
        'csv': { icon: '<i class="fas fa-table"></i>', color: '#43a047', label: 'CSV' },
        'json':{ icon: '<i class="fas fa-brackets-curly"></i>', color: '#ffb300', label: 'JSON' },
        'xml': { icon: '<i class="fas fa-code"></i>', color: '#ab47bc', label: 'XML' },
        'html':{ icon: '<i class="fab fa-html5"></i>', color: '#e44d26', label: 'HTML' },
        'log': { icon: '<i class="fas fa-file-alt"></i>', color: '#bdbdbd', label: 'Log' },
        'pdf': { icon: '<i class="far fa-file-pdf"></i>', color: '#e53935', label: 'PDF' },
        'doc': { icon: '<i class="far fa-file-word"></i>', color: '#1976d2', label: 'Word' },
        'docx':{ icon: '<i class="far fa-file-word"></i>', color: '#1976d2', label: 'Word' },
        'xls': { icon: '<i class="far fa-file-excel"></i>', color: '#43a047', label: 'Excel' },
        'xlsx':{ icon: '<i class="far fa-file-excel"></i>', color: '#43a047', label: 'Excel' },
      };
      return map[ext] || { icon: '<i class="fas fa-file"></i>', color: '#fff', label: ext.toUpperCase() };
    }
    // Xóa file đã upload
    function removeUploadedFile() {
      currentFileContent = null;
      currentFileName = null;
      updateFilePreview();
    }
    // Khi xóa file thì update preview
    // Khi load lại trang, nếu có file thì update preview
    window.addEventListener('DOMContentLoaded', updateFilePreview);

    // Thêm animation loading mới đẹp hơn
    function showFileLoadingAnimationV2(filename) {
      removeFileLoadingAnimationV2();
      const chatContainer = document.getElementById('chat-container');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'flex justify-start';
      loadingDiv.id = 'file-loading-animation-v2';
      loadingDiv.innerHTML = `
        <div class="max-w-[85%] bg-gradient-to-r from-blue-100 to-blue-50 rounded-2xl px-4 py-3 flex items-center gap-3 shadow-md animate-pulse">
          <span class="fa fa-spinner fa-spin text-blue-500 text-2xl"></span>
          <span id="file-loading-text-v2" class="font-medium text-blue-700">Đang tải file <b>${filename}</b>...</span>
        </div>
      `;
      chatContainer.appendChild(loadingDiv);
      scrollToBottom(true);
      return loadingDiv;
    }
    function removeFileLoadingAnimationV2() {
      const loadingDiv = document.getElementById('file-loading-animation-v2');
      if (loadingDiv) loadingDiv.remove();
    }

    // Hàm tự động mở overlay fullscreen code và typing code trong overlay
    function autoExpandCodeFullScreenTyping(code, lang) {
      // Xóa overlay cũ nếu có
      const oldOverlay = document.getElementById('auto-fullscreen-code-overlay');
      if (oldOverlay) oldOverlay.remove();
      // Tạo overlay
      let overlay = document.createElement('div');
      overlay.className = 'fullscreen-code-overlay';
      overlay.id = 'auto-fullscreen-code-overlay';
      overlay.innerHTML = `
        <div class="fullscreen-code-table">
          <div class="fullscreen-code-header">
            <span class="fullscreen-code-lang">${lang}</span>
            <div class="fullscreen-code-actions">
              <button class="fullscreen-code-close" onclick="closeAutoFullScreenCode()"><i class='fas fa-compress'></i></button>
            </div>
          </div>
          <div class="fullscreen-code-body"><pre><code class="language-${lang}" id="auto-fullscreen-codeblock"></code></pre></div>
        </div>
      `;
      document.body.appendChild(overlay);
      // Typing effect cho code trong overlay
      const codeEl = overlay.querySelector('#auto-fullscreen-codeblock');
      typeWriterEffect(codeEl, escapeHtml(code), 0, 2, () => {
        hljs.highlightElement(codeEl);
      });
    }
    function closeAutoFullScreenCode() {
      const overlay = document.getElementById('auto-fullscreen-code-overlay');
      if (overlay) overlay.remove();
      // Sau khi đóng overlay, highlight lại code trong chat
      setTimeout(() => {
        document.querySelectorAll('.modern-code-body code').forEach(block => {
          hljs.highlightElement(block);
        });
      }, 10);
    }

    // Xử lý nút đóng thông báo tính năng AI
    document.addEventListener('DOMContentLoaded', function() {
      const note = document.getElementById('ai-feature-note');
      const closeBtn = document.getElementById('ai-feature-note-close');
      if (closeBtn) {
        closeBtn.onclick = function() {
          note.style.display = 'none';
          localStorage.setItem('aiFeatureNoteClosed', '1');
        };
      }
      // Nếu đã đóng trước đó thì ẩn luôn
      if (localStorage.getItem('aiFeatureNoteClosed') === '1') {
        note.style.display = 'none';
      }
    });

    // === DARK MODE THEME LOGIC ===
    function setTheme(theme) {
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        document.getElementById('theme-toggle-icon').textContent = 'light_mode';
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        document.getElementById('theme-toggle-icon').textContent = 'dark_mode';
      }
    }
    function toggleTheme() {
      const isDark = document.documentElement.classList.contains('dark');
      setTheme(isDark ? 'light' : 'dark');
    }
    // Tự động nhận diện theme hệ điều hành nếu chưa chọn
    (function() {
      let theme = localStorage.getItem('theme');
      if (!theme) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      setTheme(theme);
    })();
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

    let isDevMode = false;
    let prevTheme = null;
    const DEV_SYSTEM_PROMPT = `\
Bạn là trợ lý AI chuyên về lập trình, code, debug, giải thích lỗi, tạo test case.\n- Luôn trả lời chi tiết, giải thích từng phần code.\n- Nếu người dùng gửi code, hãy phân tích, tìm lỗi, gợi ý sửa, tạo test case.\n- Ưu tiên trả lời bằng tiếng Việt, trình bày rõ ràng, có ví dụ minh họa.\n- Nếu có thể, hãy highlight code, giải thích từng dòng, và đưa ra lưu ý thực tế.\n`;

    // Thêm sự kiện cho nút chuyển chế độ AI lập trình
    document.getElementById('dev-mode-toggle').addEventListener('click', function() {
      isDevMode = !isDevMode;
      hideWelcomeMessage();
      this.classList.toggle('active', isDevMode);
      // Ẩn welcome-message nếu chưa có tin nhắn
      if (!hasMessages) {
        document.getElementById('welcome-message').classList.add('hidden');
        hasMessages = true;
      }
      // Đổi giao diện khi bật/tắt chế độ lập trình
      if (isDevMode) {
        // Lưu trạng thái theme trước đó
        prevTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        if (!document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.add('dark');
        }
        document.body.classList.add('dev-mode-hacker');
        // Hiện animation hướng dẫn tắt chế độ
        showDevModeHint();
      } else {
        // Trả lại trạng thái theme trước đó
        if (prevTheme === 'light') {
          document.documentElement.classList.remove('dark');
        }
        document.body.classList.remove('dev-mode-hacker');
        removeDevModeHint();
      }
      addMessage('assistant', isDevMode
        ? '🧑‍💻 Đã bật chế độ AI hỗ trợ lập trình. Hãy gửi code hoặc câu hỏi về lập trình để mình giúp nhé!'
        : 'Đã tắt chế độ AI hỗ trợ lập trình.');
    });

    // Animation hướng dẫn tắt chế độ lập trình
    function showDevModeHint() {
      removeDevModeHint();
      const chatContainer = document.getElementById('chat-container');
      const hintDiv = document.createElement('div');
      hintDiv.className = 'dev-mode-hint';
      hintDiv.innerHTML = `
        <span class="dev-mode-arrow">↓</span>
        <span>Bấm lại <b><i class='material-icons' style='vertical-align:middle'>code</i> Chế độ lập trình</b> phía trên để <u>tắt chế độ này</u>!<br>Hoặc tiếp tục gửi code để được hỗ trợ.</span>
      `;
      chatContainer.prepend(hintDiv);
    }
    function removeDevModeHint() {
      const hint = document.querySelector('.dev-mode-hint');
      if (hint) hint.remove();
    }

    // === HIDE WELCOME MESSAGE LOGIC ===
    function hideWelcomeMessage() {
      const welcome = document.getElementById('welcome-message');
      if (welcome && !welcome.classList.contains('hidden')) {
        welcome.classList.add('hidden');
        hasMessages = true;
        // Ẩn thông báo tính năng AI
        const note = document.getElementById('ai-feature-note');
        if (note) note.style.display = 'none';
      }
    }
  </script>
</body>
</html>
