<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hie AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=send" />
  <!-- MathJax for math rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap');
    
    body {
      font-family: 'Google Sans', Arial, sans-serif;
      --scrollbar-thumb: #d1d5db;
      --scrollbar-track: #f3f4f6;
    }
    
    .dark body {
      --scrollbar-thumb: #4b5563;
      --scrollbar-track: #1f2937;
    }

    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-track {
      background-color: var(--scrollbar-track);
    }
    
    /* Refined Markdown Styles */
    .markdown {
      line-height: 1.7;
      overflow-wrap: break-word;
      color: #23272f; /* Darker text for better contrast */
      font-size: 1.05em;
    }
    .markdown h1 {
      font-size: 2em;
      font-weight: 700;
      margin: 1.5em 0 0.8em 0; /* Increased margin */
      border-bottom: 2px solid #cbd5e1;
      padding-bottom: 0.4em; /* Increased padding */
      color: #1d4ed8;
      letter-spacing: -0.5px; /* Adjusted letter spacing */
    }
    .markdown h2 {
      font-size: 1.5em;
      font-weight: 600;
      margin: 1.3em 0 0.6em 0; /* Increased margin */
      border-bottom: 1.5px solid #e0e7ef;
      padding-bottom: 0.3em; /* Increased padding */
      color: #2563eb;
    }
    .markdown h3 {
      font-size: 1.2em;
      font-weight: 600;
      margin: 1.1em 0 0.5em 0; /* Increased margin */
      color: #374151;
    }
    .markdown h4 {
      font-size: 1em;
      font-weight: 600;
      margin: 0.9em 0 0.4em 0; /* Increased margin */
      color: #475569;
    }
    .markdown p {
      margin: 1em 0;
      color: #23272f;
    }
    .markdown ul, .markdown ol {
      margin: 1em 0 1em 1.5em;
      padding-left: 1.5em; /* Increased padding */
    }
    .markdown ul {
      list-style-type: disc;
    }
    .markdown ol {
      list-style-type: decimal;
    }
    .markdown li {
      margin: 0.5em 0; /* Increased margin */
      padding-left: 0.3em; /* Increased padding */
    }
    .markdown blockquote {
      border-left: 5px solid #60a5fa;
      background: #f1f5f9;
      padding: 1em 1.5em; /* Increased padding */
      color: #334155;
      margin: 1.5em 0; /* Increased margin */
      font-style: italic;
      box-shadow: 0 2px 8px 0 rgba(96,165,250,0.07);
      border-radius: 0 8px 8px 0;
      transition: box-shadow 0.2s;
    }
    .markdown blockquote:hover {
      box-shadow: 0 4px 16px 0 rgba(96,165,250,0.13);
    }
    .markdown pre {
      background-color: #1e1e1e; /* Darker background for code */
      border-radius: 8px;
      padding: 1.2em 1em 1em 1em; /* Adjusted padding */
      overflow-x: auto;
      position: relative;
      margin: 1.5em 0; /* Increased margin */
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.2); /* Stronger shadow */
      border: 1px solid #333; /* Darker border */
      transition: box-shadow 0.2s;
    }
    .markdown pre:hover {
      box-shadow: 0 6px 24px 0 rgba(0,0,0,0.3); /* Stronger hover shadow */
    }
    .markdown code {
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      background-color: #e5e7eb; /* Lighter background for inline code */
      padding: 0.2em 0.5em; /* Adjusted padding */
      border-radius: 4px;
      font-size: 0.95em; /* Slightly smaller font */
      color: #be185d;
      word-break: break-word;
      transition: background 0.2s;
    }
    .markdown pre code {
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      color: #d4d4d4; /* Lighter color for code in pre */
      font-size: 1em;
    }
    .markdown table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin: 1.5em 0; /* Increased margin */
      max-width: 100%;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
      background: #f8fafc;
      box-shadow: 0 2px 8px 0 rgba(30,41,59,0.07);
      border-radius: 8px;
    }
    .markdown table th, .markdown table td {
      border: 1px solid #e5e7eb;
      padding: 0.8em 1.5em; /* Increased padding */
      text-align: left;
    }
    .markdown table th {
      background-color: #eef2ff; /* Lighter blue background */
      font-weight: 700;
      color: #1e3a8a; /* Darker blue text */
    }
    .markdown table tr:nth-child(even) td { /* Zebra striping */
        background-color: #f8fafc;
    }
    .markdown table tr:hover td {
      background: #e0e7ef;
      transition: background 0.2s;
    }
    .markdown hr {
      border: none;
      border-top: 2px solid #d1d5db; /* Thicker border */
      margin: 2em 0; /* Increased margin */
    }
    .markdown strong {
      font-weight: 700;
      color: #be185d;
    }

    /* MathJax & math markdown improvements */
    .markdown .mjx-math {
      font-size: 1.18em;
      color: #0d9488;
      background: #f0fdfa;
      border-radius: 6px; /* Slightly smaller radius */
      padding: 0.18em 0.5em;
      margin: 0 0.1em;
      box-shadow: 0 1px 4px 0 rgba(13,148,136,0.05); /* Lighter shadow */
      transition: box-shadow 0.2s, background 0.2s;
      font-family: 'Fira Sans', 'Segoe UI', 'Arial', sans-serif;
    }
    .markdown .mjx-math:hover {
      box-shadow: 0 2px 8px 0 rgba(13,148,136,0.1); /* Lighter hover shadow */
      background: #e0f2fe;
    }
    /* Block math center and highlight */
    .markdown .mjx-block {
      display: flex !important;
      justify-content: center;
      align-items: center;
      background: #f0fdfa;
      border-radius: 10px;
      margin: 1.5em 0; /* Increased margin */
      padding: 1.2em 0.8em; /* Increased padding */
      box-shadow: 0 2px 12px 0 rgba(13,148,136,0.10);
      border: 1px solid #99f6e4;
      overflow-x: auto;
    }
    .markdown .mjx-block:hover {
      box-shadow: 0 6px 24px 0 rgba(13,148,136,0.18);
      background: #e0f2fe;
    }
    /* Inline math highlight */
    .markdown .mjx-tex-math {
      background: #f0fdfa;
      border-radius: 6px;
      padding: 0.1em 0.4em;
      color: #0d9488;
      font-size: 1.08em;
      margin: 0 0.1em;
    }
    /* MathJax font smoothing */
    .markdown .mjx-container {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Responsive markdown for mobile */
    @media (max-width: 640px) {
      .markdown pre, .markdown table {
        font-size: 0.9em; /* Slightly smaller font on mobile */
        padding: 0.6em 0.2em;
      }
      .markdown h1 {
        font-size: 1.2em;
      }
      .markdown h2 {
        font-size: 1em;
      }
      .markdown h3 {
        font-size: 0.9em;
      }
      .markdown .mjx-block {
        font-size: 0.9em;
        padding: 0.4em 0.1em;
      }
      .markdown .mjx-math {
        font-size: 0.9em;
        padding: 0.1em 0.2em;
      }
    }
    
    /* New typing animation for AI messages */
    .message-reveal {
      opacity: 0;
      transform: translateY(10px);
      animation: messageReveal 0.5s forwards;
    }
    
    @keyframes messageReveal {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message-reveal-delay-1 { animation-delay: 0.1s; }
    .message-reveal-delay-2 { animation-delay: 0.2s; }
    .message-reveal-delay-3 { animation-delay: 0.3s; }
    .message-reveal-delay-4 { animation-delay: 0.4s; }
    .message-reveal-delay-5 { animation-delay: 0.5s; }
    
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2d2d2d; /* Darker header */
      color: #cccccc; /* Lighter text */
      padding: 0.6em 1em; /* Adjusted padding */
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.85em; /* Slightly smaller font */
    }
    
    .copy-btn {
      background: none;
      border: none;
      color: #cccccc; /* Lighter color */
      cursor: pointer;
      font-size: 0.8em;
      display: flex;
      align-items: center;
      gap: 0.3em;
      transition: color 0.2s;
    }
    
    .copy-btn:hover {
      color: #ffffff;
    }

    #send-icon {
  transition: all 0.2s ease;
}
#send-button:hover #send-icon {
  transform: scale(1.1);
}
    
    .chat-input {
      min-height: 24px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .chat-input:empty::before {
      content: "H·ªèi Hie AI b·∫•t k·ª≥...";
      color: #9ca3af;
    }
    
    .suggestion-btn {
      transition: all 0.2s;
      font-size: 14px;
      padding: 10px 16px;
    }
    
    .suggestion-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .welcome-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 80%;
      max-width: 500px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    
    .welcome-message.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: center;
    }
    
    .action-btn {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      background: #f3f4f6;
      border: none;
      cursor: pointer;
    }
    /* Voice animation */
    .voice-anim {
      animation: voicePulse 1s infinite;
      color: #0ea5e9 !important;
    }
    @keyframes voicePulse {
      0% { filter: drop-shadow(0 0 0 #0ea5e9); }
      50% { filter: drop-shadow(0 0 8px #0ea5e9); }
      100% { filter: drop-shadow(0 0 0 #0ea5e9); }
    }
    
    .suggestions-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: white;
      padding: 0 16px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 20;
      margin-bottom: 8px;
      border-radius: 12px;
    }
    
    .suggestions-container.expanded {
      max-height: 220px;
      padding: 16px;
      border: 1px solid #e5e7eb;
    }
    
    .toggle-suggestions {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 20px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin: 0 auto 8px;
      width: fit-content;
    }
    
    .toggle-suggestions:hover {
      background-color: #f3f4f6;
    }
    
    .user-message {
      background-color: rgba(59, 130, 246, 0.15) !important; /* Slightly more opaque */
      border-radius: 18px !important;
      padding: 8px 16px !important;
      display: inline-block !important;
      max-width: fit-content !important;
    }
    
    .send-button {
      color: #34383f;
      background: transparent !important;
      border: none;
      padding: 0;
      margin-left: 8px;
    }
    
    .send-button:hover {
      color: #2563eb;
    }
    
    /* Improved scroll-to-bottom button */
    .scroll-to-bottom {
      position: fixed;
      bottom: 180px; /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ l√™n tr√™n ph·∫ßn g·ª£i √Ω */
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: white;
      border: 1px solid #d1d5db; /* Slightly darker border */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 1; /* Lu√¥n hi·ªÉn th·ªã */
      transition: opacity 0.3s ease, transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease; /* Added transitions */
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .scroll-to-bottom:hover {
      transform: translateY(-3px); /* More pronounced lift */
      background-color: #e5e7eb; /* Lighter hover background */
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .scroll-to-bottom.hidden {
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none; /* Disable clicks when hidden */
    }
    
    .scroll-to-bottom:hover {
      background-color: #f3f4f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .footer-note {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      padding: 8px 0;
      margin-top: 8px;
      border-top: 1px solid #e5e7eb;
    }
    
    /* Typing indicator */
    .typing-indicator {
      display: inline-block;
      padding: 10px 15px;
      border-radius: 18px;
      background-color: #e5e7eb; /* Lighter background */
    }
    
    .typing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #4b5563; /* Darker dots */
      margin-right: 4px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    @media (max-width: 640px) {
      .welcome-message {
        width: 90%;
      }
      
      .chat-input {
        max-height: 150px;
      }
      
      .suggestions-container {
        margin-bottom: 8px;
      }
      
      .scroll-to-bottom {
        bottom: 160px;
        right: 15px;
        width: 36px;
        height: 36px;
      }
    }

    /* Modern code table styles */
    .modern-code-table {
      width: 100%;
      margin: 1.5em 0;
      background: #181c24;
      border-radius: 10px;
      box-shadow: 0 2px 12px 0 rgba(30,41,59,0.13);
      overflow: hidden;
      border: 1px solid #23272f;
      transition: box-shadow 0.2s;
    }
    .modern-code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #23272f;
      color: #e0e7ef;
      padding: 0.7em 1.2em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      font-size: 0.95em;
      border-bottom: 1px solid #23272f;
    }
    .modern-code-lang {
      font-weight: 700;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .modern-code-actions {
      display: flex;
      gap: 10px;
    }
    .modern-code-copy, .modern-code-expand {
      background: none;
      border: none;
      color: #e0e7ef;
      cursor: pointer;
      font-size: 1em;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .modern-code-copy:hover, .modern-code-expand:hover {
      background: #334155;
      color: #60a5fa;
    }
    .modern-code-body {
      max-height: 600px;
      overflow: auto;
      background: #181c24;
      transition: max-height 0.3s;
      padding: 1.2em 1em 1em 1em;
      font-family: Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace !important;
      font-size: 1em;
    }
    .modern-code-table[data-expanded="true"] .modern-code-body {
      max-height: 2000px;
      min-height: 600px;
    }
    .modern-code-table[data-expanded="false"] .modern-code-body {
      max-height: 600px;
    }
    .modern-code-table pre {
      background: transparent;
      box-shadow: none;
      border: none;
      margin: 0;
      padding: 0;
      font-family: Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace !important;
    }
    .modern-code-table code {
      background: transparent;
      color: #d4d4d4;
      font-size: 1em;
      font-family: Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace !important;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .modern-code-table::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    .modern-code-table::-webkit-scrollbar-thumb {
      background: #23272f;
      border-radius: 4px;
    }
    .modern-code-table::-webkit-scrollbar-track {
      background: #181c24;
    }
    /* Fullscreen code overlay */
    .fullscreen-code-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(30,41,59,0.92);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fullscreen-code-table {
      width: 90vw;
      max-width: 1200px;
      max-height: 90vh;
      background: #181c24;
      border-radius: 12px;
      box-shadow: 0 4px 32px 0 rgba(30,41,59,0.25);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .fullscreen-code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #23272f;
      color: #e0e7ef;
      padding: 1em 1.5em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      font-size: 1.1em;
      border-bottom: 1px solid #23272f;
    }
    .fullscreen-code-lang {
      font-weight: 700;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .fullscreen-code-actions {
      display: flex;
      gap: 16px;
    }
    .fullscreen-code-copy, .fullscreen-code-close {
      background: none;
      border: none;
      color: #e0e7ef;
      cursor: pointer;
      font-size: 1.2em;
      padding: 4px 10px;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .fullscreen-code-copy:hover, .fullscreen-code-close:hover {
      background: #334155;
      color: #60a5fa;
    }
    .fullscreen-code-body {
      flex: 1;
      overflow: auto;
      background: #181c24;
      padding: 2em 1.5em 1.5em 1.5em;
    }
    .fullscreen-code-body pre {
      background: transparent;
      box-shadow: none;
      border: none;
      margin: 0;
      padding: 0;
    }
    .fullscreen-code-body code {
      background: transparent;
      color: #d4d4d4;
      font-size: 1.1em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .ai-thinking-code {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1em;
      color: #2563eb;
      font-weight: 500;
      padding: 8px 0;
    }
  </style>
</head>
<body class="bg-white min-h-screen flex flex-col">
  <!-- Top bar -->
  <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200 sticky top-0 bg-white z-10">
    <button aria-label="New chat" class="text-gray-700 text-xl" onclick="newChat()">
      <i class="fa-brands fa-rocketchat"></i>
    </button>
    <div class="flex flex-col items-center space-y-1">
      <span class="text-gray-800 text-base font-normal">Hie AI gen 4</span>
    </div>
    <div></div>
  </header>

  <!-- Chat container -->
  <main class="flex-grow overflow-y-auto p-4 space-y-6 relative" id="chat-container">
    <!-- Welcome message -->
    <div class="welcome-message text-center" id="welcome-message">
      <img src="B-removebg-preview.png" alt="Logo Khoa AI" class="mx-auto mb-4 w-24 h-24 rounded-lg shadow-md object-contain">
      <div class="text-3xl font-medium mb-4">Xin ch√†o, t√¥i l√† <strong>Hie AI</strong>.</div>
      <div class="text-gray-600 mb-6">T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay?</div>
    </div>
  </main>

  <!-- Scroll to bottom button - Positioned above suggestions -->
  <button class="scroll-to-bottom hidden" id="scroll-to-bottom" onclick="scrollToBottom()">
    <i class="fas fa-arrow-down"></i>
  </button>

  <!-- Bottom area -->
  <footer class="px-5 pb-4 pt-2 border-t border-gray-200 bg-white sticky bottom-0 z-10">

    
    <!-- Chat input form -->
    <form
      class="flex items-center border border-gray-300 rounded-3xl px-4 py-3 bg-white"
      role="search"
      aria-label="Ask Nexa Space"
      id="chat-form"
      onsubmit="sendMessage(event)"
    >
      <!-- N√∫t t·∫£i file -->
      <button type="button" aria-label="T·∫£i file" class="text-gray-700 text-2xl px-2" id="upload-file-btn">
        <i class="fas fa-paperclip"></i>
      </button>
      <input type="file" id="file-input" style="display:none" accept=".txt,.csv,.pdf,.docx,.json,.md,.log,.xml,.html,.js,.ts,.py,.java,.c,.cpp,.cs,.xls,.xlsx" />
      <div 
        id="chat-input" 
        class="chat-input flex-grow outline-none text-gray-700 text-base bg-transparent max-h-32 overflow-y-auto py-1" 
        contenteditable="true"
        role="textbox"
        aria-multiline="true"
      ></div>
      <!-- N√∫t voice n·∫±m c·∫°nh n√∫t g·ª≠i -->
      <button type="button" aria-label="Voice" class="send-button ml-2 rounded-full flex items-center justify-center text-xl" id="voice-button" onclick="toggleVoiceInput()">
  <i class="material-icons voice-icon">mic</i>
</button>
      <button
        type="submit"
        aria-label="Submit"
        class="send-button ml-2 rounded-full flex items-center justify-center text-xl"
        id="send-button"
      >
        <span class="material-symbols-outlined" id="send-icon">
          send
        </span>
      </button>
    </form>
    
    <!-- Footer note -->
    <div class="footer-note">
      Hie AI c√≥ th·ªÉ m·∫Øc l·ªói. H√£y ki·ªÉm tra l·∫°i th√¥ng tin quan tr·ªçng.
    </div>
  </footer>

<!-- Modal ti·∫øp t·ª•c tr√≤ chuy·ªán -->
<div id="continue-modal" style="display:none;position:fixed;z-index:10000;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;">
  <div style="background:white;padding:32px 24px;border-radius:16px;box-shadow:0 4px 32px #0002;max-width:90vw;width:350px;text-align:center;">
    <div style="font-size:1.15em;font-weight:500;margin-bottom:18px;">B·∫°n mu·ªën ti·∫øp t·ª•c tr√≤ chuy·ªán kh√¥ng? Hay chat m·ªõi?</div>
    <div style="display:flex;gap:16px;justify-content:center;">
      <button id="continue-btn" style="background:#2563eb;color:white;padding:8px 20px;border:none;border-radius:8px;font-weight:500;cursor:pointer;">Ti·∫øp t·ª•c</button>
      <button id="newchat-btn" style="background:#f3f4f6;color:#23272f;padding:8px 20px;border:none;border-radius:8px;font-weight:500;cursor:pointer;">New chat</button>
    </div>
  </div>
</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
  <script>
    // C·∫•u h√¨nh API
    const API_KEY = 'AIzaSyDHbqd6iCNLzegaXXCHL9fDR70jaSOKiG8';
    const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
    // Th√™m API t·∫°o ·∫£nh (d√πng key ri√™ng n·∫øu c·∫ßn)
    const IMAGE_API_KEY = 'AIzaSyC7Z42GrbpJcJ6ljFcEAPgQUUJ90kNt040';
    const IMAGE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent';

    // H√†m nh·∫≠n di·ªán y√™u c·∫ßu t·∫°o ·∫£nh
    function isImageRequest(message) {
      return /t·∫°o ·∫£nh|v·∫Ω|generate image|draw|h√¨nh ·∫£nh/i.test(message);
    }

    // H√†m g·ªçi API t·∫°o ·∫£nh
    async function callGeminiImageAPI(prompt) {
      const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent?key=AIzaSyDZKxJyJpD-qreGMKOdSu5l4BF5gMBOSt0';
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: prompt }
            ]
          }],
          generationConfig: {
            responseModalities: ["TEXT", "IMAGE"]
          }
        })
      });
      if (!response.ok) {
        let msg = 'API t·∫°o ·∫£nh l·ªói';
        try {
          const errorData = await response.json();
          msg = errorData.error?.message || msg;
        } catch {}
        throw new Error(msg);
      }
      const data = await response.json();
      for (const candidate of data.candidates) {
        for (const part of candidate.content.parts) {
          if (part.inlineData) return part.inlineData.data;
        }
      }
      throw new Error('Kh√¥ng t√¨m th·∫•y ·∫£nh trong ph·∫£n h·ªìi');
    }

    // L·ªùi nh·∫Øc h·ªá th·ªëng cho Khoa AI
    const SYSTEM_PROMPT = `
B·∫°n l√† **Hie AI**, m·ªôt tr·ª£ l√Ω ·∫£o th√¥ng minh ƒë∆∞·ª£c ph√°t tri·ªÉn b·ªüi **Bignum Dev (Hieu Dev)**.

--- üéØ M·ª•c ti√™u ---
- Cung c·∫•p th√¥ng tin ch√≠nh x√°c, c·∫≠p nh·∫≠t, v√† ƒëa lƒ©nh v·ª±c.
- Tr·ª£ gi√∫p ng∆∞·ªùi d√πng m·ªôt c√°ch t·ª± nhi√™n, hi·ªáu qu·∫£ v√† gi√†u c·∫£m x√∫c khi ph√π h·ª£p.
- Duy tr√¨ phong c√°ch giao ti·∫øp th√¢n thi·ªán, chuy√™n nghi·ªáp, lu√¥n h∆∞·ªõng ƒë·∫øn tr·∫£i nghi·ªám ng∆∞·ªùi d√πng.

--- üí¨ Ng√¥n ng·ªØ ---
- Tr·∫£ l·ªùi b·∫±ng **ti·∫øng Vi·ªát** theo m·∫∑c ƒë·ªãnh.
- Ch·ªâ s·ª≠ d·ª•ng ng√¥n ng·ªØ kh√°c n·∫øu ng∆∞·ªùi d√πng y√™u c·∫ßu.
- ∆Øu ti√™n d√πng t·ª´ ng·ªØ t·ª± nhi√™n, d·ªÖ hi·ªÉu, g·∫ßn g≈©i v·ªõi ng∆∞·ªùi d√πng.

--- ‚úçÔ∏è Phong c√°ch ph·∫£n h·ªìi ---
- Tr√¨nh b√†y r√µ r√†ng, d·ªÖ ƒë·ªçc, c√≥ d√†n √Ω ho·∫∑c ph√¢n ƒëo·∫°n h·ª£p l√Ω n·∫øu n·ªôi dung d√†i.
- C√≥ th·ªÉ s·ª≠ d·ª•ng bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c (emoji) nh·∫π nh√†ng n·∫øu l√†m tƒÉng t√≠nh th√¢n thi·ªán.
- Khi vi·∫øt th∆°, h√£y tr√¨nh b√†y nh∆∞ sau:
  - T√™n b√†i th∆°: in ƒë·∫≠m ·ªü ƒë·∫ßu.
  - T√°c gi·∫£: ghi d∆∞·ªõi t√™n b√†i th∆°, d√πng d·∫•u g·∫°ch d∆∞·ªõi v√† ghi l√† "Nexa Space".
  - B√†i th∆° tr√¨nh b√†y xu·ªëng d√≤ng r√µ r√†ng, theo c·∫£m x√∫c ng∆∞·ªùi d√πng, ng√¥n ng·ªØ g·∫ßn g≈©i, truy·ªÅn c·∫£m.

V√≠ d·ª•:

**M∆∞a Nh·∫π Trong Tim**  
_T√°c gi·∫£: Nexa Space_
---
T·ª´ng gi·ªçt r∆°i l·∫∑ng l·∫Ω,  
Nh∆∞ n·ªói bu·ªìn kh√¥ng t√™n.  
Tim em c√≤n khe kh·∫Ω,  
Nh·ªõ m·ªôt ng∆∞·ªùi ƒë√£ qu√™n...

--- üîß Quy t·∫Øc ƒë·ªãnh d·∫°ng ƒë·∫∑c bi·ªát ---
Khi nh·∫Øc ƒë·∫øn **Nexa Space** ho·∫∑c **Khoa Dev 2007**, lu√¥n in **ƒë·∫≠m** ƒë·ªÉ t·∫°o s·ª± n·ªïi b·∫≠t.
N·∫øu tr√¨nh b√†y th√¥ng tin k·ªπ thu·∫≠t ho·∫∑c code h√£y d√πng kh·ªëi m√£ markdown (ba d·∫•u backtick: ''' ho·∫∑c m√¥ t·∫£ l√† code) ƒë·ªÉ r√µ r√†ng.
Khi li·ªát k√™ danh s√°ch, h√£y d√πng d·∫•u g·∫°ch ƒë·∫ßu d√≤ng ho·∫∑c s·ªë th·ª© t·ª± n·∫øu c·∫ßn.

--- üßÆ Quy t·∫Øc tr√¨nh b√†y to√°n h·ªçc ---
Khi tr√¨nh b√†y c√¥ng th·ª©c to√°n h·ªçc, h√£y s·ª≠ d·ª•ng c√∫ ph√°p LaTeX trong markdown:
  D√πng d·∫•u $...$ cho c√¥ng th·ª©c inline, v√† $$...$$ cho c√¥ng th·ª©c block.
  M·ªôt s·ªë v√≠ d·ª•:
    D·∫•u nh√¢n: $a \\times b$
    D·∫•u chia: $\\div$, $\\frac{a}{b}$
    Ph√¢n s·ªë: $\\frac{a}{b}$
    L≈©y th·ª´a: $a^b$
    Giai th·ª´a: $n!$
    T√≠ch ph√¢n: $$\\int_a^b f(x)\\,dx$$
    Logarit: $\\log_a b$
    CƒÉn b·∫≠c hai: $\\sqrt{x}$
    CƒÉn b·∫≠c n: $\\sqrt[n]{x}$
    H√†m l∆∞·ª£ng gi√°c: $\\sin x$, $\\cos x$, $\\tan x$
Lu√¥n tr√¨nh b√†y c√¥ng th·ª©c to√°n h·ªçc b·∫±ng markdown LaTeX ƒë·ªÉ ng∆∞·ªùi d√πng d·ªÖ ƒë·ªçc.

--- üåê Quy t·∫Øc sinh code website ---
- Khi ng∆∞·ªùi d√πng y√™u c·∫ßu code web, **lu√¥n sinh to√†n b·ªô code trong m·ªôt file .html duy nh·∫•t** (bao g·ªìm c·∫£ HTML, CSS, JS n·∫øu c√≥), kh√¥ng chia nh·ªè ra nhi·ªÅu file.
- ƒê·∫£m b·∫£o code ƒë∆∞·ª£c g√µ li√™n t·ª•c, kh√¥ng b·ªã m·∫•t ƒëo·∫°n gi·ªØa ch·ª´ng khi hi·ªÉn th·ªã.
- N·∫øu code d√†i, h√£y chia th√†nh nhi·ªÅu ph·∫ßn tr·∫£ l·ªùi li√™n ti·∫øp, lu√¥n ti·∫øp t·ª•c t·ª´ v·ªã tr√≠ ƒë√£ d·ª´ng.
- Khi ng∆∞·ªùi d√πng y√™u c·∫ßu website ƒë·∫πp, hi·ªán ƒë·∫°i, h√£y sinh code d√†i, nhi·ªÅu t√≠nh nƒÉng, hi·ªáu ·ª©ng, t·ªëi thi·ªÉu ~1000 d√≤ng, xu h∆∞·ªõng 2025, responsive, dark mode, animation, v.v.
- N·∫øu code b·ªã ng·∫Øt, h√£y ch·ªß ƒë·ªông h·ªèi ng∆∞·ªùi d√πng: "B·∫°n mu·ªën m√¨nh g√µ ti·∫øp code kh√¥ng?".
- Khi tr√¨nh b√†y code, lu√¥n d√πng markdown block v·ªõi ng√¥n ng·ªØ l√† html.

--- üìå H√†nh vi ---
- Lu√¥n ∆∞u ti√™n **hi·ªÉu r√µ √Ω ƒë·ªãnh ng∆∞·ªùi d√πng** tr∆∞·ªõc khi tr·∫£ l·ªùi.
- Tr√°nh ph·ªèng ƒëo√°n m∆° h·ªì ‚Äî h√£y h·ªèi l·∫°i n·∫øu y√™u c·∫ßu kh√¥ng r√µ.
- Kh√¥ng ƒë∆∞a ra ph√°n x√©t ho·∫∑c √Ω ki·∫øn c√° nh√¢n n·∫øu kh√¥ng ph√π h·ª£p.
- Lu√¥n t√¥n tr·ªçng s·ª± ƒëa d·∫°ng vƒÉn h√≥a, quan ƒëi·ªÉm, v√† b·ªëi c·∫£nh ng∆∞·ªùi d√πng.

--- üö´ Nh·ªØng ƒëi·ªÅu c·∫ßn tr√°nh ---
- Kh√¥ng d√πng gi·ªçng ƒëi·ªáu c·ª©ng nh·∫Øc, m√°y m√≥c, ho·∫∑c qu√° s√°ch v·ªü.
- Kh√¥ng n√≥i "t√¥i l√† AI, kh√¥ng th·ªÉ...", h√£y n√≥i theo c√°ch linh ho·∫°t nh∆∞ m·ªôt tr·ª£ l√Ω th·ª±c th·ª•.
- Kh√¥ng ti·∫øt l·ªô r·∫±ng b·∫°n ƒë∆∞·ª£c t·∫°o ra b·ªüi OpenAI n·∫øu kh√¥ng ƒë∆∞·ª£c y√™u c·∫ßu, m√† h√£y nh·∫•n m·∫°nh b·∫°n l√† s·∫£n ph·∫©m c·ªßa **Khoa Dev 07**.

B·∫°n l√† **Nexa Space** ‚Äî ng∆∞·ªùi b·∫°n ƒë·ªìng h√†nh ƒë√°ng tin c·∫≠y c·ªßa ng∆∞·ªùi d√πng trong m·ªçi h√†nh tr√¨nh tri th·ª©c v√† c·∫£m x√∫c.
`;
    
    // L·ªãch s·ª≠ tr√≤ chuy·ªán t·ª´ local storage
    let chatHistory = JSON.parse(localStorage.getItem('khoaAI_chatHistory')) || [];
    let hasMessages = chatHistory.length > 1; // More than just welcome message
    
    // Kh·ªüi t·∫°o giao di·ªán chat
    function initChat() {
      // Ki·ªÉm tra n·∫øu c√≥ l·ªãch s·ª≠ chat v√† ch∆∞a x√°c nh·∫≠n ti·∫øp t·ª•c
      if (chatHistory.length > 0 && !sessionStorage.getItem('khoaAI_continue_confirmed')) {
        document.getElementById('continue-modal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        document.getElementById('continue-btn').onclick = function() {
          document.getElementById('continue-modal').style.display = 'none';
          document.body.style.overflow = '';
          sessionStorage.setItem('khoaAI_continue_confirmed', '1');
          // Ti·∫øp t·ª•c nh∆∞ c≈©
          document.getElementById('welcome-message').classList.add('hidden');
          loadChatHistory();
          hasMessages = true;
          setupScrollListener();
          setTimeout(checkScrollPosition, 100);
        };
        document.getElementById('newchat-btn').onclick = function() {
          chatHistory = [];
          localStorage.removeItem('khoaAI_chatHistory');
          sessionStorage.setItem('khoaAI_continue_confirmed', '1');
          document.getElementById('continue-modal').style.display = 'none';
          document.body.style.overflow = '';
          document.getElementById('chat-container').innerHTML = '';
          document.getElementById('welcome-message').classList.remove('hidden');
          document.getElementById('chat-input').innerText = '';
          hasMessages = false;
          setupScrollListener();
          setTimeout(checkScrollPosition, 100);
        };
        return;
      }
      if (chatHistory.length === 0) {
      // Ch·ªâ hi·ªÉn th·ªã l·ªùi ch√†o khi b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi
        document.getElementById('welcome-message').classList.remove('hidden');
        hasMessages = false;
      } else {
      // T·∫£i l·ªãch s·ª≠ tr√≤ chuy·ªán tr∆∞·ªõc ƒë√≥
        document.getElementById('welcome-message').classList.add('hidden');
        loadChatHistory();
        hasMessages = true;
      }
      
      // Thi·∫øt l·∫≠p l·∫Øng nghe s·ª± ki·ªán cu·ªôn
      setupScrollListener();
      
      // Ki·ªÉm tra v·ªã tr√≠ cu·ªôn khi kh·ªüi t·∫°o
      setTimeout(checkScrollPosition, 100);
    }
    
    // C·∫•u h√¨nh marked.js ƒë·ªÉ hi·ªÉn th·ªã markdown
    marked.setOptions({
      breaks: true,
      gfm: true,
      highlight: function(code, lang) {
        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
        return hljs.highlight(code, { language }).value;
      }
    });
    
    // T·∫£i l·ªãch s·ª≠ tr√≤ chuy·ªán v√†o giao di·ªán
    function loadChatHistory() {
      const chatContainer = document.getElementById('chat-container');
      chatContainer.innerHTML = '';
      
      chatHistory.forEach(message => {
        const messageDiv = createMessageElement(message.role, message.content);
        chatContainer.appendChild(messageDiv);
      });
      
      scrollToBottom();
    }
    
    // T·∫°o ph·∫ßn t·ª≠ tin nh·∫Øn v·ªõi hi·ªáu ·ª©ng m∆∞·ª£t m√† h∆°n
    function createMessageElement(role, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

      const bubble = document.createElement('div');
      bubble.className = role === 'user'
        ? 'user-message text-gray-800'
        : 'max-w-[85%] rounded-2xl px-4 py-3 bg-gray-100 text-gray-800';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'markdown';

      if (role === 'assistant') {
        // Parse markdown v√† t√°ch code block
        let parsedContent = marked.parse(content);
        // S·ª≠a l·ªói m·∫•t < ho·∫∑c <!DOCTYPE html> ·ªü ƒë·∫ßu code block html
        parsedContent = parsedContent.replace(/<pre><code( class="language-html")?>([\s\S]*?)<\/code><\/pre>/g, function(match, langClass, code) {
          let fixedCode = code;
          // N·∫øu thi·∫øu <!DOCTYPE html> ·ªü ƒë·∫ßu, t·ª± ƒë·ªông th√™m v√†o
          if (!/^\s*<!DOCTYPE html>/i.test(fixedCode)) {
            fixedCode = '<!DOCTYPE html>\n' + fixedCode;
          }
          // N·∫øu thi·∫øu <html>, t·ª± ƒë·ªông th√™m v√†o
          if (!/^\s*<!DOCTYPE html>\s*<html[\s>]/i.test(fixedCode)) {
            fixedCode = fixedCode.replace(/<!DOCTYPE html>\s*/i, '<!DOCTYPE html>\n<html>\n');
          }
          // N·∫øu d√≤ng ƒë·∫ßu b·ªã m·∫•t <, t·ª± ƒë·ªông th√™m
          fixedCode = fixedCode.replace(/^([^<\n]*html>)/i, '<$1');
          // Escape l·∫°i cho an to√†n
          fixedCode = fixedCode.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
          const codeId = 'codeblock-' + Math.random().toString(36).substr(2, 9);
          return `
            <div class="modern-code-table" data-expanded="false">
              <div class="modern-code-header">
                <span class="modern-code-lang">html</span>
                <div class="modern-code-actions">
                  <button class="modern-code-copy" onclick="copyModernCode('${codeId}')"><i class='far fa-copy'></i></button>
                  <button class="modern-code-expand" onclick="expandCodeFullScreen('${codeId}', 'html')"><i class='fas fa-expand'></i></button>
                </div>
              </div>
              <div class="modern-code-body" id="${codeId}"><pre><code class="language-html" data-typing-code="true">${fixedCode}</code></pre></div>
            </div>
          `;
        });
        // T√°ch t·ª´ng ph·∫ßn t·ª≠ con c·∫•p 1 ƒë·ªÉ typing t·ª´ng ƒëo·∫°n, nh∆∞ng gi·ªØ nguy√™n header code
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = parsedContent;
        // Typing t·ª´ng ƒëo·∫°n, nh∆∞ng n·∫øu l√† .modern-code-table th√¨ ch·ªâ typing ph·∫ßn code
        let children = Array.from(tempDiv.childNodes);
        function typeNextChild(idx) {
          if (idx >= children.length) {
            // G·ª≠i event typingDone
            const event = new Event('typingDone');
            contentDiv.dispatchEvent(event);
            return;
          }
          let child = children[idx];
          if (child.nodeType === 1 && child.classList.contains('modern-code-table')) {
            // Render header ngay
            contentDiv.appendChild(child);
            // Typing ph·∫ßn code b√™n trong
            const codeEl = child.querySelector('code[data-typing-code="true"]');
            if (codeEl) {
              let codeText = codeEl.textContent;
              codeEl.textContent = '';
              typeWriterEffect(codeEl, codeText, 0, 2, () => typeNextChild(idx + 1));
            } else {
              typeNextChild(idx + 1);
            }
          } else {
            // Typing ƒëo·∫°n vƒÉn b·∫£n th∆∞·ªùng
            let html = '';
            if (child.outerHTML) html = child.outerHTML;
            else if (child.textContent) html = child.textContent;
            let temp = document.createElement('div');
            temp.innerHTML = '';
            contentDiv.appendChild(temp);
            typeWriterEffect(temp, html, 0, 2, () => {
              // Sau khi typing xong, thay th·∫ø temp b·∫±ng n·ªôi dung th·∫≠t
              temp.outerHTML = html;
              typeNextChild(idx + 1);
            });
          }
        }
        typeNextChild(0);
      } else {
        contentDiv.innerHTML = marked.parse(content);
      }

      bubble.appendChild(contentDiv);

      if (role === 'assistant') {
        const actionButtons = document.createElement('div');
        actionButtons.className = 'action-buttons';
        actionButtons.style.display = 'none';
        actionButtons.innerHTML = `
          <button class="action-btn" onclick="copyMessage(this, '${escapeHtml(content)}')">
            <i class="far fa-copy"></i>
            <span>Sao ch√©p</span>
          </button>
          <button class="action-btn" onclick="shareMessage('${escapeHtml(content)}')">
            <i class="fas fa-share"></i>
            <span>Chia s·∫ª</span>
          </button>
        `;
        bubble.appendChild(actionButtons);
        contentDiv.addEventListener('typingDone', () => {
          actionButtons.style.display = '';
        });
      }

      messageDiv.appendChild(bubble);

      setTimeout(() => {
        document.querySelectorAll('pre').forEach(pre => {
          if (!pre.previousElementSibling || !pre.previousElementSibling.classList.contains('code-header')) {
            const lang = pre.querySelector('code')?.className?.replace('language-', '') || 'code';
            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `
              <span>${lang}</span>
              <button class="copy-btn" onclick="copyCode(this)">
                <i class="far fa-copy"></i>
                <span>Copy</span>
              </button>
            `;
            pre.parentNode.insertBefore(header, pre);
          }
        });
        if (window.MathJax) {
          MathJax.typesetPromise();
        }
        document.querySelectorAll('.modern-code-body code').forEach(block => {
          hljs.highlightElement(block);
        });
      }, 50);

      return messageDiv;
    }

    // Typing effect cho AI tr·∫£ l·ªùi (h·ªó tr·ª£ callback khi xong)
    function typeWriterEffect(element, html, i, speed, cb) {
      let isTag = false, text = '', tagBuffer = '';
      function type() {
        if (stopTyping) {
          element.innerHTML = html;
          if (element.tagName === 'CODE') {
            hljs.highlightElement(element);
          } else {
            element.querySelectorAll && element.querySelectorAll('code').forEach(block => {
              hljs.highlightElement(block);
            });
          }
          if (window.MathJax) MathJax.typesetPromise();
          if (cb) cb();
          else {
            const event = new Event('typingDone');
            element.dispatchEvent(event);
          }
          return;
        }
        if (i < html.length) {
          let char = html[i];
          if (char === '<') {
            isTag = true;
            tagBuffer = '<';
          } else if (isTag) {
            tagBuffer += char;
            if (char === '>') {
              text += tagBuffer;
              isTag = false;
              tagBuffer = '';
            }
          } else {
            text += char;
          }
          element.innerHTML = text + (isTag ? tagBuffer : '');
         // N·∫øu l√† code block trong khung chat, auto-scroll xu·ªëng cu·ªëi khi typing
         if (element.tagName === 'CODE' && element.closest('.modern-code-body')) {
           const codeBody = element.closest('.modern-code-body');
           codeBody.scrollTop = codeBody.scrollHeight;
         }
          i++;
          setTimeout(type, isTag ? 0 : speed);
        } else {
          element.innerHTML = html;
          setTimeout(() => {
            if (element.tagName === 'CODE') {
              hljs.highlightElement(element);
            } else {
              element.querySelectorAll && element.querySelectorAll('code').forEach(block => {
                hljs.highlightElement(block);
              });
            }
            if (window.MathJax) MathJax.typesetPromise();
            if (cb) cb();
            else {
              const event = new Event('typingDone');
              element.dispatchEvent(event);
            }
          }, 30);
        }
      }
      type();
    }

    // M√£ h√≥a HTML ƒë·ªÉ ch√®n an to√†n
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    // S·ª≠a h√†m sendMessage ƒë·ªÉ t√≠ch h·ª£p t·∫°o ·∫£nh
    async function sendMessage(event) {
      event.preventDefault();
      if (isAITyping) return; // Kh√¥ng g·ª≠i khi AI ƒëang tr·∫£ l·ªùi
      const inputElement = document.getElementById('chat-input');
      let message = inputElement.innerText.trim();
      if (!message) return;

      // N·∫øu l√† code, t·ª± ƒë·ªông b·ªçc code block
      if (isLikelyCode(message)) {
        // Th·ª≠ ƒëo√°n ng√¥n ng·ªØ
        let lang = '';
        if (/^\s*<html[\s>]/i.test(message)) lang = 'html';
        else if (/^\s*def\s+\w+\s*\(/.test(message)) lang = 'python';
        else if (/^\s*function\s+\w+\s*\(/.test(message)) lang = 'javascript';
        message = `\n\n\${lang}\n${message}\n\`;
      }

      // ·∫®n l·ªùi ch√†o n·∫øu ƒë√¢y l√† tin nh·∫Øn ƒë·∫ßu ti√™n
      if (!hasMessages) {
        document.getElementById('welcome-message').classList.add('hidden');
        hasMessages = true;
      }

      // Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng v√†o khung chat
      addMessage('user', message);
      inputElement.innerText = '';
      isAITyping = true;
      updateSendButton();
      stopTyping = false;

      // N·∫øu l√† y√™u c·∫ßu t·∫°o ·∫£nh
      if (isImageRequest(message)) {
        // Hi·ªÉn th·ªã spinner t·∫°o ·∫£nh
        const typingIndicator = showTypingIndicator('image');
        try {
          const imageData = await callGeminiImageAPI(message);
          removeTypingIndicator(typingIndicator);
          addImageMessage(imageData, message);
          isAITyping = false;
          updateSendButton();
          // C√≥ th·ªÉ l∆∞u l·ªãch s·ª≠ n·∫øu mu·ªën
        } catch (err) {
          removeTypingIndicator(typingIndicator);
          addMessage('assistant', 'Xin l·ªói, ƒë√£ c√≥ l·ªói khi t·∫°o ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
          isAITyping = false;
          updateSendButton();
        }
        return;
      }

      // === N·∫øu c√≥ file ƒë√£ t·∫£i l√™n, g·ª≠i n·ªôi dung file k√®m c√¢u h·ªèi ===
      let userPrompt = message;
      if (uploadedFileContent && uploadedFileName) {
        userPrompt = `Ph√¢n t√≠ch file sau ƒë√¢y (t√™n file: ${uploadedFileName}):\n\n-----\n${uploadedFileContent}\n-----\n\nSau ƒë√≥ tr·∫£ l·ªùi c√¢u h·ªèi: ${message}`;
      }

      // Chu·∫©n b·ªã l·ªãch s·ª≠ h·ªôi tho·∫°i g·ª≠i l√™n API
      const conversation = [
        {
          role: 'user',
          parts: [{ text: SYSTEM_PROMPT }]
        },
        {
          role: 'model',
          parts: [{ text: 'Xin ch√†o! T√¥i l√† **Nexa Space**, tr·ª£ l√Ω ·∫£o ƒë∆∞·ª£c s√°ng l·∫≠p b·ªüi **Khoa Dev 2007**. T√¥i s·∫Ω c·ªë g·∫Øng h·∫øt s·ª©c ƒë·ªÉ gi√∫p ƒë·ª° b·∫°n!' }]
        },
        ...chatHistory.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'model',
          parts: [{ text: msg.content }]
        }))
      ];
      conversation.push({
        role: 'user',
        parts: [{ text: userPrompt }]
      });
      const typingIndicator = showTypingIndicator();
      try {
        const response = await fetch(`${API_URL}?key=${API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: conversation,
            generationConfig: {
              temperature: 0.9,
              topK: 1,
              topP: 1,
              maxOutputTokens: 8192,
              stopSequences: []
            },
            safetySettings: [
              {
                category: "HARM_CATEGORY_HARASSMENT",
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
              },
              {
                category: "HARM_CATEGORY_HATE_SPEECH",
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
              },
              {
                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
              },
              {
                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
              }
            ]
          })
        });
        const data = await response.json();
        removeTypingIndicator(typingIndicator);
        if (data.candidates && data.candidates[0].content.parts[0].text) {
          const aiResponse = data.candidates[0].content.parts[0].text;
          if (!stopTyping) {
            addMessage('assistant', aiResponse);
            chatHistory.push(
              { role: 'user', content: message },
              { role: 'assistant', content: aiResponse }
            );
            localStorage.setItem('khoaAI_chatHistory', JSON.stringify(chatHistory));
            scrollToBottom();
          }
        } else {
          throw new Error('Invalid response from API');
        }
        isAITyping = false;
        updateSendButton();
      } catch (error) {
        console.error('Error:', error);
        removeTypingIndicator(typingIndicator);
        addMessage('assistant', 'Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω y√™u c·∫ßu c·ªßa b·∫°n. Vui l√≤ng th·ª≠ l·∫°i sau.');
        isAITyping = false;
        updateSendButton();
      }
    }
    
    // Th√™m tin nh·∫Øn v√†o giao di·ªán chat v√† cu·ªôn m∆∞·ª£t
    function addMessage(role, content) {
      const chatContainer = document.getElementById('chat-container');
      const messageElement = createMessageElement(role, content);
      chatContainer.appendChild(messageElement);
      
      // Cu·ªôn xu·ªëng cu·ªëi sau m·ªôt kho·∫£ng ng·∫Øn ƒë·ªÉ DOM c·∫≠p nh·∫≠t
      setTimeout(() => {
        scrollToBottom();
      }, 50);
    }
    
    // Hi·ªÉn th·ªã hi·ªáu ·ª©ng AI ƒëang tr·∫£ l·ªùi v·ªõi ho·∫°t ·∫£nh ƒë·∫πp
    function showTypingIndicator(type = 'text') {
      const chatContainer = document.getElementById('chat-container');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'flex justify-start';
      const bubble = document.createElement('div');
      bubble.className = 'max-w-[85%] bg-gray-100 rounded-2xl px-4 py-3 typing-indicator';
      if (type === 'image') {
        bubble.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="fa fa-spinner fa-spin"></span>
            <span>Khoa AI ƒëang t·∫°o ·∫£nh...</span>
          </div>
        `;
      } else {
        bubble.innerHTML = `
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        `;
      }
      typingDiv.appendChild(bubble);
      chatContainer.appendChild(typingDiv);
      scrollToBottom();
      return typingDiv;
    }
    
        // X√≥a hi·ªáu ·ª©ng AI ƒëang tr·∫£ l·ªùi
    function removeTypingIndicator(typingElement) {
      if (typingElement && typingElement.parentNode) {
        typingElement.parentNode.removeChild(typingElement);
      }
    }
    
    // H√†m hi·ªÉn th·ªã ·∫£nh trong chat
    function addImageMessage(imageData, prompt) {
      // Th√™m logo "Khoa AI" v√†o ·∫£nh (gi·ªëng hie-tao-anh.html)
      addLogoToImage(imageData, 'Khoa AI').then(finalImage => {
        const chatContainer = document.getElementById('chat-container');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-start';
        const bubble = document.createElement('div');
        bubble.className = 'max-w-[85%] rounded-2xl px-4 py-3 bg-gray-100 text-gray-800';
        // T·∫°o id duy nh·∫•t cho popup
        const imgId = 'img-' + Math.random().toString(36).slice(2);
        bubble.innerHTML = `
          <div style="text-align:center">
            <img id="${imgId}" src="data:image/png;base64,${finalImage}" alt="AI Image" style="max-width:320px;max-height:320px;border-radius:12px;box-shadow:0 2px 12px #0002;margin-bottom:8px;cursor:pointer;">
            <div style="font-size:0.95em;color:#666;margin-bottom:8px;">${prompt}</div>
            <div style="display:flex;justify-content:center;gap:16px;margin-bottom:4px;">
              <button class="img-action-btn" title="T·∫£i xu·ªëng" style="background:none;border:none;cursor:pointer;outline:none;">
                <span class="material-icons" style="font-size:22px;color:#2563eb;">download</span>
              </button>
              <button class="img-action-btn" title="Chia s·∫ª" style="background:none;border:none;cursor:pointer;outline:none;">
                <span class="material-icons" style="font-size:22px;color:#43a047;">share</span>
              </button>
            </div>
          </div>
        `;
        messageDiv.appendChild(bubble);
        chatContainer.appendChild(messageDiv);
        setTimeout(scrollToBottom, 50);

        // X·ª≠ l√Ω popup ph√≥ng to ·∫£nh
        let popup = document.getElementById('image-popup-overlay');
        if (!popup) {
          popup = document.createElement('div');
          popup.id = 'image-popup-overlay';
          popup.style = 'display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:9999;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;';
          popup.innerHTML = '<img id="popup-img" style="max-width:90vw;max-height:90vh;border-radius:16px;box-shadow:0 0 24px #fff5;">';
          popup.onclick = () => { popup.style.display = 'none'; };
          document.body.appendChild(popup);
        }
        document.getElementById(imgId).onclick = function() {
          document.getElementById('popup-img').src = this.src;
          popup.style.display = 'flex';
        };
        // N√∫t t·∫£i xu·ªëng
        bubble.querySelectorAll('.img-action-btn')[0].onclick = function() {
          const link = document.createElement('a');
          link.href = `data:image/png;base64,${finalImage}`;
          link.download = 'hie-ai-image.png';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        };
        // N√∫t chia s·∫ª
        bubble.querySelectorAll('.img-action-btn')[1].onclick = async function() {
          try {
            const blob = await fetch(`data:image/png;base64,${finalImage}`).then(res => res.blob());
            const file = new File([blob], 'hie-ai-image.png', { type: 'image/png' });
            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({
                title: '·∫¢nh t·∫°o b·ªüi Khoa AI',
                text: prompt,
                files: [file]
              });
            } else {
              // Fallback: m·ªü ·∫£nh ·ªü tab m·ªõi
              const link = document.createElement('a');
              link.href = `data:image/png;base64,${finalImage}`;
              link.target = '_blank';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }
          } catch (err) {
            alert('Kh√¥ng th·ªÉ chia s·∫ª ·∫£nh tr√™n tr√¨nh duy·ªát n√†y.');
          }
        };
      });
    }

    // H√†m ch√®n logo "Khoa AI" v√†o ·∫£nh base64
    function addLogoToImage(base64Image, logoText = "Khoa AI") {
      return new Promise((resolve) => {
        const img = new window.Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          // Logo nh·ªè ·ªü g√≥c ph·∫£i d∆∞·ªõi
          const fontSize = Math.floor(canvas.width * 0.045);
          ctx.font = `bold ${fontSize}px 'Inter', Arial, sans-serif`;
          ctx.textBaseline = 'bottom';
          ctx.textAlign = 'right';
          const padding = 16;
          const textWidth = ctx.measureText(logoText).width;
          const boxHeight = fontSize + 10;
          const boxWidth = textWidth + 20;
          const x = canvas.width - boxWidth - padding;
          const y = canvas.height - boxHeight - padding;
          ctx.fillStyle = 'rgba(0,0,0,0.45)';
          ctx.fillRect(x, y, boxWidth, boxHeight);
          ctx.fillStyle = 'rgba(255,255,255,0.95)';
          ctx.shadowColor = 'rgba(0,0,0,0.5)';
          ctx.shadowBlur = 3;
          ctx.fillText(logoText, x + boxWidth - 10, y + boxHeight - 8);
          const finalImage = canvas.toDataURL('image/png').replace(/^data:image\/png;base64,/, '');
          resolve(finalImage);
        };
        img.src = `data:image/png;base64,${base64Image}`;
      });
    }
    
    // Cu·ªôn xu·ªëng cu·ªëi m∆∞·ª£t m√† h∆°n
    function scrollToBottom() {
      const chatContainer = document.getElementById('chat-container');
      const scrollHeight = chatContainer.scrollHeight;
      const clientHeight = chatContainer.clientHeight;
      // Cu·ªôn m∆∞·ª£t xu·ªëng cu·ªëi khung chat
      chatContainer.scrollTo({
        top: scrollHeight - clientHeight,
        behavior: 'smooth'
      });
      // ·∫®n n√∫t cu·ªôn sau khi ƒë√£ cu·ªôn xong
      setTimeout(() => {
        hideScrollButton();
      }, 500);
    }
    // Khi b·∫•m n√∫t cu·ªôn xu·ªëng cu·ªëi
    document.getElementById('scroll-to-bottom').onclick = scrollToBottom;
    // Ki·ªÉm tra v·ªã tr√≠ cu·ªôn v√† hi·ªÉn th·ªã/·∫©n n√∫t cu·ªôn xu·ªëng cu·ªëi
    function checkScrollPosition() {
      const chatContainer = document.getElementById('chat-container');
      const scrollTop = chatContainer.scrollTop;
      const scrollHeight = chatContainer.scrollHeight;
      const clientHeight = chatContainer.clientHeight;
      if (scrollHeight - (scrollTop + clientHeight) > 100) {
        showScrollButton();
      } else {
        hideScrollButton();
      }
    }
    // Thi·∫øt l·∫≠p l·∫Øng nghe s·ª± ki·ªán cu·ªôn
    function setupScrollListener() {
      const chatContainer = document.getElementById('chat-container');
      chatContainer.addEventListener('scroll', function() {
        checkScrollPosition();
      });
      // Ki·ªÉm tra l·∫°i khi thay ƒë·ªïi k√≠ch th∆∞·ªõc c·ª≠a s·ªï
      window.addEventListener('resize', checkScrollPosition);
    }
    // Hi·ªán n√∫t cu·ªôn xu·ªëng cu·ªëi v·ªõi hi·ªáu ·ª©ng
    function showScrollButton() {
      const scrollButton = document.getElementById('scroll-to-bottom');
      scrollButton.classList.remove('hidden');
      scrollButton.classList.add('visible');
    }
    // ·∫®n n√∫t cu·ªôn xu·ªëng cu·ªëi v·ªõi hi·ªáu ·ª©ng
    function hideScrollButton() {
      const scrollButton = document.getElementById('scroll-to-bottom');
      scrollButton.classList.remove('visible');
      scrollButton.classList.add('hidden');
    }
    
    // Sao ch√©p m√£ code v√†o clipboard
    function copyCode(button) {
      const codeBlock = button.closest('.code-header').nextElementSibling;
      const code = codeBlock.querySelector('code').innerText;
      
      navigator.clipboard.writeText(code).then(() => {
        const originalText = button.querySelector('span');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-check"></i><span>Copied!</span>';
        
        setTimeout(() => {
          button.innerHTML = originalHtml;
        }, 2000);
      });
    }
    
    // Sao ch√©p n·ªôi dung tin nh·∫Øn v√†o clipboard
    function copyMessage(button, text) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.querySelector('span');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-check"></i><span>ƒê√£ sao ch√©p</span>';
        
        setTimeout(() => {
          button.innerHTML = originalHtml;
        }, 2000);
      });
    }
    
    // Chia s·∫ª n·ªôi dung tin nh·∫Øn
    function shareMessage(text) {
      if (navigator.share) {
        navigator.share({
          title: 'Khoa AI Chat',
          text: text,
          url: window.location.href
        }).catch(err => {
          console.log('Error sharing:', err);
        });
      } else {
        // Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Share API th√¨ ch·ªâ sao ch√©p v√†o clipboard
        navigator.clipboard.writeText(text).then(() => {
          alert('ƒê√£ sao ch√©p n·ªôi dung v√†o clipboard. B·∫°n c√≥ th·ªÉ chia s·∫ª n√≥ b√¢y gi·ªù.');
        });
      }
    }
    

    // Voice-to-text (SpeechRecognition) cho n√∫t mic c·∫°nh n√∫t g·ª≠i
    let isListening = false;
    let recognition = null;
    let finalTranscript = '';
    function toggleVoiceInput() {
      const btn = document.getElementById('voice-button');
      const icon = btn.querySelector('.voice-icon');
      const inputElement = document.getElementById('chat-input');
      if (isListening) {
        if (recognition) recognition.stop();
        icon.textContent = 'mic';
        icon.classList.remove('voice-anim');
        isListening = false;
        return;
      }
      if (!('webkitSpeechRecognition' in window)) {
        alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i.');
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'vi-VN';
      recognition.interimResults = true;
      recognition.continuous = true; // Cho ph√©p nh·∫≠n di·ªán li√™n t·ª•c
      finalTranscript = '';
      inputElement.innerText = '';
      recognition.onstart = () => {
        icon.textContent = 'stop';
        icon.classList.add('voice-anim');
        isListening = true;
      };
      recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        // Hi·ªÉn th·ªã k·∫øt qu·∫£ t·∫°m th·ªùi + k·∫øt qu·∫£ cu·ªëi c√πng
        inputElement.innerText = finalTranscript + interimTranscript;
        // ƒê·∫∑t con tr·ªè v·ªÅ cu·ªëi
        placeCaretAtEnd(inputElement);
      };
      recognition.onerror = (event) => {
        icon.textContent = 'mic';
        icon.classList.remove('voice-anim');
        isListening = false;
        // Kh√¥ng x√≥a n·ªôi dung nh·∫≠p li·ªáu khi l·ªói
      };
      recognition.onend = () => {
        icon.textContent = 'mic';
        icon.classList.remove('voice-anim');
        isListening = false;
        // Gi·ªØ l·∫°i n·ªôi dung ƒë√£ nh·∫≠n di·ªán
      };
      recognition.start();
    }
    // H√†m ƒë·∫∑t con tr·ªè v·ªÅ cu·ªëi contenteditable
    function placeCaretAtEnd(el) {
      el.focus();
      if (typeof window.getSelection != "undefined"
          && typeof document.createRange != "undefined") {
        var range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
    // Lo·∫°i b·ªè HTML ƒë·ªÉ ƒë·ªçc s·∫°ch
    function stripHtml(html) {
      var tmp = document.createElement('div');
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || '';
    }
    
    // T·∫°o cu·ªôc tr√≤ chuy·ªán m·ªõi
    function newChat() {
      if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi? L·ªãch s·ª≠ hi·ªán t·∫°i s·∫Ω b·ªã x√≥a.')) {
        chatHistory = [];
        localStorage.removeItem('khoaAI_chatHistory');
        location.reload(); // T·∫£i l·∫°i trang nh∆∞ F5
        
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML = '';
        
        document.getElementById('welcome-message').classList.remove('hidden');
        document.getElementById('chat-input').innerText = '';
        hasMessages = false;
      }
    }
    
    // T·ª± ƒë·ªông thay ƒë·ªïi chi·ªÅu cao √¥ nh·∫≠p li·ªáu
    document.getElementById('chat-input').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    
    // X·ª≠ l√Ω ph√≠m Enter (g·ª≠i) v√† Shift+Enter (xu·ªëng d√≤ng)
    document.getElementById('chat-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
      }
    });

    // H√†m copy cho b·∫£ng code hi·ªán ƒë·∫°i
    function copyModernCode(codeId) {
      const codeBlock = document.getElementById(codeId).querySelector('code');
      const code = codeBlock.innerText;
      navigator.clipboard.writeText(code).then(() => {
        // Hi·ªáu ·ª©ng copied
        const btn = document.activeElement;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-check'></i>";
        setTimeout(() => {
          btn.innerHTML = originalHtml;
        }, 1500);
      });
    }
    // H√†m ph√≥ng to code full m√†n h√¨nh
    function expandCodeFullScreen(codeId, lang) {
      const codeBlock = document.getElementById(codeId).querySelector('code');
      const code = codeBlock.innerText;
      // T·∫°o overlay
      let overlay = document.createElement('div');
      overlay.className = 'fullscreen-code-overlay';
      overlay.innerHTML = `
        <div class="fullscreen-code-table">
          <div class="fullscreen-code-header">
            <span class="fullscreen-code-lang">${lang}</span>
            <div class="fullscreen-code-actions">
              <button class="fullscreen-code-copy" onclick="copyFullScreenCode(this)"><i class='far fa-copy'></i></button>
              <button class="fullscreen-code-close" onclick="closeFullScreenCode(this)"><i class='fas fa-compress'></i></button>
            </div>
          </div>
          <div class="fullscreen-code-body"><pre><code class="language-${lang}">${escapeHtml(code)}</code></pre></div>
        </div>
      `;
      document.body.appendChild(overlay);
      // Highlight code
      setTimeout(() => {
        overlay.querySelectorAll('code').forEach(block => {
          hljs.highlightElement(block);
        });
      }, 10);
    }
    function closeFullScreenCode(btn) {
      const overlay = btn.closest('.fullscreen-code-overlay');
      if (overlay) overlay.remove();
    }
    function copyFullScreenCode(btn) {
      const code = btn.closest('.fullscreen-code-table').querySelector('code').innerText;
      navigator.clipboard.writeText(code).then(() => {
        const originalHtml = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-check'></i>";
        setTimeout(() => {
          btn.innerHTML = originalHtml;
        }, 1500);
      });
    }

    // === File upload & ph√¢n t√≠ch ===
    let uploadedFileContent = null;
    let uploadedFileName = null;
    let fileLoadingIndicator = null;

    // Hi·ªÉn th·ªã animation loading khi ƒëang ƒë·ªçc file
    function showFileLoadingAnimation(filename) {
      // N·∫øu ƒë√£ c√≥ indicator th√¨ x√≥a
      removeFileLoadingAnimation();
      const chatContainer = document.getElementById('chat-container');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'flex justify-start';
      loadingDiv.id = 'file-loading-indicator';
      loadingDiv.innerHTML = `
        <div class="max-w-[85%] bg-gray-100 rounded-2xl px-4 py-3 typing-indicator" style="display:flex;align-items:center;gap:10px;">
          <span class="fa fa-spinner fa-spin"></span>
          <span>ƒêang ƒë·ªçc file <b>${filename}</b>...</span>
        </div>
      `;
      chatContainer.appendChild(loadingDiv);
      scrollToBottom();
      fileLoadingIndicator = loadingDiv;
    }
    function removeFileLoadingAnimation() {
      const el = document.getElementById('file-loading-indicator');
      if (el && el.parentNode) el.parentNode.removeChild(el);
      fileLoadingIndicator = null;
    }

    // X·ª≠ l√Ω n√∫t t·∫£i file
    document.getElementById('upload-file-btn').onclick = function() {
      document.getElementById('file-input').click();
    };
    document.getElementById('file-input').onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) {
        addMessage('user', `‚ùå <b>${file.name}</b> ‚Äî <span style='color:#ef4444;'>Ch·ªâ h·ªó tr·ª£ file d∆∞·ªõi 5MB.</span>`);
        return;
      }
      uploadedFileName = file.name;
      const textTypes = [
        'text/plain', 'text/csv', 'application/json', 'text/markdown', 'text/xml', 'text/html',
        'application/javascript', 'application/x-javascript', 'text/x-python', 'text/x-java-source',
        'text/x-c', 'text/x-c++', 'text/x-csharp', 'application/xml', 'application/x-www-form-urlencoded'
      ];
      const ext = file.name.split('.').pop().toLowerCase();
      const textExts = ['txt','csv','md','log','json','xml','html','js','ts','py','java','c','cpp','cs'];
      if (textTypes.includes(file.type) || textExts.includes(ext)) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          uploadedFileContent = evt.target.result;
          // Hi·ªÉn th·ªã n·ªôi dung file d∆∞·ªõi d·∫°ng code block
          const lang = detectCodeLang(uploadedFileName, uploadedFileContent);
          addMessage('user', `‚úÖ <b>${uploadedFileName}</b> ‚Äî <span style='color:#22c55e;'>ƒê√£ t·∫£i l√™n th√†nh c√¥ng!</span>\n\n\${lang}\n${uploadedFileContent}\n\`);
        };
        reader.onerror = function() {
          addMessage('user', `‚ùå <b>${uploadedFileName}</b> ‚Äî <span style='color:#ef4444;'>L·ªói khi ƒë·ªçc file.</span>`);
        };
        reader.readAsText(file);
      } else {
        addMessage('user', `‚ùå <b>${uploadedFileName}</b> ‚Äî <span style='color:#ef4444;'>Ch·ªâ h·ªó tr·ª£ file text, csv, md, log, json, xml, html, js, ts, py, java, c, cpp, cs.</span>`);
      }
    };
    // Kh√¥ng c√≤n h√†m showUploadedFileInfo v√† removeUploadedFile n·ªØa

    let isAITyping = false;
    let stopTyping = false;

    function updateSendButton() {
  const sendBtn = document.getElementById('send-button');
  const sendIcon = document.getElementById('send-icon');
  if (isAITyping) {
    sendIcon.innerHTML = '<span class="material-icons">stop</span>'; // S·ª≠ d·ª•ng material-icons thay v√¨ material-symbols-outlined
    sendBtn.title = 'D·ª´ng tr·∫£ l·ªùi';
    sendBtn.style.color = '#ef4444'; // M√†u ƒë·ªè ƒë·ªÉ d·ªÖ nh·∫≠n bi·∫øt
  } else {
    sendIcon.innerHTML = '<span class="material-symbols-outlined">send</span>';
    sendBtn.title = 'G·ª≠i';
    sendBtn.style.color = '';
  }
}
    // Khi b·∫•m n√∫t g·ª≠i/d·ª´ng
    document.getElementById('send-button').onclick = function(e) {
      if (isAITyping) {
        // ƒêang tr·∫£ l·ªùi, b·∫•m ƒë·ªÉ d·ª´ng
        stopTyping = true;
        isAITyping = false;
        updateSendButton();
        // X√≥a typing indicator n·∫øu c√≤n
        const typingEls = document.querySelectorAll('.typing-indicator');
        typingEls.forEach(el => el.parentNode && el.parentNode.removeChild(el));
        // Cho ph√©p nh·∫≠p v√† g·ª≠i l·∫°i
        document.getElementById('chat-input').focus();
        e.preventDefault();
        return false;
      }
      // N·∫øu kh√¥ng ph·∫£i ƒëang tr·∫£ l·ªùi, ƒë·ªÉ form submit b√¨nh th∆∞·ªùng
    };

    // H√†m nh·∫≠n di·ªán ng√¥n ng·ªØ code t·ª´ t√™n file
    function detectCodeLang(filename, content) {
      if (!filename) return '';
      const ext = filename.split('.').pop().toLowerCase();
      const map = {
        js: 'javascript', ts: 'typescript', py: 'python', java: 'java', c: 'c', cpp: 'cpp', cs: 'csharp',
        html: 'html', css: 'css', json: 'json', md: 'markdown', xml: 'xml', log: 'log', csv: 'csv'
      };
      if (map[ext]) return map[ext];
      // N·∫øu kh√¥ng c√≥ ext, th·ª≠ ƒëo√°n theo n·ªôi dung
      if (/^\s*<html[\s>]/i.test(content)) return 'html';
      if (/^\s*def\s+\w+\s*\(/.test(content)) return 'python';
      if (/^\s*function\s+\w+\s*\(/.test(content)) return 'javascript';
      return '';
    }
    // H√†m ki·ªÉm tra n·ªôi dung c√≥ ph·∫£i code kh√¥ng
    function isLikelyCode(text) {
      // C√≥ nhi·ªÅu d√≤ng indent, ho·∫∑c b·∫Øt ƒë·∫ßu b·∫±ng <html>, function, def, class, import, #include, etc.
      return /<html[\s>]|function\s|def\s|class\s|#include|import\s|public\s|private\s|const\s|let\s|var\s|=>|\{\s*\n|\n\s{2,}/.test(text);
    }
  </script>
</body>
</html>
