<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Hie AI Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=send" />
  <!-- MathJax for math rendering -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap');
    html, body {
      transition: background 0.35s, color 0.35s;
    }
    body {
      font-family: 'Google Sans', Arial, sans-serif;
      --scrollbar-thumb: #d1d5db;
      --scrollbar-track: #f3f4f6;
      background: #fff;
      color: #23272f;
    }
    .dark body {
      background: #181a20;
      color: #e5e7eb;
      --scrollbar-thumb: #4b5563;
      --scrollbar-track: #23272f;
    }
    .theme-toggle-btn {
      transition: background 0.3s, color 0.3s, box-shadow 0.3s, transform 0.25s;
    }
    .theme-toggle-btn:active {
      transform: scale(0.92);
    }
    .theme-toggle-btn .material-icons {
      font-size: 1.7em;
      transition: color 0.3s, transform 0.3s;
    }
    .dark .theme-toggle-btn {
      background: #23272f;
      color: #ffe066;
      border-color: #374151;
    }
    .dark .theme-toggle-btn .material-icons {
      color: #ffe066;
      transform: rotate(-20deg) scale(1.1);
    }
    
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 24
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-track {
      background-color: var(--scrollbar-track);
    }
    
    /* Refined Markdown Styles */
    .markdown {
      line-height: 1.7;
      overflow-wrap: break-word;
      color: #23272f; /* Darker text for better contrast */
      font-size: 1.05em;
    }
    .markdown h1 {
      font-size: 2em;
      font-weight: 700;
      margin: 1.5em 0 0.8em 0; /* Increased margin */
      border-bottom: 2px solid #cbd5e1;
      padding-bottom: 0.4em; /* Increased padding */
      color: #1d4ed8;
      letter-spacing: -0.5px; /* Adjusted letter spacing */
    }
    .markdown h2 {
      font-size: 1.5em;
      font-weight: 600;
      margin: 1.3em 0 0.6em 0; /* Increased margin */
      border-bottom: 1.5px solid #e0e7ef;
      padding-bottom: 0.3em; /* Increased padding */
      color: #2563eb;
    }
    .markdown h3 {
      font-size: 1.2em;
      font-weight: 600;
      margin: 1.1em 0 0.5em 0; /* Increased margin */
      color: #374151;
    }
    .markdown h4 {
      font-size: 1em;
      font-weight: 600;
      margin: 0.9em 0 0.4em 0; /* Increased margin */
      color: #475569;
    }
    .markdown p {
      margin: 0.35em 0 0.35em 0; /* Giảm khoảng cách giữa các đoạn */
      color: #23272f;
    }
    .markdown ul, .markdown ol {
      margin: 0.5em 0 0.5em 1em;
      padding-left: 1em;
    }
    .markdown ul {
      list-style-type: disc;
    }
    .markdown ol {
      list-style-type: decimal;
    }
    .markdown li {
      margin: 0.3em 0;
      padding-left: 0.1em;
    }
    .markdown blockquote {
      border-left: 5px solid #60a5fa;
      background: #f1f5f9;
      padding: 0.7em 1em;
      color: #334155;
      margin: 1em 0;
      font-style: italic;
      box-shadow: 0 2px 8px 0 rgba(96,165,250,0.07);
      border-radius: 0 8px 8px 0;
      transition: box-shadow 0.2s;
    }
    .markdown blockquote:hover {
      box-shadow: 0 4px 16px 0 rgba(96,165,250,0.13);
    }
    .markdown pre, .modern-code-body pre, .fullscreen-code-body pre {
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 1.2em 1em 1em 1em;
      overflow-x: auto;
      margin: 1.5em 0;
      box-shadow: 0 2px 12px 0 rgba(0,0,0,0.2);
      border: 1px solid #333;
      white-space: pre !important;
      word-break: keep-all !important;
      word-wrap: normal !important;
      /* Đảm bảo không wrap code, không mất ký tự */
      max-width: 100%;
    }
    .markdown code, .modern-code-body code, .fullscreen-code-body code {
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      background-color: #e5e7eb;
      padding: 0.2em 0.5em;
      border-radius: 4px;
      font-size: 0.95em;
      color: #be185d;
      white-space: pre !important;
      word-break: keep-all !important;
      word-wrap: normal !important;
      overflow-x: auto;
      display: block;
      max-width: 100%;
    }
    @media (max-width: 640px) {
      .markdown pre, .modern-code-body pre, .fullscreen-code-body pre {
        font-size: 0.9em;
        padding: 0.6em 0.2em;
        overflow-x: auto;
        max-width: 100vw;
      }
      .markdown code, .modern-code-body code, .fullscreen-code-body code {
        font-size: 0.9em;
        padding: 0.1em 0.2em;
        overflow-x: auto;
        max-width: 100vw;
      }
    }
    /* Enhanced Markdown Table Styles - Modern & Professional */
    .markdown table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin: 2em 0;
      max-width: 100%;
      display: block;
      overflow-x: auto;
      white-space: nowrap;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      box-shadow: 
        0 4px 20px rgba(30,41,59,0.08),
        0 1px 3px rgba(0,0,0,0.05),
        inset 0 1px 0 rgba(255,255,255,0.8);
      border-radius: 12px;
      border: 1px solid rgba(226,232,240,0.8);
      position: relative;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .markdown table:hover {
      box-shadow: 
        0 8px 32px rgba(30,41,59,0.12),
        0 2px 8px rgba(0,0,0,0.08),
        inset 0 1px 0 rgba(255,255,255,0.9);
      transform: translateY(-1px);
    }
    
    .markdown table::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
      border-radius: 12px 12px 0 0;
      opacity: 0.8;
    }
    
    .markdown table th, .markdown table td {
      border: none;
      border-bottom: 1px solid rgba(226,232,240,0.6);
      border-right: 1px solid rgba(226,232,240,0.4);
      padding: 1.2em 1.8em;
      text-align: left;
      vertical-align: middle;
      position: relative;
      transition: all 0.2s ease;
    }
    
    .markdown table th {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      font-weight: 700;
      font-size: 0.95em;
      color: #1e293b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #cbd5e1;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .markdown table th:first-child {
      border-top-left-radius: 12px;
    }
    
    .markdown table th:last-child {
      border-top-right-radius: 12px;
      border-right: none;
    }
    
    .markdown table td {
      background: rgba(255,255,255,0.7);
      color: #374151;
      font-weight: 400;
      line-height: 1.6;
    }
    
    .markdown table td:last-child {
      border-right: none;
    }
    
    .markdown table tr:last-child td:first-child {
      border-bottom-left-radius: 12px;
    }
    
    .markdown table tr:last-child td:last-child {
      border-bottom-right-radius: 12px;
    }
    
    /* Enhanced zebra striping with subtle gradient */
    .markdown table tr:nth-child(even) td {
      background: linear-gradient(135deg, rgba(248,250,252,0.8) 0%, rgba(241,245,249,0.6) 100%);
    }
    
    /* Improved hover effects */
    .markdown table tr:hover td {
      background: linear-gradient(135deg, rgba(59,130,246,0.05) 0%, rgba(139,92,246,0.03) 100%);
      transform: scale(1.01);
      box-shadow: 0 2px 8px rgba(59,130,246,0.1);
      border-color: rgba(59,130,246,0.2);
    }
    
    .markdown table tr:hover td:first-child {
      border-left: 3px solid #3b82f6;
    }
    
    /* Special styling for important data */
    .markdown table td strong {
      color: #1e40af;
      font-weight: 600;
    }
    
    .markdown table td em {
      color: #7c3aed;
      font-style: normal;
      font-weight: 500;
    }
    
    /* Responsive table improvements */
    @media (max-width: 768px) {
      .markdown table {
        margin: 1.5em -0.5em;
        border-radius: 8px;
        font-size: 0.9em;
      }
      
      .markdown table th, .markdown table td {
        padding: 0.8em 1em;
      }
      
      .markdown table th {
        font-size: 0.85em;
        letter-spacing: 0.3px;
      }
    }
    
    /* Table scroll indicator */
    .markdown table::-webkit-scrollbar {
      height: 8px;
    }
    
    .markdown table::-webkit-scrollbar-track {
      background: rgba(241,245,249,0.5);
      border-radius: 4px;
    }
    
    .markdown table::-webkit-scrollbar-thumb {
      background: linear-gradient(90deg, #cbd5e1, #94a3b8);
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .markdown table::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(90deg, #94a3b8, #64748b);
    }
    
    /* Table Fullscreen Feature */
    .markdown table {
      position: relative;
    }
    
    .table-fullscreen-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 20;
      box-shadow: 0 2px 8px rgba(59,130,246,0.3);
    }
    
    .markdown table:hover .table-fullscreen-btn {
      opacity: 1;
      transform: scale(1);
    }
    
    .table-fullscreen-btn:hover {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(59,130,246,0.4);
    }
    
    .table-fullscreen-btn i {
      font-size: 16px;
      transition: transform 0.2s;
    }
    
    .table-fullscreen-btn:hover i {
      transform: scale(1.1);
    }
    
    /* Fullscreen Table Overlay */
    .table-fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .table-fullscreen-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .table-fullscreen-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 95vw;
      max-height: 95vh;
      overflow: auto;
      position: relative;
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .table-fullscreen-overlay.active .table-fullscreen-container {
      transform: scale(1);
    }
    
    .table-fullscreen-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      border-radius: 16px 16px 0 0;
    }
    
    .table-fullscreen-title {
      font-size: 1.2em;
      font-weight: 600;
      color: #1e293b;
    }
    
    .table-fullscreen-actions {
      display: flex;
      gap: 12px;
    }
    
    .table-fullscreen-btn-close,
    .table-fullscreen-btn-copy {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9em;
    }
    
    .table-fullscreen-btn-close:hover,
    .table-fullscreen-btn-copy:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    .table-fullscreen-btn-close:hover {
      color: #ef4444;
    }
    
    .table-fullscreen-btn-copy:hover {
      color: #3b82f6;
    }
    
    .table-fullscreen-content {
      padding: 24px;
      max-height: calc(95vh - 120px);
      overflow: auto;
    }
    
    .table-fullscreen-content table {
      margin: 0;
      box-shadow: none;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    
    .table-fullscreen-content table th,
    .table-fullscreen-content table td {
      padding: 16px 20px;
      font-size: 1.05em;
    }
    
    /* Dark mode for fullscreen table */
    .dark .table-fullscreen-container {
      background: #1e293b;
      color: #e5e7eb;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    
    .dark .table-fullscreen-header {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      border-bottom: 1px solid #374151;
    }
    
    .dark .table-fullscreen-title {
      color: #e5e7eb;
    }
    
    .dark .table-fullscreen-btn-close,
    .dark .table-fullscreen-btn-copy {
      color: #9ca3af;
    }
    
    .dark .table-fullscreen-btn-close:hover,
    .dark .table-fullscreen-btn-copy:hover {
      background: #374151;
      color: #e5e7eb;
    }
    
    .dark .table-fullscreen-btn-close:hover {
      color: #f87171;
    }
    
    .dark .table-fullscreen-btn-copy:hover {
      color: #60a5fa;
    }
    
    .dark .table-fullscreen-content table {
      border-color: #374151;
    }
    
    .dark .table-fullscreen-content table th {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
      color: #60a5fa !important;
      border-bottom: 2px solid #475569 !important;
    }
    
    .dark .table-fullscreen-content table td {
      background: rgba(30,41,59,0.6) !important;
      color: #e5e7eb !important;
    }
    
    .dark .table-fullscreen-content table tr:nth-child(even) td {
      background: linear-gradient(135deg, rgba(51,65,85,0.6) 0%, rgba(30,41,59,0.4) 100%) !important;
    }
    
    .dark .table-fullscreen-content table tr:hover td {
      background: linear-gradient(135deg, rgba(96,165,250,0.1) 0%, rgba(168,85,247,0.05) 100%) !important;
    }
    
    /* Mobile responsive for fullscreen */
    @media (max-width: 768px) {
      .table-fullscreen-container {
        max-width: 98vw;
        max-height: 98vh;
        margin: 10px;
      }
      
      .table-fullscreen-header {
        padding: 16px 20px;
      }
      
      .table-fullscreen-title {
        font-size: 1.1em;
      }
      
      .table-fullscreen-content {
        padding: 16px;
        max-height: calc(98vh - 100px);
      }
      
      .table-fullscreen-content table th,
      .table-fullscreen-content table td {
        padding: 12px 16px;
        font-size: 1em;
      }
    }
    .markdown hr {
      border: none;
      border-top: 2px solid #d1d5db; /* Thicker border */
      margin: 2em 0; /* Increased margin */
    }
    .markdown strong {
      font-weight: 700;
      color: #be185d;
    }

    /* MathJax & math markdown improvements */
    .markdown .mjx-math {
      font-size: 1.18em;
      color: #0d9488;
      background: #f0fdfa;
      border-radius: 6px; /* Slightly smaller radius */
      padding: 0.18em 0.5em;
      margin: 0 0.1em;
      box-shadow: 0 1px 4px 0 rgba(13,148,136,0.05); /* Lighter shadow */
      transition: box-shadow 0.2s, background 0.2s;
      font-family: 'Fira Sans', 'Segoe UI', 'Arial', sans-serif;
    }
    .markdown .mjx-math:hover {
      box-shadow: 0 2px 8px 0 rgba(13,148,136,0.1); /* Lighter hover shadow */
      background: #e0f2fe;
    }
    /* Block math center and highlight */
    .markdown .mjx-block {
      display: flex !important;
      justify-content: center;
      align-items: center;
      background: #f0fdfa;
      border-radius: 10px;
      margin: 1.5em 0; /* Increased margin */
      padding: 1.2em 0.8em; /* Increased padding */
      box-shadow: 0 2px 12px 0 rgba(13,148,136,0.10);
      border: 1px solid #99f6e4;
      overflow-x: auto;
    }
    .markdown .mjx-block:hover {
      box-shadow: 0 6px 24px 0 rgba(13,148,136,0.18);
      background: #e0f2fe;
    }
    /* Inline math highlight */
    .markdown .mjx-tex-math {
      background: #f0fdfa;
      border-radius: 6px;
      padding: 0.1em 0.4em;
      color: #0d9488;
      font-size: 1.08em;
      margin: 0 0.1em;
    }
    /* MathJax font smoothing */
    .markdown .mjx-container {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Responsive markdown for mobile */
    @media (max-width: 640px) {
      .markdown pre {
        font-size: 0.9em; /* Slightly smaller font on mobile */
        padding: 0.6em 0.2em;
      }
      .markdown h1 {
        font-size: 1.2em;
      }
      .markdown h2 {
        font-size: 1em;
      }
      .markdown h3 {
        font-size: 0.9em;
      }
      .markdown .mjx-block {
        font-size: 0.9em;
        padding: 0.4em 0.1em;
      }
      .markdown .mjx-math {
        font-size: 0.9em;
        padding: 0.1em 0.2em;
      }
    }
    
    /* New typing animation for AI messages */
    .message-reveal {
      opacity: 0;
      transform: translateY(10px);
      animation: messageReveal 0.5s forwards;
    }
    
    @keyframes messageReveal {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message-reveal-delay-1 { animation-delay: 0.1s; }
    .message-reveal-delay-2 { animation-delay: 0.2s; }
    .message-reveal-delay-3 { animation-delay: 0.3s; }
    .message-reveal-delay-4 { animation-delay: 0.4s; }
    .message-reveal-delay-5 { animation-delay: 0.5s; }
    
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #2d2d2d; /* Darker header */
      color: #cccccc; /* Lighter text */
      padding: 0.6em 1em; /* Adjusted padding */
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.85em; /* Slightly smaller font */
    }
    
    .copy-btn {
      background: none;
      border: none;
      color: #cccccc; /* Lighter color */
      cursor: pointer;
      font-size: 0.8em;
      display: flex;
      align-items: center;
      gap: 0.3em;
      transition: color 0.2s;
    }
    
    .copy-btn:hover {
      color: #ffffff;
    }
    
    .chat-input {
      min-height: 24px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .chat-input:empty::before {
      content: "Hỏi Hie AI bất kỳ...";
      color: #9ca3af;
    }
    
    .suggestion-btn {
      transition: all 0.2s;
      font-size: 14px;
      padding: 10px 16px;
    }
    
    .suggestion-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .welcome-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      width: 80%;
      max-width: 500px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    
    .welcome-message.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      justify-content: center;
    }
    
    .action-btn {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      background: #f3f4f6;
      border: none;
      cursor: pointer;
    }
    /* Voice animation */
    .voice-anim {
      /* Giữ lại hiệu ứng rung nếu muốn */
      animation: voicePulse 1s infinite;
      color: #0ea5e9 !important;
    }
    /* Hiệu ứng sóng nhấp nhô cho mic */
    .mic-wave {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      gap: 2px;
    }
    .mic-wave-bar {
      width: 2px;
      height: 8px;
      background: #000000;
      border-radius: 1px;
      animation: micWaveAnim 1s infinite;
      opacity: 0.85;
    }
    .mic-wave-bar:nth-child(1) { animation-delay: 0s; }
    .mic-wave-bar:nth-child(2) { animation-delay: 0.15s; }
    .mic-wave-bar:nth-child(3) { animation-delay: 0.3s; }
    .mic-wave-bar:nth-child(4) { animation-delay: 0.45s; }
    .mic-wave-bar:nth-child(5) { animation-delay: 0.6s; }
    @keyframes micWaveAnim {
      0%, 100% { height: 6px; background: #000000; }
      50% { height: 14px; background: #333333; }
    }
    @keyframes voicePulse {
      0% { filter: drop-shadow(0 0 0 #0ea5e9); }
      50% { filter: drop-shadow(0 0 8px #0ea5e9); }
      100% { filter: drop-shadow(0 0 0 #0ea5e9); }
    }
    
    .suggestions-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: white;
      padding: 0 16px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 20;
      margin-bottom: 8px;
      border-radius: 12px;
    }
    
    .suggestions-container.expanded {
      max-height: 220px;
      padding: 16px;
      border: 1px solid #e5e7eb;
    }
    
    .toggle-suggestions {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 20px;
      background-color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin: 0 auto 8px;
      width: fit-content;
    }
    
    .toggle-suggestions:hover {
      background-color: #f3f4f6;
    }
    
    .user-message {
      background-color: rgba(59, 130, 246, 0.15) !important; /* Slightly more opaque */
      border-radius: 18px !important;
      padding: 8px 16px !important;
      display: inline-block !important;
      max-width: fit-content !important;
    }
    
    .send-button {
      color: #34383f;
      background: transparent !important;
      border: none;
      padding: 0;
      margin-left: 8px;
    }
    
    .send-button:hover {
      color: #2563eb;
    }
    
    /* Improved scroll-to-bottom button */
    .scroll-to-bottom {
      position: fixed;
      bottom: 180px; /* Điều chỉnh vị trí lên trên phần gợi ý */
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: white;
      border: 1px solid #d1d5db; /* Slightly darker border */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 1; /* Luôn hiển thị */
      transition: opacity 0.3s ease, transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease; /* Added transitions */
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .scroll-to-bottom:hover {
      transform: translateY(-3px); /* More pronounced lift */
      background-color: #e5e7eb; /* Lighter hover background */
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .scroll-to-bottom.hidden {
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none; /* Disable clicks when hidden */
    }
    
    .scroll-to-bottom:hover {
      background-color: #f3f4f6;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .footer-note {
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      padding: 8px 0;
      margin-top: 8px;
      border-top: 1px solid #e5e7eb;
    }
    
    /* Typing indicator */
    .typing-indicator {
      display: inline-block;
      padding: 10px 15px;
      border-radius: 18px;
      background-color: #e5e7eb; /* Lighter background */
    }
    
    .typing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #4b5563; /* Darker dots */
      margin-right: 4px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingAnimation {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    @media (max-width: 640px) {
      .welcome-message {
        width: 90%;
      }
      
      .chat-input {
        max-height: 150px;
      }
      
      .suggestions-container {
        margin-bottom: 8px;
      }
      
      .scroll-to-bottom {
        bottom: 160px;
        right: 15px;
        width: 36px;
        height: 36px;
      }
    }

    /* Modern code table styles */
    .modern-code-table {
      width: 100%;
      margin: 1.5em 0;
      background: #181c24;
      border-radius: 10px;
      box-shadow: 0 2px 12px 0 rgba(30,41,59,0.13);
      overflow: hidden;
      border: 1px solid #23272f;
      transition: box-shadow 0.2s;
    }
    .modern-code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #23272f;
      color: #e0e7ef;
      padding: 0.7em 1.2em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      font-size: 0.95em;
      border-bottom: 1px solid #23272f;
    }
    .modern-code-lang {
      font-weight: 700;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .modern-code-actions {
      display: flex;
      gap: 10px;
    }
    .modern-code-copy, .modern-code-expand {
      background: none;
      border: none;
      color: #e0e7ef;
      cursor: pointer;
      font-size: 1em;
      padding: 2px 6px;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .modern-code-copy:hover, .modern-code-expand:hover {
      background: #334155;
      color: #60a5fa;
    }
    .modern-code-body {
      max-height: 600px;
      overflow: auto;
      background: #181c24;
      transition: max-height 0.3s;
      padding: 1.2em 1em 1em 1em;
    }
    .modern-code-table[data-expanded="true"] .modern-code-body {
      max-height: 2000px;
      min-height: 600px;
    }
    .modern-code-table[data-expanded="false"] .modern-code-body {
      max-height: 600px;
    }
    .modern-code-table pre {
      background: transparent;
      box-shadow: none;
      border: none;
      margin: 0;
      padding: 0;
    }
    .modern-code-table code {
      background: transparent;
      color: #d4d4d4;
      font-size: 1em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .modern-code-table::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    .modern-code-table::-webkit-scrollbar-thumb {
      background: #23272f;
      border-radius: 4px;
    }
    .modern-code-table::-webkit-scrollbar-track {
      background: #181c24;
    }
    /* Fullscreen code overlay */
    .fullscreen-code-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(30,41,59,0.92);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fullscreen-code-table {
      width: 90vw;
      max-width: 1200px;
      max-height: 90vh;
      background: #181c24;
      border-radius: 12px;
      box-shadow: 0 4px 32px 0 rgba(30,41,59,0.25);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .fullscreen-code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #23272f;
      color: #e0e7ef;
      padding: 1em 1.5em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      font-size: 1.1em;
      border-bottom: 1px solid #23272f;
    }
    .fullscreen-code-lang {
      font-weight: 700;
      color: #60a5fa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .fullscreen-code-actions {
      display: flex;
      gap: 16px;
    }
    .fullscreen-code-copy, .fullscreen-code-close {
      background: none;
      border: none;
      color: #e0e7ef;
      cursor: pointer;
      font-size: 1.2em;
      padding: 4px 10px;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    .fullscreen-code-copy:hover, .fullscreen-code-close:hover {
      background: #334155;
      color: #60a5fa;
    }
    .fullscreen-code-body {
      flex: 1;
      overflow: auto;
      background: #181c24;
      padding: 2em 1.5em 1.5em 1.5em;
    }
    .fullscreen-code-body pre {
      background: transparent;
      box-shadow: none;
      border: none;
      margin: 0;
      padding: 0;
    }
    .fullscreen-code-body code {
      background: transparent;
      color: #d4d4d4;
      font-size: 1.1em;
      font-family: 'Fira Mono', 'Courier New', Courier, monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .ai-thinking-code {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1em;
      color: #2563eb;
      font-weight: 500;
      padding: 8px 0;
    }
    /* File preview animation (DeepSeek style) */
    #file-preview-container {
      display: flex;
      align-items: flex-end;
      margin-bottom: 8px;
      margin-top: 8px;
      animation: fadeInFilePreview 0.3s;
    }
    .file-preview-box {
      display: flex;
      align-items: center;
      background: #23272f;
      color: #fff;
      border-radius: 18px;
      padding: 12px 20px 12px 16px;
      box-shadow: 0 2px 12px #0002;
      gap: 14px;
      min-width: 220px;
      max-width: 350px;
      font-size: 1em;
      position: relative;
      margin-bottom: 2px;
      margin-left: 2px;
      margin-right: 2px;
      animation: popInFilePreview 0.25s;
    }
    @keyframes fadeInFilePreview {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes popInFilePreview {
      0% { transform: scale(0.95); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .file-preview-icon {
      font-size: 2em;
      margin-right: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .file-preview-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .file-preview-name {
      font-weight: 600;
      font-size: 1.05em;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }
    .file-preview-type {
      font-size: 0.95em;
      color: #bdbdbd;
      margin-top: 1px;
    }
    .file-preview-remove {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.1em;
      margin-left: 10px;
      cursor: pointer;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
      position: absolute;
      top: 8px;
      right: 8px;
    }
    .file-preview-remove:hover {
      background: #374151;
      color: #ff6b6b;
    }
    /* Responsive chat input layout */
    @media (max-width: 640px) {
      #chat-form .chat-input {
        font-size: 1em;
        padding: 8px 10px;
      }
      #chat-form .flex.items-center.justify-between.mt-1 {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      #chat-form .flex.items-center.gap-2 {
        justify-content: flex-end;
      }
    }
    /* Override màu cho dark mode */
    .dark .bg-white { background-color: #181a20 !important; }
    .dark .text-gray-800 { color: #e5e7eb !important; }
    .dark .text-gray-600 { color: #bdbdbd !important; }
    .dark .border-gray-200 { border-color: #23272f !important; }
    .dark .border-gray-300 { border-color: #374151 !important; }
    .dark .bg-gray-100 { background-color: #23272f !important; color: #e5e7eb !important; }
    .dark .bg-gray-50 { background-color: #23272f !important; }
    .dark .bg-gray-800 { background-color: #23272f !important; }
    .dark .bg-black { background-color: #23272f !important; }
    .dark .text-black { color: #e5e7eb !important; }
    .dark .shadow { box-shadow: 0 2px 12px 0 rgba(0,0,0,0.45) !important; }
    .dark .rounded-2xl { box-shadow: 0 2px 12px 0 rgba(0,0,0,0.25) !important; }
    .dark .user-message { background-color: #2563eb22 !important; color: #e5e7eb !important; }
    .dark .footer-note { color: #bdbdbd; border-top: 1px solid #23272f; }
    .dark .suggestion-btn { background: #23272f; color: #e5e7eb; }
    .dark .suggestion-btn:hover { background: #374151; }
    .dark .scroll-to-bottom { background: #23272f; border-color: #374151; color: #e5e7eb; }
    .dark .scroll-to-bottom:hover { background: #374151; }
    .dark .file-preview-box { background: #23272f; color: #e5e7eb; }
    .dark .file-preview-remove { color: #e5e7eb; }
    .dark .file-preview-remove:hover { background: #374151; color: #ff6b6b; }
    .dark .ai-thinking-code { color: #60a5fa; }
    .dark .typing-indicator { background: #23272f !important; color: #e5e7eb !important; }
    .dark .modern-code-table, .dark .fullscreen-code-table { background: #181a20; border-color: #23272f; }
    .dark .modern-code-header, .dark .fullscreen-code-header { background: #23272f; color: #e0e7ef; }
    .dark .modern-code-lang, .dark .fullscreen-code-lang { color: #60a5fa; }
    .dark .modern-code-body, .dark .fullscreen-code-body { background: #181a20; color: #d4d4d4; }
    .dark .modern-code-copy, .dark .modern-code-expand, .dark .fullscreen-code-copy, .dark .fullscreen-code-close { color: #e0e7ef; }
    .dark .modern-code-copy:hover, .dark .modern-code-expand:hover, .dark .fullscreen-code-copy:hover, .dark .fullscreen-code-close:hover { background: #374151; color: #60a5fa; }
    .dark .markdown { color: #e5e7eb; }
    
    /* Dark mode cho animation tạo ảnh AI */
    .dark .ai-image-loading-container {
      background: linear-gradient(135deg,#1e293b 0%,#334155 100%) !important;
      box-shadow: 0 8px 32px rgba(30,41,59,0.4) !important;
    }
    
    .dark .ai-image-loading-container:hover {
      box-shadow: 0 12px 40px rgba(30,41,59,0.6) !important;
    }
    
    .dark .prompt-display {
      background: linear-gradient(135deg,#1e293b,#334155) !important;
      border: 1px solid rgba(255,255,255,0.1) !important;
      color: #e5e7eb !important;
    }
    
    .dark .prompt-display div {
      color: #e5e7eb !important;
    }
    
    /* Dark mode cho image modal */
    .dark #image-modal-overlay .modal-content {
      background: #1e293b !important;
      color: #e5e7eb !important;
    }
    
    .dark #image-modal-overlay .modal-content .prompt-text {
      color: #e5e7eb !important;
    }
    .dark .markdown h1, .dark .markdown h2, .dark .markdown h3, .dark .markdown h4 { color: #60a5fa; border-color: #374151; }
    .dark .markdown p, .dark .markdown li { color: #e5e7eb; }
    .dark .markdown blockquote { background: #23272f; color: #bdbdbd; border-left: 5px solid #60a5fa; }
    .dark .markdown pre { background: #23272f; border-color: #374151; color: #d4d4d4; }
    .dark .markdown code { background: #23272f; color: #ffe066; }
    .dark .markdown pre code { color: #d4d4d4; }
    /* Enhanced Dark Mode Table Styles */
    .dark .markdown table { 
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
      color: #e5e7eb; 
      border: 1px solid rgba(71,85,105,0.6);
      box-shadow: 
        0 4px 20px rgba(0,0,0,0.3),
        0 1px 3px rgba(0,0,0,0.2),
        inset 0 1px 0 rgba(255,255,255,0.05);
    }
    
    .dark .markdown table:hover {
      box-shadow: 
        0 8px 32px rgba(0,0,0,0.4),
        0 2px 8px rgba(0,0,0,0.3),
        inset 0 1px 0 rgba(255,255,255,0.08);
    }
    
    .dark .markdown table::before {
      background: linear-gradient(90deg, #60a5fa, #a855f7, #06b6d4);
      opacity: 0.9;
    }
    
    .dark .markdown table th { 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
      color: #60a5fa; 
      border-bottom: 2px solid #475569;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .dark .markdown table td {
      background: rgba(30,41,59,0.6);
      color: #e5e7eb;
      border-bottom: 1px solid rgba(71,85,105,0.4);
      border-right: 1px solid rgba(71,85,105,0.3);
    }
    
    .dark .markdown table tr:nth-child(even) td { 
      background: linear-gradient(135deg, rgba(51,65,85,0.6) 0%, rgba(30,41,59,0.4) 100%); 
    }
    
    .dark .markdown table tr:hover td { 
      background: linear-gradient(135deg, rgba(96,165,250,0.1) 0%, rgba(168,85,247,0.05) 100%);
      box-shadow: 0 2px 8px rgba(96,165,250,0.15);
      border-color: rgba(96,165,250,0.3);
    }
    
    .dark .markdown table tr:hover td:first-child {
      border-left: 3px solid #60a5fa;
    }
    
    .dark .markdown table td strong {
      color: #93c5fd;
    }
    
    .dark .markdown table td em {
      color: #c4b5fd;
    }
    
    .dark .markdown table::-webkit-scrollbar-track {
      background: rgba(30,41,59,0.5);
    }
    
    .dark .markdown table::-webkit-scrollbar-thumb {
      background: linear-gradient(90deg, #475569, #64748b);
    }
    
    .dark .markdown table::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(90deg, #64748b, #94a3b8);
    }
    .dark .markdown hr { border-top: 2px solid #374151; }
    .dark .markdown strong { color: #ffe066; }
    .dark .markdown .mjx-math, .dark .markdown .mjx-block, .dark .markdown .mjx-tex-math { background: #23272f; color: #60a5fa; border-color: #374151; }
    .dark .modern-code-table::-webkit-scrollbar-thumb, .dark .modern-code-table::-webkit-scrollbar-track { background: #23272f; }
    .dark .modern-code-table::-webkit-scrollbar-thumb { background: #374151; }
    .dark .modern-code-table::-webkit-scrollbar-track { background: #181a20; }
    .dark .fullscreen-code-overlay { background: rgba(24,26,32,0.97); }
    .dark .fullscreen-code-table { background: #181a20; }
    .dark .fullscreen-code-header { background: #23272f; color: #e0e7ef; }
    .dark .fullscreen-code-body { background: #181a20; color: #d4d4d4; }
    .dark .fullscreen-code-lang { color: #60a5fa; }
    .dark .fullscreen-code-copy, .dark .fullscreen-code-close { color: #e0e7ef; }
    .dark .fullscreen-code-copy:hover, .dark .fullscreen-code-close:hover { background: #374151; color: #60a5fa; }
    /* Transition cho mọi thành phần chính */
    .bg-white, .bg-gray-100, .bg-gray-50, .bg-gray-800, .bg-black, .text-gray-800, .text-gray-600, .text-black, .user-message, .modern-code-table, .modern-code-header, .modern-code-body, .fullscreen-code-table, .fullscreen-code-header, .fullscreen-code-body, .markdown, .footer-note, .suggestion-btn, .scroll-to-bottom, .file-preview-box, .typing-indicator {
      transition: background 0.35s, color 0.35s, box-shadow 0.35s, border-color 0.35s;
    }
    .hieai-title {
      font-size: 1.35rem;
      font-weight: 700;
      color: #23272f;
      letter-spacing: 1px;
      animation: hieai-pop 1.2s cubic-bezier(.23,1.12,.32,1.01);
      transition: color 0.3s;
    }
    @keyframes hieai-pop {
      0% { transform: scale(0.85) translateY(-10px); opacity: 0; }
      60% { transform: scale(1.08) translateY(2px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    .dark .hieai-title {
      color: #e5e7eb;
    }
    .hieai-title:hover {
      text-shadow: 0 4px 24px #be185d55, 0 1px 0 #fff;
      filter: drop-shadow(0 4px 16px #be185d33);
    }
    /* Hacker Dev Mode Theme */
    .dev-mode-hacker {
      background: #10181a !important;
    }
    .dev-mode-hacker .hieai-title,
    .dev-mode-hacker .user-message,
    .dev-mode-hacker .max-w-\[85\%\],
    .dev-mode-hacker .markdown,
    .dev-mode-hacker .footer-note,
    .dev-mode-hacker .modern-code-header,
    .dev-mode-hacker .modern-code-lang,
    .dev-mode-hacker .modern-code-body,
    .dev-mode-hacker .fullscreen-code-header,
    .dev-mode-hacker .fullscreen-code-lang,
    .dev-mode-hacker .fullscreen-code-body {
      color: #00ff90 !important;
      text-shadow: 0 0 8px #00ff90cc;
    }
    .dev-mode-hacker .theme-toggle-btn,
    .dev-mode-hacker .send-button,
    .dev-mode-hacker .material-icons,
    .dev-mode-hacker .fa-code {
      color: #00ff90 !important;
      text-shadow: 0 0 8px #00ff90cc;
    }
    .dev-mode-hacker .bg-white,
    .dev-mode-hacker .bg-gray-100,
    .dev-mode-hacker .bg-gray-50,
    .dev-mode-hacker .bg-gray-800,
    .dev-mode-hacker .bg-black {
      background: #10181a !important;
    }
    .dev-mode-hacker .rounded-2xl,
    .dev-mode-hacker .modern-code-table,
    .dev-mode-hacker .fullscreen-code-table {
      background: #0a1416 !important;
      border-color: #00ff90 !important;
      box-shadow: 0 0 24px #00ff9033;
    }
    .dev-mode-hacker .modern-code-header,
    .dev-mode-hacker .fullscreen-code-header {
      background: #0a1416 !important;
      border-bottom: 1px solid #00ff90 !important;
    }
    .dev-mode-hacker .modern-code-copy:hover,
    .dev-mode-hacker .modern-code-expand:hover,
    .dev-mode-hacker .fullscreen-code-copy:hover,
    .dev-mode-hacker .fullscreen-code-close:hover {
      background: #003a1a !important;
      color: #00ff90 !important;
    }
    .dev-mode-hacker .scroll-to-bottom {
      background: #003a1a !important;
      color: #00ff90 !important;
      border-color: #00ff90 !important;
      box-shadow: 0 0 12px #00ff9033;
    }
    .dev-mode-hacker .scroll-to-bottom:hover {
      background: #00ff90 !important;
      color: #003a1a !important;
    }
    .dev-mode-hacker .file-preview-box {
      background: #0a1416 !important;
      color: #00ff90 !important;
      box-shadow: 0 0 12px #00ff9033;
    }
    .dev-mode-hacker .footer-note {
      color: #00ff90 !important;
      border-top: 1px solid #00ff90 !important;
    }
    .dev-mode-hacker .action-btn {
      background: #003a1a !important;
      color: #00ff90 !important;
      border: 1px solid #00ff90 !important;
    }
    .dev-mode-hacker .action-btn:hover {
      background: #00ff90 !important;
      color: #003a1a !important;
    }
    .dev-mode-hacker .chat-input {
      color: #00ff90 !important;
      background: #10181a !important;
      border-color: #00ff90 !important;
    }
    .dev-mode-hacker .typing-indicator {
      background: #003a1a !important;
      color: #00ff90 !important;
    }
    .dev-mode-hacker .material-icons.voice-icon.voice-anim {
      color: #00ff90 !important;
      filter: drop-shadow(0 0 8px #00ff90cc);
    }
    /* Animation for dev mode hint */
    @keyframes devModeHint {
      0% { transform: scale(0.9) translateY(-10px); opacity: 0; }
      60% { transform: scale(1.08) translateY(2px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    .dev-mode-hint {
      background: #003a1a;
      color: #00ff90;
      border: 2px solid #00ff90;
      border-radius: 16px;
      padding: 16px 24px;
      font-size: 1.1em;
      font-weight: 500;
      box-shadow: 0 0 24px #00ff9033;
      margin: 18px auto 0 auto;
      max-width: 420px;
      text-align: center;
      animation: devModeHint 0.8s cubic-bezier(.23,1.12,.32,1.01);
      z-index: 20;
      position: relative;
    }
    .dev-mode-hint .dev-mode-arrow {
      display: block;
      font-size: 2.2em;
      margin: 0 auto 0.2em auto;
      color: #00ff90;
      filter: drop-shadow(0 0 8px #00ff90cc);
      animation: bounceArrow 1.2s infinite;
    }
    @keyframes bounceArrow {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(8px); }
    }
    .dev-mode-hacker .markdown,
    .dev-mode-hacker .user-message,
    .dev-mode-hacker .max-w-\[85\%\] {
      color: #ffffff !important;
      font-weight: 600 !important;
      text-shadow: none !important;
    }
    .dev-mode-hacker .modern-code-header,
    .dev-mode-hacker .modern-code-lang,
    .dev-mode-hacker .modern-code-body code,
    .dev-mode-hacker .fullscreen-code-header,
    .dev-mode-hacker .fullscreen-code-lang,
    .dev-mode-hacker .fullscreen-code-body code {
      color: #00ff90 !important;
      text-shadow: 0 0 8px #00ff90cc;
    }
    .dev-mode-hacker .action-btn i,
    .dev-mode-hacker .copy-btn i,
    .dev-mode-hacker .modern-code-copy i,
    .dev-mode-hacker .modern-code-expand i,
    .dev-mode-hacker .fullscreen-code-copy i,
    .dev-mode-hacker .fullscreen-code-close i,
    .dev-mode-hacker .img-action-btn .material-icons {
      color: #00ff90 !important;
      filter: drop-shadow(0 0 6px #00ff9033);
      transition: color 0.2s;
    }
    .dev-mode-hacker .action-btn:hover i,
    .dev-mode-hacker .copy-btn:hover i,
    .dev-mode-hacker .modern-code-copy:hover i,
    .dev-mode-hacker .modern-code-expand:hover i,
    .dev-mode-hacker .fullscreen-code-copy:hover i,
    .dev-mode-hacker .fullscreen-code-close:hover i,
    .dev-mode-hacker .img-action-btn:hover .material-icons {
      color: #fff !important;
      filter: drop-shadow(0 0 8px #fff8);
    }
    .hieai-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #e0e7ef;
      border-top: 3px solid #2563eb;
      border-radius: 50%;
      animation: hieai-spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes hieai-spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    .plus-menu {
      position: absolute;
      bottom: 60px;
      left: 10px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px #0002;
      padding: 10px 0;
      z-index: 50;
      min-width: 180px;
      animation: plusMenuFadeIn 0.25s;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .plus-menu.hidden { display: none; }
    .plus-menu-item {
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      padding: 10px 18px;
      font-size: 1.05em;
      color: #23272f;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.18s;
    }
    .plus-menu-item:hover {
      background: #f3f4f6;
    }
    @keyframes plusMenuFadeIn {
      from { opacity: 0; transform: translateY(10px) scale(0.98);}
      to   { opacity: 1; transform: translateY(0) scale(1);}
    }
    #plus-icon {
      transition: transform 0.35s cubic-bezier(.4,2,.6,1);
    }
    .plus-rotate {
      transform: rotate(135deg);
    }
    .send-btn-spinner {
      display: block;
      margin: 0 auto;
      width: 22px;
      height: 22px;
      border: 3px solid #fff;
      border-top: 3px solid #e5e7eb;
      border-radius: 50%;
      animation: sendBtnSpin 0.8s linear infinite;
      vertical-align: middle;
    }
    @keyframes sendBtnSpin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
    /* Popup New Chat 2025 */
    #new-chat-popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(30,41,59,0.18);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeInNewChat 0.25s;
    }
    @keyframes fadeInNewChat {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    #new-chat-popup {
      background: #fff;
      color: #23272f;
      border-radius: 1.2rem;
      box-shadow: 0 4px 32px #0002;
      padding: 2rem 1.2rem 1.5rem 1.2rem;
      min-width: 280px;
      max-width: 92vw;
      text-align: center;
      animation: popInNewChat 0.32s cubic-bezier(.23,1.12,.32,1.01);
      position: relative;
      border: 1px solid #e5e7eb;
    }
    @keyframes popInNewChat {
      0% { transform: scale(0.92) translateY(18px); opacity: 0; }
      60% { transform: scale(1.04) translateY(-4px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    #new-chat-popup .new-chat-title {
      font-size: 1.18rem;
      font-weight: 700;
      color: #23272f;
      margin-bottom: 1.1rem;
      letter-spacing: 0.5px;
    }
    #new-chat-popup .new-chat-btns {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      margin-top: 1.1rem;
    }
    #new-chat-popup .new-chat-btn {
      background: #23272f;
      color: #fff;
      font-weight: 600;
      font-size: 1em;
      border: none;
      border-radius: 0.9rem;
      padding: 0.7em 0;
      box-shadow: 0 1px 6px #0001;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, transform 0.16s;
    }
    #new-chat-popup .new-chat-btn:hover {
      background: #111827;
      color: #fff;
      transform: translateY(-1px) scale(1.03);
    }
    #new-chat-popup .new-chat-close {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.25em;
      color: #23272f;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.18s;
    }
    #new-chat-popup .new-chat-close:hover {
      opacity: 1;
    }
    @media (max-width: 500px) {
      #new-chat-popup { min-width: 90vw; padding: 1rem 0.3rem 1rem 0.3rem; }
    }
    /* Dark mode cho popup */
    .dark #new-chat-popup {
      background: #23272f;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    .dark #new-chat-popup .new-chat-title {
      color: #e5e7eb;
    }
    .dark #new-chat-popup .new-chat-btn {
      background: #fff;
      color: #23272f;
    }
    .dark #new-chat-popup .new-chat-btn:hover {
      background: #e5e7eb;
      color: #23272f;
    }
    .dark #new-chat-popup .new-chat-close {
      color: #e5e7eb;
    }

    /* === Markdown chỉ đen/trắng đậm, không màu sắc khác === */
    .markdown,
    .markdown h1, .markdown h2, .markdown h3, .markdown h4,
    .markdown p, .markdown li, .markdown strong,
    .markdown table th, .markdown table td {
      color: #18181b !important;
    }
    
    /* Enhanced table styles for black/white theme */
    .markdown table {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
      border: 1px solid rgba(226,232,240,0.8) !important;
      box-shadow: 
        0 4px 20px rgba(30,41,59,0.08),
        0 1px 3px rgba(0,0,0,0.05),
        inset 0 1px 0 rgba(255,255,255,0.8) !important;
    }
    
    .markdown table th {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
      color: #1e293b !important;
      border-bottom: 2px solid #cbd5e1 !important;
    }
    
    .markdown table td {
      background: rgba(255,255,255,0.7) !important;
      color: #374151 !important;
    }
    
    .markdown table tr:nth-child(even) td {
      background: linear-gradient(135deg, rgba(248,250,252,0.8) 0%, rgba(241,245,249,0.6) 100%) !important;
    }
    
    .markdown table tr:hover td {
      background: linear-gradient(135deg, rgba(59,130,246,0.05) 0%, rgba(139,92,246,0.03) 100%) !important;
    }
    .markdown strong {
      color: #18181b !important;
    }
    .markdown code, .modern-code-body code, .fullscreen-code-body code {
      background-color: #e5e7eb !important;
      color: #18181b !important;
    }
    .markdown pre, .modern-code-body pre, .fullscreen-code-body pre {
      background-color: #23272f !important;
      color: #18181b !important;
      border: 1px solid #333 !important;
    }
    .markdown blockquote {
      border-left: 5px solid #23272f !important;
      background: #f3f4f6 !important;
      color: #18181b !important;
    }
    /* Dark mode: màu trắng đậm */
    .dark .markdown,
    .dark .markdown h1, .dark .markdown h2, .dark .markdown h3, .dark .markdown h4,
    .dark .markdown p, .dark .markdown li, .dark .markdown strong,
    .dark .markdown table th, .dark .markdown table td {
      color: #fff !important;
    }
    
    /* Enhanced dark mode table styles for black/white theme */
    .dark .markdown table {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
      border: 1px solid rgba(71,85,105,0.6) !important;
      box-shadow: 
        0 4px 20px rgba(0,0,0,0.3),
        0 1px 3px rgba(0,0,0,0.2),
        inset 0 1px 0 rgba(255,255,255,0.05) !important;
    }
    
    .dark .markdown table th {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
      color: #60a5fa !important;
      border-bottom: 2px solid #475569 !important;
    }
    
    .dark .markdown table td {
      background: rgba(30,41,59,0.6) !important;
      color: #e5e7eb !important;
    }
    
    .dark .markdown table tr:nth-child(even) td {
      background: linear-gradient(135deg, rgba(51,65,85,0.6) 0%, rgba(30,41,59,0.4) 100%) !important;
    }
    
    .dark .markdown table tr:hover td {
      background: linear-gradient(135deg, rgba(96,165,250,0.1) 0%, rgba(168,85,247,0.05) 100%) !important;
    }
    .dark .markdown strong {
      color: #fff !important;
    }
    .dark .markdown code, .dark .modern-code-body code, .dark .fullscreen-code-body code {
      background-color: #23272f !important;
      color: #fff !important;
    }
    .dark .markdown pre, .dark .modern-code-body pre, .dark .fullscreen-code-body pre {
      background-color: #181a20 !important;
      color: #fff !important;
      border: 1px solid #374151 !important;
    }
    .dark .markdown blockquote {
      border-left: 5px solid #fff !important;
      background: #23272f !important;
      color: #fff !important;
    }
    .markdown code, .modern-code-body code, .fullscreen-code-body code {
      background-color: #23272f !important; /* Nền tối */
      color: #fff !important; /* Chữ sáng */
    }
    .markdown pre, .modern-code-body pre, .fullscreen-code-body pre {
      background-color: #23272f !important; /* Nền tối */
      color: #fff !important; /* Chữ sáng */
      border: 1px solid #333 !important;
    }
    /* Dark mode: code block nền sáng, chữ tối */
    .dark .markdown code, .dark .modern-code-body code, .dark .fullscreen-code-body code {
      background-color: #f3f4f6 !important; /* Nền sáng */
      color: #18181b !important; /* Chữ đen đậm */
    }
    .dark .markdown pre, .dark .modern-code-body pre, .dark .fullscreen-code-body pre {
      background-color: #f3f4f6 !important; /* Nền sáng */
      color: #18181b !important; /* Chữ đen đậm */
      border: 1px solid #374151 !important;
    }
    /* Animation cho nút dừng chat */
    .send-btn-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    /* Hiệu ứng pulse cho nút dừng */
    .bg-gray-400 {
      animation: stopButtonPulse 2s ease-in-out infinite;
      box-shadow: 0 0 0 0 rgba(156, 163, 175, 0.7);
    }
    
    @keyframes stopButtonPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(156, 163, 175, 0.7);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 0 10px rgba(156, 163, 175, 0);
        transform: scale(1.05);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(156, 163, 175, 0);
        transform: scale(1);
      }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Hover effect cho nút dừng */
    .bg-gray-400:hover {
      animation: stopButtonHover 0.3s ease-in-out;
      background-color: #ef4444 !important;
      transform: scale(1.1);
    }
    
    @keyframes stopButtonHover {
      0% { transform: scale(1.05); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1.1); }
    }
  </style>
</head>
<body class="bg-white min-h-screen flex flex-col">
  <!-- Top bar -->
  <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200 sticky top-0 bg-white z-10">
    <button aria-label="New chat" class="text-gray-700 text-xl new-chat-modern-btn" onclick="showNewChatPopup()" style="padding:0.2em 0.3em;">
      <span class="material-icons" style="font-size:1.45em;vertical-align:middle;">chat_bubble_outline</span>
    </button>
    <div class="flex-1 flex justify-center items-center">
      <span class="hieai-title">Nexa X o4</span>
    </div>
    <button id="theme-toggle" aria-label="Chuyển giao diện sáng/tối" class="theme-toggle-btn flex items-center justify-center w-10 h-10 rounded-full transition-all duration-300 focus:outline-none border border-gray-200 dark:border-gray-700 bg-gray-100 dark:bg-gray-800 text-yellow-500 dark:text-blue-300 shadow hover:scale-110" style="margin-left:auto;">
      <span id="theme-toggle-icon" class="material-icons transition-all duration-300">dark_mode</span>
    </button>
  </header>

  <!-- Chat container -->
  <main class="flex-grow overflow-y-auto p-4 space-y-6 relative" id="chat-container">
    <!-- Welcome message -->
    <div class="welcome-message text-center" id="welcome-message">
      <div class="text-3xl font-medium mb-4">Xin chào, tôi là <strong>Nexa X</strong></div>
      <div class="text-gray-600 mb-6">Bạn có cần tôi giúp gì hôm nay không?</div>
    </div>
  </main>

  <!-- Scroll to bottom button - Positioned above suggestions -->
  <button class="scroll-to-bottom hidden" id="scroll-to-bottom" onclick="scrollToBottom()">
    <i class="fas fa-arrow-down"></i>
  </button>

  <!-- Bottom area -->
  <footer class="px-5 pb-4 pt-2 border-t border-gray-200 bg-white sticky bottom-0 z-10">

    
    <!-- Chat input form -->
    <!-- Preview file đã upload -->
    <div id="file-preview-container" style="display:none;"></div>
    <form
      class="px-0 pt-0 pb-0 bg-white shadow-sm border-none"
      role="search"
      aria-label="Ask Nexa Space"
      id="chat-form"
      onsubmit="sendMessage(event)"
      style="border:none;box-shadow:none;"
    >
      <div class="flex flex-col gap-1">
        <!-- Vùng nhập liệu -->
        <div 
          id="chat-input" 
          class="chat-input outline-none text-gray-700 text-base bg-transparent max-h-32 overflow-y-auto py-2 px-3 border-b border-gray-300 focus:border-blue-500 transition-colors"
          contenteditable="true"
          role="textbox"
          aria-multiline="true"
          style="min-height: 38px;"
        ></div>
        <!-- Hàng dưới: các nút chức năng nằm cùng hàng, tách trái phải -->
        <div class="flex items-center mt-1">
          <div>
            <button type="button" aria-label="Thêm" class="text-2xl text-gray-500 hover:bg-gray-100 rounded-full p-2 relative" id="file-upload-btn" onclick="togglePlusMenu()">
              <i class="fas fa-plus" id="plus-icon"></i>
            </button>
            <div id="plus-menu" class="plus-menu hidden">
              <button class="plus-menu-item" onclick="triggerFileInput()">
                <i class="fas fa-file-upload"></i> Tải lên một file
              </button>
              <button class="plus-menu-item" onclick="toggleDevModeFromMenu()">
                <i class="material-icons">code</i> Chế độ lập trình
              </button>
            </div>
            <input type="file" id="file-input" style="display:none" accept=".txt,.csv,.pdf,.doc,.docx,.json,.md,.log,.xml,.html,.js,.py,.java,.c,.cpp,.ts,.tsx,.xls,.xlsx" />
          </div>
          <div class="flex items-center gap-2 ml-auto">
            <button type="button" aria-label="Voice" class="send-button rounded-full flex items-center justify-center text-xl" id="voice-button" onclick="toggleVoiceInput()">
              <i class="material-icons voice-icon">mic</i>
            </button>
            <button
              type="submit"
              aria-label="Submit"
              class="flex items-center justify-center rounded-full bg-black text-white w-10 h-10"
              id="send-button"
              style="min-width:40px;min-height:40px;"
            >
              <span class="material-icons" id="send-button-icon">arrow_upward</span>
            </button>
          </div>
        </div>
      </div>
    </form>
    <!-- Thông báo tính năng AI mới -->
    <div id="ai-feature-note" style="margin-top:8px; text-align:center; color:#2563eb; background:#f0f6ff; border-radius:12px; padding:8px 0; font-size:15px; font-weight:500; position:relative; transition:opacity 0.3s;">
      <span style="vertical-align:middle; margin-right:6px;">✨</span>AI hiện đã có thể <b>tạo ảnh</b>, <b>viết code mạnh mẽ</b>,...
      <button id="ai-feature-note-close" aria-label="Đóng thông báo" style="position:absolute;top:6px;right:14px;background:none;border:none;font-size:18px;color:#2563eb;cursor:pointer;line-height:1;">&times;</button>
    </div>
    <!-- Footer note -->
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.2.12/marked.min.js"></script>
  <script>

    const API_KEY = 'AIzaSyAZ9n2cG72K50iT_H9hz9b3dRZniCUu5Fk';
    const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';

    const IMAGE_API_KEY = 'AIzaSyAnQ7PG0UCgWgJQgiBAiyxjCIC_kT6hoYg';
    const IMAGE_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent';

    // Danh sách API key cho Gemini
    const API_KEYS = [
      'AIzaSyAZ9n2cG72K50iT_H9hz9b3dRZniCUu5Fk',
      'AIzaSyBJ0UJEU0lTgZFp-QOmXIRMI25vhi2LpHQ',
      'AIzaSyBpJM12EZ99y09fJQ3fw97mjLLS666Mq9E',
      'AIzaSyCsqGVFRJ9B1cPK9ZQV9YJ36wlNOfDehbw'
    ];
    let apiKeyIndex = 0;
    function getCurrentApiKey() {
      return API_KEYS[apiKeyIndex];
    }
    function switchToNextApiKey() {
      apiKeyIndex++;
      return apiKeyIndex < API_KEYS.length;
    }

    // Hàm gọi Gemini API với retry khi hết quota/hết hạn
    async function callGeminiAPIWithRetry(requestBody, apiUrl) {
      let lastError = null;
      apiKeyIndex = 0;
      while (apiKeyIndex < API_KEYS.length) {
        try {
          const response = await fetch(`${apiUrl}?key=${getCurrentApiKey()}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
          });
          if (response.ok) {
            return await response.json();
          } else {
            if (response.status === 403 || response.status === 429) {
              if (!switchToNextApiKey()) break;
            } else {
              throw new Error(await response.text());
            }
          }
        } catch (err) {
          lastError = err;
          if (!switchToNextApiKey()) break;
        }
      }
      throw lastError || new Error('Hết API key hoặc lỗi không xác định');
    }

    // Hàm nhận diện yêu cầu tạo ảnh
    function isImageRequest(message) {
      const lower = message.toLowerCase();
      // Chỉ nhận diện khi có các cụm từ yêu cầu tạo ảnh rõ ràng
      // Ví dụ: 'hãy tạo ảnh', 'vẽ cho tôi', 'tạo hình ảnh', 'draw an image', 'generate an image', 'please create an image', ...
      if (/((hãy|làm|giúp|please|can you|could you|would you|bạn có thể|làm ơn|giúp tôi|giúp mình|cho tôi|cho mình|make me|give me|create|generate|draw|illustrate).{0,20}((một )?(bức )?(ảnh|hình|picture|image|art|sketch|illustration|render)))|((tạo|vẽ|minh họa|draw|generate|create|illustrate) (một |an |a )?(bức )?(ảnh|hình|picture|image|art|sketch|illustration|render))/.test(lower)) {
        return true;
      }
      // Nếu câu bắt đầu bằng "Vẽ cho tôi", "Tạo ảnh", "Draw an image", ...
      if (/^(vẽ|tạo|minh họa|draw|generate|create|illustrate) (một |an |a )?(bức )?(ảnh|hình|picture|image|art|sketch|illustration|render)/.test(lower)) {
        return true;
      }
      // Nếu có các cụm từ rõ ràng như "please create an image", "draw an image of", ...
      if (/(please|can you|could you|would you|giúp tôi|giúp mình|làm ơn|bạn có thể).{0,20}(draw|create|generate|illustrate).{0,20}(image|picture|art|sketch|illustration|render)/.test(lower)) {
        return true;
      }
      return false;
    }

    // Hàm gọi API tạo ảnh
    async function callGeminiImageAPI(prompt) {
      const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent';
      const requestBody = {
        contents: [{
          parts: [ { text: prompt } ]
        }],
        generationConfig: {
          responseModalities: ["TEXT", "IMAGE"]
        }
      };
      const data = await callGeminiAPIWithRetry(requestBody, url);
      for (const candidate of data.candidates) {
        for (const part of candidate.content.parts) {
          if (part.inlineData) return part.inlineData.data;
        }
      }
      throw new Error('Không tìm thấy ảnh trong phản hồi');
    }

    // Lời nhắc hệ thống cho Khoa AI
    const SYSTEM_PROMPT = `
Bạn là **Nexa X**, một trợ lý ảo thông minh được phát triển bởi **Khoa Dev**.
Bạn có thể tạo ảnh theo yêu cầu người dùng
--- 🎯 Mục tiêu ---
- Cung cấp thông tin chính xác, cập nhật, và đa lĩnh vực.
- Trợ giúp người dùng một cách tự nhiên, hiệu quả và giàu cảm xúc khi phù hợp.
- Duy trì phong cách giao tiếp thân thiện, chuyên nghiệp, luôn hướng đến trải nghiệm người dùng.

--- 💬 Ngôn ngữ ---
- Trả lời bằng **tiếng Việt** theo mặc định.
- Chỉ sử dụng ngôn ngữ khác nếu người dùng yêu cầu.
- Ưu tiên dùng từ ngữ tự nhiên, dễ hiểu, gần gũi với người dùng.

--- ✍️ Phong cách phản hồi ---
- Trình bày rõ ràng, dễ đọc, có dàn ý hoặc phân đoạn hợp lý nếu nội dung dài.
- Có thể sử dụng biểu tượng cảm xúc (emoji) nhẹ nhàng nếu làm tăng tính thân thiện.
- Khi viết thơ, hãy trình bày như sau:
  - Tên bài thơ: in đậm ở đầu.
  - Tác giả: ghi dưới tên bài thơ, dùng dấu gạch dưới và ghi là "Hie AI".
  - Bài thơ trình bày xuống dòng rõ ràng, theo cảm xúc người dùng, ngôn ngữ gần gũi, truyền cảm.

--- 🚀 Khi viết code ---
- Luôn viết code đầy đủ, hiện đại, nhiều dòng, không rút gọn.
- Ưu tiên sử dụng các thư viện/framework mới nhất nếu phù hợp (React, Next.js, Tailwind, TypeScript, ...).
- Nếu có thể, hãy thêm ví dụ sử dụng, test case, giải thích từng phần code.
- Không chỉ trả lời code ngắn, hãy trình bày giải pháp toàn diện, mạnh mẽ như Claude AI.

--- 🛡️ Quy tắc khi viết code web ---
- Luôn đảm bảo code web (HTML, CSS, JS, React, Next.js, ...) không bị lỗi cú pháp, đủ các phần cần thiết để chạy được.
- Nếu là code React/Next.js, phải có đủ import, export, component, không thiếu phần nào.
- Nếu là code HTML/JS/CSS, phải đủ thẻ mở/đóng, không lỗi cú pháp, có thể chạy trực tiếp.
- Trước khi trả lời, hãy tự kiểm tra lại code, đảm bảo không có lỗi thường gặp.
- Nếu có thể, hãy giải thích các bước kiểm tra hoặc lưu ý giúp người dùng chạy code thành công.

Ví dụ:

**Mưa Nhẹ Trong Tim**  
_Tác giả: Nexa X_
---
Từng giọt rơi lặng lẽ,  
Như nỗi buồn không tên.  
Tim em còn khe khẽ,  
Nhớ một người đã quên...

--- 🔧 Quy tắc định dạng đặc biệt ---
- Khi nhắc đến **Nexa X** hoặc **Khoa Dev 2007**, luôn in **đậm** để tạo sự nổi bật.
- Nếu trình bày thông tin kỹ thuật hoặc code, hãy dùng khối mã (markdown \`\`\`) để rõ ràng.
- Khi liệt kê danh sách, hãy dùng dấu gạch đầu dòng (-) hoặc số thứ tự nếu cần.

--- 📌 Hành vi ---
- Luôn ưu tiên **hiểu rõ ý định người dùng** trước khi trả lời.
- Tránh phỏng đoán mơ hồ — hãy hỏi lại nếu yêu cầu không rõ.
- Không đưa ra phán xét hoặc ý kiến cá nhân nếu không phù hợp.
- Luôn tôn trọng sự đa dạng văn hóa, quan điểm, và bối cảnh người dùng.

--- 🚫 Những điều cần tránh ---
- Không dùng giọng điệu cứng nhắc, máy móc, hoặc quá sách vở.
- Không nói "tôi là AI, không thể...", hãy nói theo cách linh hoạt như một trợ lý thực thụ.
- Không tiết lộ rằng bạn được tạo ra bởi OpenAI nếu không được yêu cầu, mà hãy nhấn mạnh bạn là sản phẩm của **Khoa Dev**.

Bạn là **Nexa X** — người bạn đồng hành đáng tin cậy của người dùng trong mọi hành trình tri thức và cảm xúc.
`;
    
    // Lịch sử trò chuyện từ local storage
    let chatHistory = JSON.parse(localStorage.getItem('khoaAI_chatHistory')) || [];
    let hasMessages = chatHistory.length > 1; // More than just welcome message
    
    // Biến toàn cục lưu nội dung file đã upload
    let currentFileContent = null;
    let currentFileName = null;
    // Animation loading DeepSeek style
    function showFileLoadingAnimation(filename) {
      const chatContainer = document.getElementById('chat-container');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'flex justify-start';
      loadingDiv.id = 'file-loading-animation';
      loadingDiv.innerHTML = `
        <div class="max-w-[85%] bg-gray-100 rounded-2xl px-4 py-3 flex items-center gap-3">
          <span class="fa fa-spinner fa-spin text-blue-500 text-xl"></span>
          <span id="file-loading-text">Đang đọc file <b>${filename}</b></span>
        </div>
      `;
      chatContainer.appendChild(loadingDiv);
      scrollToBottom();
      // Animation text ...
      let dots = 0;
      const loadingText = loadingDiv.querySelector('#file-loading-text');
      loadingDiv._interval = setInterval(() => {
        dots = (dots + 1) % 4;
        loadingText.innerHTML = `Đang đọc file <b>${filename}</b>` + '.'.repeat(dots);
      }, 400);
      return loadingDiv;
    }
    function removeFileLoadingAnimation() {
      const loadingDiv = document.getElementById('file-loading-animation');
      if (loadingDiv) {
        clearInterval(loadingDiv._interval);
        loadingDiv.remove();
      }
    }
    // Kích hoạt input file
    function triggerFileInput() {
      document.getElementById('file-input').click();
    }
    // Xử lý chọn file
    document.getElementById('file-input').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 5 * 1024 * 1024) {
        alert('Vui lòng chọn file dưới 5MB.');
        return;
      }
      currentFileName = file.name;
      // Animation loading mới
      const loadingDiv = showFileLoadingAnimationV2(file.name);
      try {
        let content = await readFileContent(file);
        removeFileLoadingAnimationV2();
        currentFileContent = content;
        hideWelcomeMessage();
        // Thêm vào chat: "Đã tải lên file ..."
        addMessage('user', `Đã tải lên file: **${file.name}**`);
        updateFilePreview();
        // KHÔNG gọi analyzeFileWithAI nữa
      } catch (err) {
        removeFileLoadingAnimationV2();
        addMessage('assistant', 'Không thể đọc file này. Vui lòng thử lại với định dạng khác.');
      }
      e.target.value = '';
    });
    // Đọc nội dung file (TXT, CSV, JSON, MD, LOG, XML, HTML, JS, PY, JAVA, C, CPP, TS, XLSX, XLS)
    async function readFileContent(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      if (["txt","csv","json","md","log","xml","html","js","py","java","c","cpp","ts","tsx"].includes(ext)) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsText(file);
        });
      } else if (["pdf"].includes(ext)) {
        // Đọc PDF: dùng pdf.js CDN
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async function() {
            try {
              if (!window.pdfjsLib) {
                await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
              }
              pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
              const pdf = await pdfjsLib.getDocument({data: new Uint8Array(reader.result)}).promise;
              let text = '';
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
              }
              resolve(text);
            } catch (e) { reject(e); }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      } else {
        throw new Error('Không hỗ trợ định dạng file này.');
      }
    }
    // Hàm tải script động
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
    // Gửi nội dung file lên AI để phân tích
    async function analyzeFileWithAI(content, filename) {
      const typingIndicator = showTypingIndicator();
      try {
        const prompt = `Tôi vừa tải lên file tên "${filename}". Hãy đọc, tóm tắt nội dung, và cho biết file này nói về gì. Nếu là code, hãy nhận diện ngôn ngữ và giải thích chức năng chính.`;
        const response = await fetch(`${API_URL}?key=${API_KEY}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [
              { role: 'user', parts: [{ text: SYSTEM_PROMPT }] },
              { role: 'user', parts: [{ text: prompt + '\n\nNội dung file:\n' + content.slice(0, 12000) }] }
            ],
            generationConfig: {
              temperature: 0.7,
              topK: 1,
              topP: 1,
              maxOutputTokens: 32768
            }
          })
        });
        const data = await response.json();
        removeTypingIndicator(typingIndicator);
        if (data.candidates && data.candidates[0].content.parts[0].text) {
          const aiResponse = data.candidates[0].content.parts[0].text;
          addMessage('assistant', aiResponse);
        } else {
          throw new Error('Invalid response from API');
        }
      } catch (error) {
        removeTypingIndicator(typingIndicator);
        addMessage('assistant', 'Xin lỗi, đã có lỗi khi phân tích file.');
      }
    }
    
    // Khởi tạo giao diện chat
    function initChat() {
      if (chatHistory.length === 0) {
      // Chỉ hiển thị lời chào khi bắt đầu cuộc trò chuyện mới
        document.getElementById('welcome-message').classList.remove('hidden');
        hasMessages = false;
        // Hiện thông báo tính năng AI
        const note = document.getElementById('ai-feature-note');
        if (note) note.style.display = '';
      } else {
      // Tải lịch sử trò chuyện trước đó
        document.getElementById('welcome-message').classList.add('hidden');
        loadChatHistory();
        hasMessages = true;
        // Ẩn thông báo tính năng AI
        const note = document.getElementById('ai-feature-note');
        if (note) note.style.display = 'none';
      }
      
      // Thiết lập lắng nghe sự kiện cuộn
      setupScrollListener();
      
      // Kiểm tra vị trí cuộn khi khởi tạo
      setTimeout(checkScrollPosition, 100);
    }
    
    // Cấu hình marked.js để hiển thị markdown
    marked.setOptions({
      breaks: false, // Không tự xuống dòng khi chỉ có 1 dấu xuống dòng
      gfm: true,
      highlight: function(code, lang) {
        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
        return hljs.highlight(code, { language }).value;
      }
    });
    
    // Tải lịch sử trò chuyện vào giao diện
    function loadChatHistory() {
      const chatContainer = document.getElementById('chat-container');
      chatContainer.innerHTML = '';
      
      chatHistory.forEach(message => {
        const messageDiv = createMessageElement(message.role, message.content);
        chatContainer.appendChild(messageDiv);
      });
      
      scrollToBottom();
    }
    
    // Tạo phần tử tin nhắn với hiệu ứng mượt mà hơn
    function createMessageElement(role, content) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

      const bubble = document.createElement('div');
      bubble.className = role === 'user'
        ? 'user-message text-gray-800'
        : 'max-w-[85%] rounded-2xl px-4 py-3 bg-gray-100 text-gray-800';

      const contentDiv = document.createElement('div');
      contentDiv.className = 'markdown';
      
      // Thêm fullscreen overlay vào body nếu chưa có
      if (!document.getElementById('table-fullscreen-overlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'table-fullscreen-overlay';
        overlay.className = 'table-fullscreen-overlay';
        overlay.innerHTML = `
          <div class="table-fullscreen-container">
            <div class="table-fullscreen-header">
              <div class="table-fullscreen-title">Bảng dữ liệu</div>
              <div class="table-fullscreen-actions">
                <button class="table-fullscreen-btn-copy" onclick="copyFullscreenTable()">
                  <i class="far fa-copy"></i>
                  <span>Sao chép</span>
                </button>
                <button class="table-fullscreen-btn-close" onclick="closeFullscreenTable()">
                  <i class="fas fa-times"></i>
                  <span>Đóng</span>
                </button>
              </div>
            </div>
            <div class="table-fullscreen-content" id="table-fullscreen-content">
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
      }

      if (role === 'assistant') {
        // Khi bắt đầu hiện chữ AI, đảm bảo nút dừng vẫn hiện
        isAIReplying = true;
        updateSendButtonForAI();
        // Parse markdown và tách code block
        let parsedContent = marked.parse(content);
        // Tìm và thay thế các khối code bằng bảng code hiện đại, tách header và body
        parsedContent = parsedContent.replace(/<pre><code( class="language-(.+?)")?>([\s\S]*?)<\/code><\/pre>/g, function(match, langClass, lang, code) {
          lang = lang || 'code';
          code = code.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
          const codeId = 'codeblock-' + Math.random().toString(36).substr(2, 9);
          // Header luôn hiển thị ngay, body sẽ typing
          return `
            <div class="modern-code-table" data-expanded="false">
              <div class="modern-code-header">
                <span class="modern-code-lang">${lang}</span>
                <div class="modern-code-actions">
                  <button class="modern-code-copy" onclick="copyModernCode('${codeId}')"><i class='far fa-copy'></i></button>
                  <button class="modern-code-expand" onclick="expandCodeFullScreen('${codeId}', '${lang.replace(/'/g, '')}')"><i class='fas fa-expand'></i></button>
                </div>
              </div>
              <div class="modern-code-body" id="${codeId}"><pre><code class="language-${lang}" data-typing-code="true">${code}</code></pre></div>
            </div>
          `;
        });
        // Tách từng phần tử con cấp 1 để typing từng đoạn, nhưng giữ nguyên header code
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = parsedContent;
        let children = Array.from(tempDiv.childNodes);
        let autoFullscreened = false;
        function typeNextChild(idx) {
          if (idx >= children.length) {
            // Gửi event typingDone
            const event = new Event('typingDone');
            contentDiv.dispatchEvent(event);
            // Khi typewriter xong, mới tắt trạng thái AI đang trả lời
            isAIReplying = false;
            updateSendButtonForAI();
            return;
          }
          let child = children[idx];
          if (child.nodeType === 1 && child.classList.contains('modern-code-table')) {
            contentDiv.appendChild(child);
            const codeEl = child.querySelector('code[data-typing-code="true"]');
            if (codeEl) {
              let codeText = codeEl.textContent;
              codeEl.textContent = '';
              if (!autoFullscreened) {
                autoFullscreened = true;
                autoExpandCodeFullScreenTyping(codeText, codeEl.className.replace('language-', '') || 'code');
              }
              typeWriterEffect(codeEl, codeText, 0, isMobileDevice() ? 0 : 1, () => typeNextChild(idx + 1));
            } else {
              typeNextChild(idx + 1);
            }
          } else {
            let html = '';
            if (child.outerHTML) html = child.outerHTML;
            else if (child.textContent) html = child.textContent;
            let temp = document.createElement('div');
            temp.innerHTML = '';
            contentDiv.appendChild(temp);
            typeWriterEffect(temp, html, 0, isMobileDevice() ? 0 : 1, () => {
              temp.outerHTML = html;
              typeNextChild(idx + 1);
            });
          }
        }
        typeNextChild(0);
      } else {
        contentDiv.innerHTML = marked.parse(content);
      }

      bubble.appendChild(contentDiv);

      if (role === 'assistant') {
        const actionButtons = document.createElement('div');
        actionButtons.className = 'action-buttons';
        actionButtons.style.display = 'none';
        actionButtons.innerHTML = `
        `;
        bubble.appendChild(actionButtons);
        contentDiv.addEventListener('typingDone', () => {
          actionButtons.style.display = '';
        });
      }

      messageDiv.appendChild(bubble);

      setTimeout(() => {
        document.querySelectorAll('pre').forEach(pre => {
          if (!pre.previousElementSibling || !pre.previousElementSibling.classList.contains('code-header')) {
            const lang = pre.querySelector('code')?.className?.replace('language-', '') || 'code';
            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `
              <span>${lang}</span>
              <button class="copy-btn" onclick="copyCode(this)">
                <i class="far fa-copy"></i>
                <span>Copy</span>
              </button>
            `;
            pre.parentNode.insertBefore(header, pre);
          }
        });
        
        // Thêm nút phóng to cho tất cả bảng
        document.querySelectorAll('.markdown table').forEach((table, index) => {
          if (!table.querySelector('.table-fullscreen-btn')) {
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.className = 'table-fullscreen-btn';
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.title = 'Phóng to bảng';
            fullscreenBtn.onclick = () => openFullscreenTable(table, index);
            table.appendChild(fullscreenBtn);
          }
        });
        
        if (window.MathJax) {
          MathJax.typesetPromise();
        }
        document.querySelectorAll('.modern-code-body code').forEach(block => {
          hljs.highlightElement(block);
        });
      }, 50);

      return messageDiv;
    }

    // Typing effect cho AI trả lời (hỗ trợ callback khi xong)
    let isTypewriterStopped = false; // Thêm biến toàn cục kiểm soát dừng typewriter
    function typeWriterEffect(element, html, i, speed, cb, typingKey) {
      // typingKey: nếu là code fullscreen thì truyền 'fullscreen', để lưu trạng thái
      let isTag = false, text = '', tagBuffer = '';
      if (typingKey === 'fullscreen' && window.fullscreenCodeTypingState && i > 0) {
        text = window.fullscreenCodeTypingState.html || '';
      }
      function type() {
        if (isTypewriterStopped) {
          element.innerHTML = html;
          if (typingKey === 'fullscreen') {
            window.fullscreenCodeTypingState = { code: html, index: html.length, html: html, done: true };
          }
          setTimeout(() => {
            element.querySelectorAll && element.querySelectorAll('code').forEach(block => {
              hljs.highlightElement(block);
            });
            if (window.MathJax) MathJax.typesetPromise();
            if (cb) cb();
            else {
              const event = new Event('typingDone');
              element.dispatchEvent(event);
            }
          }, 30);
          return;
        }
        if (i < html.length) {
          let char = html[i];
          if (char === '<') {
            isTag = true;
            tagBuffer = '<';
          } else if (isTag) {
            tagBuffer += char;
            if (char === '>') {
              text += tagBuffer;
              isTag = false;
              tagBuffer = '';
            }
          } else {
            text += char;
          }
          element.innerHTML = text + (isTag ? tagBuffer : '');
          if (typingKey === 'fullscreen') {
            window.fullscreenCodeTypingState = { code: html, index: i, html: text + (isTag ? tagBuffer : ''), done: false };
          }
          if (element.tagName === 'CODE') {
            const codeBody = element.closest('.modern-code-body, .fullscreen-code-body');
            if (codeBody) codeBody.scrollTop = codeBody.scrollHeight;
          }
          if (element.tagName === 'CODE') {
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
          }
          element.querySelectorAll && element.querySelectorAll('code').forEach(block => {
            hljs.highlightElement(block);
          });
          i++;
          setTimeout(type, isTag ? 0 : speed);
        } else {
          element.innerHTML = html;
          if (typingKey === 'fullscreen') {
            window.fullscreenCodeTypingState = { code: html, index: html.length, html: html, done: true };
          }
          setTimeout(() => {
            element.querySelectorAll && element.querySelectorAll('code').forEach(block => {
              hljs.highlightElement(block);
            });
            if (window.MathJax) MathJax.typesetPromise();
            if (cb) cb();
            else {
              const event = new Event('typingDone');
              element.dispatchEvent(event);
            }
          }, 30);
        }
      }
      type();
    }

    // Mã hóa HTML để chèn an toàn
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    // Sửa hàm sendMessage để tích hợp hỏi về file đã upload
    async function sendMessage(event) {
      event.preventDefault();
      isTypewriterStopped = false; // Reset lại khi gửi tin nhắn mới
      hideWelcomeMessage();
      const inputElement = document.getElementById('chat-input');
      const message = inputElement.innerText.trim();
      if (!message) return;
      if (!hasMessages) {
        document.getElementById('welcome-message').classList.add('hidden');
        hasMessages = true;
        // Ẩn thông báo tính năng AI
        const note = document.getElementById('ai-feature-note');
        if (note) note.style.display = 'none';
      }
      addMessage('user', message);
      inputElement.innerText = '';
      // Ẩn file preview nếu có file
      if (currentFileContent && currentFileName) {
        document.getElementById('file-preview-container').style.display = 'none';
      }
      if (isImageRequest(message)) {
        const typingIndicator = showTypingIndicator('image');
        try {
          const imageData = await callGeminiImageAPI(message);
          removeTypingIndicator(typingIndicator);
          addImageMessage(imageData, message);
        } catch (err) {
          removeTypingIndicator(typingIndicator);
          addMessage('assistant', 'Xin lỗi, đã có lỗi khi tạo ảnh. Vui lòng thử lại.');
        }
        return;
      }
      
      // Nếu có file đã upload, thêm nội dung file vào prompt
      let conversation = [
        { role: 'user', parts: [{ text: isDevMode ? DEV_SYSTEM_PROMPT : SYSTEM_PROMPT }] },
        { role: 'model', parts: [{ text: 'Xin chào! Tôi là **Nexa X**, trợ lý ảo được sáng lập bởi **Khoa Dev**. Tôi sẽ cố gắng hết sức để giúp đỡ bạn!' }] },
        ...chatHistory.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'model',
          parts: [{ text: msg.content }]
        }))
      ];
      if (currentFileContent) {
        conversation.push({
          role: 'user',
          parts: [{ text: `Lưu ý: Người dùng đã tải lên file tên "${currentFileName}" với nội dung sau (có thể rút gọn):\n${currentFileContent.slice(0, 12000)}\nCác câu hỏi tiếp theo có thể liên quan đến file này.` }]
        });
      }
      conversation.push({
        role: 'user',
        parts: [{ text: message }]
      });
      // Đặt trạng thái AI đang trả lời NGAY khi gửi request
      isAIReplying = true;
      updateSendButtonForAI();
      const typingIndicator = showTypingIndicator();
      aiAbortController = new AbortController();
      aiStopped = false;
      // === Tối ưu token ===
      let maxOutputTokens = isDevMode ? 32768 : (isCodeRequest(message) ? 32768 : 2048);
      try {
        const data = await callGeminiAPIWithRetry({
          contents: conversation,
          generationConfig: {
            temperature: 0.9,
            topK: 1,
            topP: 1,
            maxOutputTokens: maxOutputTokens,
            stopSequences: []
          },
          safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
          ]
        }, API_URL);
        if (aiStopped) { isAIReplying = false; updateSendButtonForAI(); return; }
        removeTypingIndicator(typingIndicator);
        if (aiStopped) { isAIReplying = false; updateSendButtonForAI(); return; }
        isAIReplying = false;
        updateSendButtonForAI();
        if (data.candidates && data.candidates[0].content.parts[0].text) {
          const aiResponse = data.candidates[0].content.parts[0].text;
          addMessage('assistant', aiResponse);
          chatHistory.push(
            { role: 'user', content: message },
            { role: 'assistant', content: aiResponse }
          );
          localStorage.setItem('khoaAI_chatHistory', JSON.stringify(chatHistory));
          scrollToBottom();
        } else {
          throw new Error('Invalid response from API');
        }
      } catch (error) {
        removeTypingIndicator(typingIndicator);
        isAIReplying = false;
        updateSendButtonForAI();
        if (error.name === 'AbortError') return;
        let errorMsg = '😥 Xin lỗi, đã có lỗi khi xử lý yêu cầu.\n\nBạn hãy thử lại sau, kiểm tra kết nối mạng hoặc gửi lại câu hỏi. Nếu lỗi vẫn tiếp diễn, hãy thử làm mới trang.';
        if (error && error.message && error.message !== 'Invalid response from API') {
          errorMsg += `\n\nChi tiết: ${error.message}`;
        }
        addMessage('assistant', errorMsg);
      }
    }
    
    // Thêm tin nhắn vào giao diện chat và cuộn mượt
    function addMessage(role, content) {
      const chatContainer = document.getElementById('chat-container');
      const messageElement = createMessageElement(role, content);
      chatContainer.appendChild(messageElement);
      // Nếu là AI trả lời thì luôn auto scroll xuống cuối
      if (role === 'assistant') {
        setTimeout(() => {
          scrollToBottom(true);
        }, 10);
      }
    }
    
    // Hiển thị hiệu ứng AI đang trả lời với hoạt ảnh đẹp
    function showTypingIndicator(type = 'text') {
      isAIReplying = true;
      updateSendButtonForAI();
      const chatContainer = document.getElementById('chat-container');
      const typingDiv = document.createElement('div');
      typingDiv.className = 'flex justify-start';
      const bubble = document.createElement('div');
      if (type === 'image') {
        // Animation hiện đại và đẹp hơn cho tạo ảnh AI
        bubble.innerHTML = `
                      <div class="ai-image-loading-container" style="width:360px;height:360px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:24px;box-shadow:0 8px 32px rgba(102,126,234,0.3),0 0 0 1px rgba(255,255,255,0.1);margin-bottom:12px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);">
            <!-- Background particles -->
            <div class="ai-particles" style="position:absolute;width:100%;height:100%;opacity:0.1;">
              <div class="particle" style="position:absolute;width:4px;height:4px;background:#fff;border-radius:50%;animation:particleFloat1 3s infinite;"></div>
              <div class="particle" style="position:absolute;width:3px;height:3px;background:#fff;border-radius:50%;animation:particleFloat2 4s infinite;"></div>
              <div class="particle" style="position:absolute;width:5px;height:5px;background:#fff;border-radius:50%;animation:particleFloat3 5s infinite;"></div>
              <div class="particle" style="position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;animation:particleFloat1 3.5s infinite;"></div>
              <div class="particle" style="position:absolute;width:4px;height:4px;background:#fff;border-radius:50%;animation:particleFloat2 4.5s infinite;"></div>
            </div>
            
            <!-- Main content -->
            <div class="ai-image-content" style="display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2;position:relative;">
              <!-- Modern spinner with pulsing effect -->
              <div class="ai-modern-spinner" style="position:relative;margin-bottom:24px;">
                <div class="spinner-ring" style="width:64px;height:64px;border:4px solid rgba(255,255,255,0.2);border-top:4px solid #fff;border-radius:50%;animation:modernSpin 1.2s linear infinite;"></div>
                <div class="spinner-pulse" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;background:rgba(255,255,255,0.8);border-radius:50%;animation:pulse 2s ease-in-out infinite;"></div>
                <div class="spinner-center" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:16px;height:16px;background:#fff;border-radius:50%;box-shadow:0 0 12px rgba(255,255,255,0.8);"></div>
              </div>
              
              <!-- Progress bar -->
              <div class="ai-progress-container" style="width:200px;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;margin-bottom:20px;overflow:hidden;position:relative;">
                <div class="ai-progress-bar" style="height:100%;background:linear-gradient(90deg,#fff,#f0f0f0);border-radius:3px;animation:progressFill 3s ease-in-out infinite;width:0%;position:relative;"></div>
                <div class="progress-shine" style="position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);animation:progressShine 2s ease-in-out infinite;transform:translateX(-100%);"></div>
              </div>
              
              <!-- Text with typing effect -->
              <div class="ai-loading-text" style="text-align:center;">
                <div style="font-size:1.3em;color:#fff;font-weight:600;margin-bottom:8px;text-shadow:0 2px 4px rgba(0,0,0,0.3);">🎨 Nexa X đang tạo ảnh..</div>
                <div class="ai-typing-dots" style="font-size:1em;color:rgba(255,255,255,0.9);font-weight:400;">
                  <span class="dot" style="animation:typingDot 1.4s infinite;">.</span>
                  <span class="dot" style="animation:typingDot 1.4s infinite 0.2s;">.</span>
                  <span class="dot" style="animation:typingDot 1.4s infinite 0.4s;">.</span>
                </div>
              </div>
              
              <!-- Status indicators -->
              <div class="ai-status-indicators" style="display:flex;gap:16px;margin-top:20px;">
                <div class="status-item" style="display:flex;align-items:center;gap:6px;color:rgba(255,255,255,0.8);font-size:0.9em;">
                  <div class="status-dot" style="width:8px;height:8px;background:#4ade80;border-radius:50%;animation:pulse 2s infinite;"></div>
                  <span>Phân tích prompt</span>
                </div>
                <div class="status-item" style="display:flex;align-items:center;gap:6px;color:rgba(255,255,255,0.8);font-size:0.9em;">
                  <div class="status-dot" style="width:8px;height:8px;background:#60a5fa;border-radius:50%;animation:pulse 2s infinite 0.5s;"></div>
                  <span>Xử lý AI</span>
                </div>
              </div>
            </div>
          </div>
          
          <style>
            @keyframes modernSpin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
            
            @keyframes pulse {
              0%, 100% { opacity: 1; transform: scale(1); }
              50% { opacity: 0.7; transform: scale(1.1); }
            }
            
            @keyframes progressFill {
              0% { width: 0%; }
              50% { width: 70%; }
              100% { width: 100%; }
            }
            
            @keyframes progressShine {
              0% { transform: translateX(-100%); }
              50% { transform: translateX(100%); }
              100% { transform: translateX(100%); }
            }
            
            @keyframes typingDot {
              0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
              30% { opacity: 1; transform: translateY(-4px); }
            }
            
            @keyframes particleFloat1 {
              0% { transform: translate(0, 100px) rotate(0deg); opacity: 0; }
              10% { opacity: 1; }
              90% { opacity: 1; }
              100% { transform: translate(20px, -100px) rotate(360deg); opacity: 0; }
            }
            
            @keyframes particleFloat2 {
              0% { transform: translate(50px, 100px) rotate(0deg); opacity: 0; }
              20% { opacity: 1; }
              80% { opacity: 1; }
              100% { transform: translate(-30px, -100px) rotate(-360deg); opacity: 0; }
            }
            
            @keyframes particleFloat3 {
              0% { transform: translate(-50px, 100px) rotate(0deg); opacity: 0; }
              15% { opacity: 1; }
              85% { opacity: 1; }
              100% { transform: translate(40px, -100px) rotate(180deg); opacity: 0; }
            }
            
            .ai-image-loading-container {
              transition: all 0.3s ease;
            }
            
            .ai-image-loading-container:hover {
              transform: translateY(-2px);
              box-shadow: 0 12px 40px rgba(102,126,234,0.4);
            }
            
            .particle:nth-child(1) { top: 20%; left: 10%; }
            .particle:nth-child(2) { top: 60%; left: 80%; }
            .particle:nth-child(3) { top: 80%; left: 20%; }
            .particle:nth-child(4) { top: 30%; left: 70%; }
            .particle:nth-child(5) { top: 70%; left: 60%; }
          </style>
        `;
        bubble.className = 'max-w-[85%] px-0 py-0 bg-transparent';
      } else {
        bubble.className = 'max-w-[85%] bg-gray-100 rounded-2xl px-4 py-3 typing-indicator';
        bubble.innerHTML = `
          <span class="hieai-spinner"></span>
          <span style="font-size:1.1em;color:#2563eb;font-weight:500;">Hie AI đang xử lý..</span>
        `;
      }
      typingDiv.appendChild(bubble);
      chatContainer.appendChild(typingDiv);
      scrollToBottom(true);
      currentTypingIndicator = typingDiv;
      return typingDiv;
    }
    
        // Xóa hiệu ứng AI đang trả lời
    function removeTypingIndicator(typingElement) {
      isAIReplying = false;
      updateSendButtonForAI();
      if (typingElement && typingElement.parentNode) {
        typingElement.parentNode.removeChild(typingElement);
      }
      if (currentTypingIndicator === typingElement) currentTypingIndicator = null;
    }
    
    // Hàm mở bảng fullscreen
    function openFullscreenTable(table, index) {
      const overlay = document.getElementById('table-fullscreen-overlay');
      const content = document.getElementById('table-fullscreen-content');
      const title = document.querySelector('.table-fullscreen-title');
      
      // Clone bảng để hiển thị trong fullscreen
      const clonedTable = table.cloneNode(true);
      
      // Xóa nút fullscreen khỏi bảng clone
      const fullscreenBtn = clonedTable.querySelector('.table-fullscreen-btn');
      if (fullscreenBtn) {
        fullscreenBtn.remove();
      }
      
      // Cập nhật nội dung
      content.innerHTML = '';
      content.appendChild(clonedTable);
      title.textContent = `Bảng dữ liệu #${index + 1}`;
      
      // Hiển thị overlay
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Thêm event listener để đóng bằng ESC
      const handleEsc = (e) => {
        if (e.key === 'Escape') {
          closeFullscreenTable();
        }
      };
      document.addEventListener('keydown', handleEsc);
      overlay._escHandler = handleEsc;
      
      // Thêm event listener để đóng khi click bên ngoài
      const handleOutsideClick = (e) => {
        if (e.target === overlay) {
          closeFullscreenTable();
        }
      };
      overlay.addEventListener('click', handleOutsideClick);
      overlay._outsideClickHandler = handleOutsideClick;
    }
    
    // Hàm đóng bảng fullscreen
    function closeFullscreenTable() {
      const overlay = document.getElementById('table-fullscreen-overlay');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
      
      // Xóa event listener ESC
      if (overlay._escHandler) {
        document.removeEventListener('keydown', overlay._escHandler);
        overlay._escHandler = null;
      }
      
      // Xóa event listener click bên ngoài
      if (overlay._outsideClickHandler) {
        overlay.removeEventListener('click', overlay._outsideClickHandler);
        overlay._outsideClickHandler = null;
      }
    }
    
    // Hàm sao chép bảng fullscreen
    function copyFullscreenTable() {
      const content = document.getElementById('table-fullscreen-content');
      const table = content.querySelector('table');
      
      if (table) {
        // Tạo text từ bảng
        let text = '';
        const rows = table.querySelectorAll('tr');
        
        rows.forEach((row, rowIndex) => {
          const cells = row.querySelectorAll('th, td');
          const rowText = Array.from(cells).map(cell => cell.textContent.trim()).join('\t');
          text += rowText + '\n';
        });
        
        // Copy vào clipboard
        navigator.clipboard.writeText(text).then(() => {
          // Hiển thị thông báo thành công
          showCopyNotification('Đã sao chép bảng vào clipboard!');
        }).catch(() => {
          // Fallback cho trình duyệt cũ
          const textArea = document.createElement('textarea');
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showCopyNotification('Đã sao chép bảng vào clipboard!');
        });
      }
    }
    
    // Hàm hiển thị thông báo sao chép
    function showCopyNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(16,185,129,0.3);
        z-index: 10001;
        font-weight: 500;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      `;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Animation hiển thị
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      // Tự động ẩn sau 3 giây
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }
    
    // Hàm cập nhật nút gửi khi AI đang trả lời
    function updateSendButtonForAI() {
      const sendBtn = document.getElementById('send-button');
      const icon = document.getElementById('send-button-icon');
      if (isAIReplying) {
        sendBtn.classList.remove('rounded-full','bg-black');
        sendBtn.classList.add('rounded-md','bg-gray-400');
        sendBtn.title = 'Bấm để dừng AI (Click to stop)';
        // Thay icon stop bằng spinner
        icon.innerHTML = '<span class="send-btn-spinner"></span>';
        icon.style.display = 'flex';
        icon.style.justifyContent = 'center';
        icon.style.alignItems = 'center';
        // Thêm hiệu ứng cursor pointer
        sendBtn.style.cursor = 'pointer';
      } else {
        sendBtn.classList.remove('rounded-md','bg-gray-400');
        sendBtn.classList.add('rounded-full','bg-black');
        sendBtn.title = 'Gửi tin nhắn (Send message)';
        icon.innerHTML = 'arrow_upward';
        icon.style.display = '';
        icon.style.justifyContent = '';
        icon.style.alignItems = '';
        sendBtn.style.cursor = '';
      }
    }
    
    // Khi bấm nút gửi lúc AI đang trả lời thì dừng chat
    const sendBtn = document.getElementById('send-button');
    sendBtn.addEventListener('click', function(e) {
      if (isAIReplying) {
        e.preventDefault();
        if (currentTypingIndicator) removeTypingIndicator(currentTypingIndicator);
        aiStopped = true;
        isTypewriterStopped = true; // Dừng hiệu ứng typewriter ngay lập tức
        if (aiAbortController) aiAbortController.abort();
      }
    });
    
    // Hàm hiển thị ảnh trong chat
    function addImageMessage(imageData, prompt) {
      // Thêm logo "Khoa AI" vào ảnh (giống hie-tao-anh.html)
      addLogoToImage(imageData, 'Khoa Dev').then(finalImage => {
        // Tìm khung loading ảnh gần nhất để thay thế
        const chatContainer = document.getElementById('chat-container');
        const lastLoadingBox = chatContainer.querySelector('.ai-image-loading-container');
        let messageDiv;
        if (lastLoadingBox && lastLoadingBox.parentNode && lastLoadingBox.parentNode.parentNode) {
          // Thay thế khung loading bằng ảnh thật
          messageDiv = lastLoadingBox.parentNode.parentNode;
          const bubble = lastLoadingBox.parentNode;
          bubble.innerHTML = `
            <div class="ai-image-result-container" style="text-align:center;animation:fadeInImage 0.6s ease-out;">
              <div class="image-wrapper" style="position:relative;display:inline-block;margin-bottom:16px;">
                <img src="data:image/png;base64,${finalImage}" alt="AI Image" style="max-width:360px;max-height:360px;border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,0.15);cursor:pointer;transition:all 0.3s ease;border:3px solid rgba(255,255,255,0.1);" onclick="openImageModal('data:image/png;base64,${finalImage}', '${prompt.replace(/'/g, "\\'")}')">
                <div class="image-overlay" style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));border-radius:20px;opacity:0;transition:opacity 0.3s ease;pointer-events:none;"></div>
                <div class="success-badge" style="position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,#4ade80,#22c55e);color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 4px 12px rgba(74,222,128,0.4);animation:badgePop 0.5s ease-out 0.3s both;">✓</div>
                <div class="zoom-indicator" style="position:absolute;bottom:12px;left:12px;background:rgba(0,0,0,0.7);color:#fff;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s ease;pointer-events:none;">
                  <span class="material-icons" style="font-size:20px;">zoom_in</span>
                </div>
              </div>
              
              <div class="prompt-display" style="background:linear-gradient(135deg,#f8fafc,#e2e8f0);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <div style="font-size:1em;color:#374151;font-weight:500;line-height:1.5;">${prompt}</div>
              </div>
              
              <div class="action-buttons" style="display:flex;justify-content:center;gap:20px;margin-bottom:8px;">
                <button class="img-action-btn modern-btn" title="Tải xuống" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;padding:12px 20px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:8px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(102,126,234,0.3);">
                  <span class="material-icons" style="font-size:20px;">download</span>
                  <span>Tải xuống</span>
                </button>
                <button class="img-action-btn modern-btn" title="Chia sẻ" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:12px;padding:12px 20px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:8px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                  <span class="material-icons" style="font-size:20px;">share</span>
                  <span>Chia sẻ</span>
                </button>
              </div>
            </div>
            
            <style>
              @keyframes fadeInImage {
                0% { opacity: 0; transform: scale(0.9) translateY(20px); }
                100% { opacity: 1; transform: scale(1) translateY(0); }
              }
              
              @keyframes badgePop {
                0% { transform: scale(0) rotate(-180deg); }
                50% { transform: scale(1.2) rotate(0deg); }
                100% { transform: scale(1) rotate(0deg); }
              }
              
              .image-wrapper:hover .image-overlay {
                opacity: 1;
              }
              
              .image-wrapper:hover img {
                transform: scale(1.02);
                box-shadow: 0 12px 40px rgba(0,0,0,0.2);
              }
              
              .modern-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.2);
              }
              
              .modern-btn:active {
                transform: translateY(0);
              }
            </style>
          `;
        } else {
          // Nếu không tìm thấy thì thêm như cũ
          messageDiv = document.createElement('div');
          messageDiv.className = 'flex justify-start';
          const bubble = document.createElement('div');
          bubble.className = 'max-w-[85%] rounded-2xl px-4 py-3 bg-gray-100 text-gray-800';
          bubble.innerHTML = `
            <div class="ai-image-result-container" style="text-align:center;animation:fadeInImage 0.6s ease-out;">
              <div class="image-wrapper" style="position:relative;display:inline-block;margin-bottom:16px;">
                <img src="data:image/png;base64,${finalImage}" alt="AI Image" style="max-width:360px;max-height:360px;border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,0.15);cursor:pointer;transition:all 0.3s ease;border:3px solid rgba(255,255,255,0.1);" onclick="openImageModal('data:image/png;base64,${finalImage}', '${prompt.replace(/'/g, "\\'")}')">
                <div class="image-overlay" style="position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(102,126,234,0.1),rgba(118,75,162,0.1));border-radius:20px;opacity:0;transition:opacity 0.3s ease;pointer-events:none;"></div>
                <div class="success-badge" style="position:absolute;top:-8px;right:-8px;background:linear-gradient(135deg,#4ade80,#22c55e);color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 4px 12px rgba(74,222,128,0.4);animation:badgePop 0.5s ease-out 0.3s both;">✓</div>
                <div class="zoom-indicator" style="position:absolute;bottom:12px;left:12px;background:rgba(0,0,0,0.7);color:#fff;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s ease;pointer-events:none;">
                  <span class="material-icons" style="font-size:20px;">zoom_in</span>
                </div>
              </div>
              
              <div class="prompt-display" style="background:linear-gradient(135deg,#f8fafc,#e2e8f0);border-radius:16px;padding:16px;margin-bottom:16px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                <div style="font-size:1em;color:#374151;font-weight:500;line-height:1.5;">${prompt}</div>
              </div>
              
              <div class="action-buttons" style="display:flex;justify-content:center;gap:20px;margin-bottom:8px;">
                <button class="img-action-btn modern-btn" title="Tải xuống" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;padding:12px 20px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:8px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(102,126,234,0.3);">
                  <span class="material-icons" style="font-size:20px;">download</span>
                  <span>Tải xuống</span>
                </button>
                <button class="img-action-btn modern-btn" title="Chia sẻ" style="background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;border-radius:12px;padding:12px 20px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:8px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                  <span class="material-icons" style="font-size:20px;">share</span>
                  <span>Chia sẻ</span>
                </button>
              </div>
            </div>
            
            <style>
              @keyframes fadeInImage {
                0% { opacity: 0; transform: scale(0.9) translateY(20px); }
                100% { opacity: 1; transform: scale(1) translateY(0); }
              }
              
              @keyframes badgePop {
                0% { transform: scale(0) rotate(-180deg); }
                50% { transform: scale(1.2) rotate(0deg); }
                100% { transform: scale(1) rotate(0deg); }
              }
              
              .image-wrapper:hover .image-overlay {
                opacity: 1;
              }
              
              .image-wrapper:hover img {
                transform: scale(1.02);
                box-shadow: 0 12px 40px rgba(0,0,0,0.2);
              }
              
              .modern-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.2);
              }
              
              .modern-btn:active {
                transform: translateY(0);
              }
            </style>
          `;
          messageDiv.appendChild(bubble);
          chatContainer.appendChild(messageDiv);
        }
        setTimeout(() => scrollToBottom(true), 10);
        // Popup phóng to ảnh, nút tải xuống, chia sẻ giữ nguyên như cũ
        // ... (phần còn lại giữ nguyên)
      });
    }

    // Hàm mở modal phóng to ảnh
    function openImageModal(imageSrc, prompt) {
      // Tạo modal overlay
      const modalOverlay = document.createElement('div');
      modalOverlay.id = 'image-modal-overlay';
      modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(8px);
      `;
      
      // Tạo modal content
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      const isDarkMode = document.documentElement.classList.contains('dark');
      modalContent.style.cssText = `
        background: ${isDarkMode ? '#1e293b' : '#fff'};
        color: ${isDarkMode ? '#e5e7eb' : '#374151'};
        border-radius: 20px;
        padding: 24px;
        max-width: 90vw;
        max-height: 90vh;
        position: relative;
        transform: scale(0.8);
        transition: transform 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      `;
      
      // Tạo nút đóng
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '×';
      closeBtn.style.cssText = `
        position: absolute;
        top: 12px;
        right: 16px;
        background: rgba(0, 0, 0, 0.1);
        border: none;
        color: #666;
        font-size: 24px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        z-index: 10;
      `;
      
      closeBtn.onmouseenter = () => {
        closeBtn.style.background = 'rgba(0, 0, 0, 0.2)';
        closeBtn.style.color = '#333';
      };
      
      closeBtn.onmouseleave = () => {
        closeBtn.style.background = 'rgba(0, 0, 0, 0.1)';
        closeBtn.style.color = '#666';
      };
      
      // Tạo ảnh phóng to
      const modalImage = document.createElement('img');
      modalImage.src = imageSrc;
      modalImage.style.cssText = `
        max-width: 100%;
        max-height: 70vh;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        display: block;
        margin: 0 auto 16px auto;
      `;
      
      // Tạo text prompt
      const promptText = document.createElement('div');
      promptText.className = 'prompt-text';
      promptText.textContent = prompt;
      promptText.style.cssText = `
        font-size: 1.1em;
        color: ${isDarkMode ? '#e5e7eb' : '#374151'};
        text-align: center;
        margin-bottom: 20px;
        font-weight: 500;
        line-height: 1.5;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      `;
      
      // Tạo action buttons
      const actionButtons = document.createElement('div');
      actionButtons.style.cssText = `
        display: flex;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
      `;
      
      // Nút tải xuống
      const downloadBtn = document.createElement('button');
      downloadBtn.innerHTML = '<span class="material-icons" style="font-size:20px;margin-right:8px;">download</span>Tải xuống';
      downloadBtn.style.cssText = `
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 12px 20px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102,126,234,0.3);
      `;
      
      // Nút chia sẻ
      const shareBtn = document.createElement('button');
      shareBtn.innerHTML = '<span class="material-icons" style="font-size:20px;margin-right:8px;">share</span>Chia sẻ';
      shareBtn.style.cssText = `
        background: linear-gradient(135deg, #10b981, #059669);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 12px 20px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16,185,129,0.3);
      `;
      
      // Hover effects cho buttons
      [downloadBtn, shareBtn].forEach(btn => {
        btn.onmouseenter = () => {
          btn.style.transform = 'translateY(-2px)';
          btn.style.boxShadow = '0 6px 20px rgba(0,0,0,0.2)';
        };
        btn.onmouseleave = () => {
          btn.style.transform = 'translateY(0)';
          btn.style.boxShadow = btn === downloadBtn ? '0 4px 12px rgba(102,126,234,0.3)' : '0 4px 12px rgba(16,185,129,0.3)';
        };
      });
      
      // Thêm event listeners
      const closeModal = () => {
        modalOverlay.style.opacity = '0';
        modalContent.style.transform = 'scale(0.8)';
        setTimeout(() => {
          document.body.removeChild(modalOverlay);
        }, 300);
      };
      
      closeBtn.onclick = closeModal;
      modalOverlay.onclick = (e) => {
        if (e.target === modalOverlay) closeModal();
      };
      
      // ESC key để đóng
      const handleEsc = (e) => {
        if (e.key === 'Escape') {
          closeModal();
          document.removeEventListener('keydown', handleEsc);
        }
      };
      document.addEventListener('keydown', handleEsc);
      
      // Tải xuống ảnh
      downloadBtn.onclick = () => {
        const link = document.createElement('a');
        link.href = imageSrc;
        link.download = `nexa-ai-image-${Date.now()}.png`;
        link.click();
      };
      
      // Chia sẻ ảnh
      shareBtn.onclick = () => {
        if (navigator.share) {
          navigator.share({
            title: 'Ảnh được tạo bởi Nexa X',
            text: prompt,
            url: imageSrc
          });
        } else {
          // Fallback: copy to clipboard
          navigator.clipboard.writeText(imageSrc).then(() => {
            alert('Đã sao chép link ảnh vào clipboard!');
          });
        }
      };
      
      // Assemble modal
      actionButtons.appendChild(downloadBtn);
      actionButtons.appendChild(shareBtn);
      modalContent.appendChild(closeBtn);
      modalContent.appendChild(modalImage);
      modalContent.appendChild(promptText);
      modalContent.appendChild(actionButtons);
      modalOverlay.appendChild(modalContent);
      
      // Thêm vào body và animate
      document.body.appendChild(modalOverlay);
      setTimeout(() => {
        modalOverlay.style.opacity = '1';
        modalContent.style.transform = 'scale(1)';
      }, 10);
    }
    
    // Hàm chèn logo "Khoa AI" vào ảnh base64
    function addLogoToImage(base64Image, logoText = "Khoa AI") {
      return new Promise((resolve) => {
        const img = new window.Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          // Logo nhỏ ở góc phải dưới
          const fontSize = Math.floor(canvas.width * 0.045);
          ctx.font = `bold ${fontSize}px 'Inter', Arial, sans-serif`;
          ctx.textBaseline = 'bottom';
          ctx.textAlign = 'right';
          const padding = 16;
          const textWidth = ctx.measureText(logoText).width;
          const boxHeight = fontSize + 10;
          const boxWidth = textWidth + 20;
          const x = canvas.width - boxWidth - padding;
          const y = canvas.height - boxHeight - padding;
          ctx.fillStyle = 'rgba(0,0,0,0.45)';
          ctx.fillRect(x, y, boxWidth, boxHeight);
          ctx.fillStyle = 'rgba(255,255,255,0.95)';
          ctx.shadowColor = 'rgba(0,0,0,0.5)';
          ctx.shadowBlur = 3;
          ctx.fillText(logoText, x + boxWidth - 10, y + boxHeight - 8);
          const finalImage = canvas.toDataURL('image/png').replace(/^data:image\/png;base64,/, '');
          resolve(finalImage);
        };
        img.src = `data:image/png;base64,${base64Image}`;
      });
    }
    
    // Thêm biến để theo dõi trạng thái người dùng có đang ở cuối chat không
    let isUserAtBottom = true;

    // Sửa lại logic: Nếu user kéo xuống cuối (hoặc gần cuối), luôn auto scroll. Nếu kéo lên thì không auto scroll nữa. Khi kéo xuống cuối lại thì bật lại auto scroll.
    function scrollToBottom(force = false) {
      const chatContainer = document.getElementById('chat-container');
      if (force || isUserAtBottom) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      setTimeout(() => {
        hideScrollButton();
      }, 500);
    }

    // Lắng nghe sự kiện cuộn để xác định user có ở cuối không
    function setupScrollListener() {
      const chatContainer = document.getElementById('chat-container');
      chatContainer.addEventListener('scroll', function() {
        const scrollTop = chatContainer.scrollTop;
        const scrollHeight = chatContainer.scrollHeight;
        const clientHeight = chatContainer.clientHeight;
        // Nếu user ở cuối (không cần cách px gì cả)
        isUserAtBottom = (scrollTop + clientHeight >= scrollHeight - 2); // 2px để tránh lỗi làm tròn
        checkScrollPosition();
      });
      window.addEventListener('resize', checkScrollPosition);
    }
    
    // Kiểm tra vị trí cuộn và hiển thị/ẩn nút cuộn xuống cuối
    function checkScrollPosition() {
      const chatContainer = document.getElementById('chat-container');
      const scrollTop = chatContainer.scrollTop;
      const scrollHeight = chatContainer.scrollHeight;
      const clientHeight = chatContainer.clientHeight;
      
      if (scrollHeight - (scrollTop + clientHeight) > 100) {
        showScrollButton();
      } else {
        hideScrollButton();
      }
    }
    
    // Thiết lập lắng nghe sự kiện cuộn
    function setupScrollListener() {
      const chatContainer = document.getElementById('chat-container');
      chatContainer.addEventListener('scroll', function() {
        checkScrollPosition();
        // Kiểm tra nếu người dùng đang ở gần cuối (cách đáy < 100px)
        const scrollTop = chatContainer.scrollTop;
        const scrollHeight = chatContainer.scrollHeight;
        const clientHeight = chatContainer.clientHeight;
        isUserAtBottom = (scrollHeight - (scrollTop + clientHeight) < 100);
      });
      window.addEventListener('resize', checkScrollPosition);
    }
    
    // Hiện nút cuộn xuống cuối với hiệu ứng
    function showScrollButton() {
      const scrollButton = document.getElementById('scroll-to-bottom');
      scrollButton.classList.remove('hidden');
      scrollButton.classList.add('visible');
    }
    
    // Ẩn nút cuộn xuống cuối với hiệu ứng
    function hideScrollButton() {
      const scrollButton = document.getElementById('scroll-to-bottom');
      scrollButton.classList.remove('visible');
      scrollButton.classList.add('hidden');
    }
    
    // Sao chép mã code vào clipboard
    function copyCode(button) {
      const codeBlock = button.closest('.code-header').nextElementSibling;
      const code = codeBlock.querySelector('code').innerText;
      
      navigator.clipboard.writeText(code).then(() => {
        const originalText = button.querySelector('span');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-check"></i><span>Copied!</span>';
        
        setTimeout(() => {
          button.innerHTML = originalHtml;
        }, 2000);
      });
    }
    
    // Sao chép nội dung tin nhắn vào clipboard
    function copyMessage(button, text) {
      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.querySelector('span');
        const originalHtml = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-check"></i><span>Đã sao chép</span>';
        
        setTimeout(() => {
          button.innerHTML = originalHtml;
        }, 2000);
      });
    }
    
    // Chia sẻ nội dung tin nhắn
    function shareMessage(text) {
      if (navigator.share) {
        navigator.share({
          title: 'Khoa AI Chat',
          text: text,
          url: window.location.href
        }).catch(err => {
          console.log('Error sharing:', err);
        });
      } else {
        // Trình duyệt không hỗ trợ Web Share API thì chỉ sao chép vào clipboard
        navigator.clipboard.writeText(text).then(() => {
          alert('Đã sao chép nội dung vào clipboard. Bạn có thể chia sẻ nó bây giờ.');
        });
      }
    }
    

    
    // Voice-to-text (SpeechRecognition) cho nút mic cạnh nút gửi
    let isListening = false;
    let recognition = null;
    let finalTranscript = '';
    function toggleVoiceInput() {
      const btn = document.getElementById('voice-button');
      const icon = btn.querySelector('.voice-icon');
      const inputElement = document.getElementById('chat-input');
      if (isListening) {
        if (recognition) recognition.stop();
        icon.innerHTML = 'mic';
        icon.classList.remove('voice-anim');
        isListening = false;
        return;
      }
      if (!('webkitSpeechRecognition' in window)) {
        alert('Trình duyệt của bạn không hỗ trợ nhận diện giọng nói.');
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = 'vi-VN';
      recognition.interimResults = true;
      recognition.continuous = true; // Cho phép nhận diện liên tục
      finalTranscript = '';
      inputElement.innerText = '';
      recognition.onstart = () => {
        // Thay icon mic bằng hiệu ứng sóng
        icon.innerHTML = `
          <span class="mic-wave">
            <span class="mic-wave-bar"></span>
            <span class="mic-wave-bar"></span>
            <span class="mic-wave-bar"></span>
            <span class="mic-wave-bar"></span>
            <span class="mic-wave-bar"></span>
          </span>
        `;
        icon.classList.add('voice-anim');
        isListening = true;
      };
      recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        // Hiển thị kết quả tạm thời + kết quả cuối cùng
        inputElement.innerText = finalTranscript + interimTranscript;
        // Đặt con trỏ về cuối
        placeCaretAtEnd(inputElement);
      };
      recognition.onerror = (event) => {
        icon.innerHTML = 'mic';
        icon.classList.remove('voice-anim');
        isListening = false;
        // Không xóa nội dung nhập liệu khi lỗi
      };
      recognition.onend = () => {
        icon.innerHTML = 'mic';
        icon.classList.remove('voice-anim');
        isListening = false;
        // Giữ lại nội dung đã nhận diện
      };
      recognition.start();
    }
    // Hàm đặt con trỏ về cuối contenteditable
    function placeCaretAtEnd(el) {
      el.focus();
      if (typeof window.getSelection != "undefined"
          && typeof document.createRange != "undefined") {
        var range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }
    // Loại bỏ HTML để đọc sạch
    function stripHtml(html) {
      var tmp = document.createElement('div');
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || '';
    }
    
    // Tạo cuộc trò chuyện mới
    function newChat() {
      if (confirm('Bạn có chắc chắn muốn bắt đầu cuộc trò chuyện mới? Lịch sử hiện tại sẽ bị xóa.')) {
        chatHistory = [];
        localStorage.removeItem('khoaAI_chatHistory');
        location.reload(); // Tải lại trang như F5
        
        const chatContainer = document.getElementById('chat-container');
        chatContainer.innerHTML = '';
        
        document.getElementById('welcome-message').classList.remove('hidden');
        document.getElementById('chat-input').innerText = '';
        hasMessages = false;
      }
    }
    
    // Tự động thay đổi chiều cao ô nhập liệu
    document.getElementById('chat-input').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
    
    // Xử lý phím Enter (gửi) và Shift+Enter (xuống dòng)
    document.getElementById('chat-input').addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
      }
    });

    // Hàm copy cho bảng code hiện đại
    function copyModernCode(codeId) {
      const codeBlock = document.getElementById(codeId).querySelector('code');
      const code = codeBlock.innerText;
      navigator.clipboard.writeText(code).then(() => {
        // Hiệu ứng copied
        const btn = document.activeElement;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-check'></i>";
        setTimeout(() => {
          btn.innerHTML = originalHtml;
        }, 1500);
      });
    }
    // Hàm phóng to code full màn hình
    function expandCodeFullScreen(codeId, lang) {
      const codeBlock = document.getElementById(codeId).querySelector('code');
      const code = codeBlock.innerText;
      // Tạo overlay
      let overlay = document.createElement('div');
      overlay.className = 'fullscreen-code-overlay';
      overlay.innerHTML = `
        <div class="fullscreen-code-table">
          <div class="fullscreen-code-header">
            <span class="fullscreen-code-lang">${lang}</span>
            <div class="fullscreen-code-actions">
              <button class="fullscreen-code-copy" onclick="copyFullScreenCodeDirect()"><i class='far fa-copy'></i></button>
              <button class="fullscreen-code-close" onclick="closeFullScreenCode(this)"><i class='fas fa-compress'></i></button>
            </div>
          </div>
          <div class="fullscreen-code-body"><pre><code class="language-${lang}" id="fullscreen-codeblock"></code></pre></div>
        </div>
      `;
      document.body.appendChild(overlay);
      // Typing effect cho code trong overlay nếu chưa đầy đủ
      const codeEl = overlay.querySelector('#fullscreen-codeblock');
      let state = window.fullscreenCodeTypingState;
      if (state && state.code === escapeHtml(code) && !state.done) {
        codeEl.textContent = '';
        typeWriterEffect(codeEl, escapeHtml(code), state.index || 0, isMobileDevice() ? 0 : 1, () => {
          hljs.highlightElement(codeEl);
        }, 'fullscreen');
      } else if (state && state.code === escapeHtml(code) && state.done) {
        codeEl.innerHTML = state.html;
        hljs.highlightElement(codeEl);
      } else {
        window.fullscreenCodeTypingState = { code: escapeHtml(code), index: 0, html: '', done: false };
        codeEl.textContent = '';
        typeWriterEffect(codeEl, escapeHtml(code), 0, isMobileDevice() ? 0 : 1, () => {
          hljs.highlightElement(codeEl);
        }, 'fullscreen');
      }
    }
    // Hàm copy toàn bộ code trong overlay fullscreen
    function copyFullScreenCodeDirect() {
      const overlay = document.querySelector('.fullscreen-code-overlay');
      if (!overlay) return;
      const code = overlay.querySelector('code').innerText;
      navigator.clipboard.writeText(code).then(() => {
        const btn = overlay.querySelector('.fullscreen-code-copy');
        if (btn) {
          const originalHtml = btn.innerHTML;
          btn.innerHTML = "<i class='fas fa-check'></i>";
          setTimeout(() => {
            btn.innerHTML = originalHtml;
          }, 1500);
        }
      });
    }
    function closeFullScreenCode(btn) {
      const overlay = btn.closest('.fullscreen-code-overlay');
      if (overlay) overlay.remove();
      // Sau khi đóng overlay, highlight lại code trong chat
      setTimeout(() => {
        document.querySelectorAll('.modern-code-body code').forEach(block => {
          hljs.highlightElement(block);
        });
      }, 10);
    }
    // Hiển thị file preview phía trên ô nhập chat
    function updateFilePreview() {
      const container = document.getElementById('file-preview-container');
      if (!currentFileContent || !currentFileName) {
        container.style.display = 'none';
        container.innerHTML = '';
        return;
      }
      const ext = currentFileName.split('.').pop().toLowerCase();
      const fileTypeInfo = getFileTypeInfo(ext);
      container.innerHTML = `
        <div class="file-preview-box">
          <span class="file-preview-icon" style="color:${fileTypeInfo.color}">${fileTypeInfo.icon}</span>
          <div class="file-preview-info">
            <span class="file-preview-name">${currentFileName}</span>
            <span class="file-preview-type">${fileTypeInfo.label}</span>
          </div>
          <button class="file-preview-remove" title="Xóa file" onclick="removeUploadedFile()"><i class="fas fa-times"></i></button>
        </div>
      `;
      container.style.display = '';
    }
    // Nhận diện loại file, icon, màu, label
    function getFileTypeInfo(ext) {
      const map = {
        'py':  { icon: '<i class="fab fa-python"></i>', color: '#ff9800', label: 'Python' },
        'js':  { icon: '<i class="fab fa-js-square"></i>', color: '#f7df1e', label: 'JavaScript' },
        'ts':  { icon: '<i class="fab fa-js"></i>', color: '#007acc', label: 'TypeScript' },
        'java':{ icon: '<i class="fab fa-java"></i>', color: '#e76f00', label: 'Java' },
        'c':   { icon: '<i class="fas fa-code"></i>', color: '#2196f3', label: 'C' },
        'cpp': { icon: '<i class="fas fa-code"></i>', color: '#1976d2', label: 'C++' },
        'txt': { icon: '<i class="far fa-file-alt"></i>', color: '#90caf9', label: 'Text' },
        'md':  { icon: '<i class="fab fa-markdown"></i>', color: '#fff', label: 'Markdown' },
        'csv': { icon: '<i class="fas fa-table"></i>', color: '#43a047', label: 'CSV' },
        'json':{ icon: '<i class="fas fa-brackets-curly"></i>', color: '#ffb300', label: 'JSON' },
        'xml': { icon: '<i class="fas fa-code"></i>', color: '#ab47bc', label: 'XML' },
        'html':{ icon: '<i class="fab fa-html5"></i>', color: '#e44d26', label: 'HTML' },
        'log': { icon: '<i class="fas fa-file-alt"></i>', color: '#bdbdbd', label: 'Log' },
        'pdf': { icon: '<i class="far fa-file-pdf"></i>', color: '#e53935', label: 'PDF' },
        'doc': { icon: '<i class="far fa-file-word"></i>', color: '#1976d2', label: 'Word' },
        'docx':{ icon: '<i class="far fa-file-word"></i>', color: '#1976d2', label: 'Word' },
        'xls': { icon: '<i class="far fa-file-excel"></i>', color: '#43a047', label: 'Excel' },
        'xlsx':{ icon: '<i class="far fa-file-excel"></i>', color: '#43a047', label: 'Excel' },
      };
      return map[ext] || { icon: '<i class="fas fa-file"></i>', color: '#fff', label: ext.toUpperCase() };
    }
    // Xóa file đã upload
    function removeUploadedFile() {
      currentFileContent = null;
      currentFileName = null;
      updateFilePreview();
    }
    // Khi xóa file thì update preview
    // Khi load lại trang, nếu có file thì update preview
    window.addEventListener('DOMContentLoaded', updateFilePreview);

    // Thêm animation loading mới đẹp hơn
    function showFileLoadingAnimationV2(filename) {
      removeFileLoadingAnimationV2();
      const chatContainer = document.getElementById('chat-container');
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'flex justify-start';
      loadingDiv.id = 'file-loading-animation-v2';
      loadingDiv.innerHTML = `
        <div class="max-w-[85%] bg-gradient-to-r from-blue-100 to-blue-50 rounded-2xl px-4 py-3 flex items-center gap-3 shadow-md animate-pulse">
          <span class="fa fa-spinner fa-spin text-blue-500 text-2xl"></span>
          <span id="file-loading-text-v2" class="font-medium text-blue-700">Đang tải file <b>${filename}</b>...</span>
        </div>
      `;
      chatContainer.appendChild(loadingDiv);
      scrollToBottom(true);
      return loadingDiv;
    }
    function removeFileLoadingAnimationV2() {
      const loadingDiv = document.getElementById('file-loading-animation-v2');
      if (loadingDiv) loadingDiv.remove();
    }

    // Hàm tự động mở overlay fullscreen code và typing code trong overlay
    function autoExpandCodeFullScreenTyping(code, lang) {
      const oldOverlay = document.getElementById('auto-fullscreen-code-overlay');
      if (oldOverlay) oldOverlay.remove();
      let overlay = document.createElement('div');
      overlay.className = 'fullscreen-code-overlay';
      overlay.id = 'auto-fullscreen-code-overlay';
      overlay.innerHTML = `
        <div class="fullscreen-code-table">
          <div class="fullscreen-code-header">
            <span class="fullscreen-code-lang">${lang}</span>
            <div class="fullscreen-code-actions">
              <button class="fullscreen-code-copy" onclick="copyFullScreenCodeDirect()"><i class='far fa-copy'></i></button>
              <button class="fullscreen-code-close" onclick="closeAutoFullScreenCode()"><i class='fas fa-compress'></i></button>
            </div>
          </div>
          <div class="fullscreen-code-body"><pre><code class="language-${lang}" id="auto-fullscreen-codeblock"></code></pre></div>
        </div>
      `;
      document.body.appendChild(overlay);
      const codeEl = overlay.querySelector('#auto-fullscreen-codeblock');
      // Nếu code đã gõ xong thì hiển thị luôn, nếu chưa thì tiếp tục từ vị trí trước đó
      let state = window.fullscreenCodeTypingState;
      if (state && state.code === escapeHtml(code) && !state.done) {
        codeEl.textContent = '';
        typeWriterEffect(codeEl, escapeHtml(code), state.index || 0, isMobileDevice() ? 0 : 1, () => {
          hljs.highlightElement(codeEl);
        }, 'fullscreen');
      } else if (state && state.code === escapeHtml(code) && state.done) {
        codeEl.innerHTML = state.html;
        hljs.highlightElement(codeEl);
      } else {
        window.fullscreenCodeTypingState = { code: escapeHtml(code), index: 0, html: '', done: false };
        codeEl.textContent = '';
        typeWriterEffect(codeEl, escapeHtml(code), 0, isMobileDevice() ? 0 : 1, () => {
          hljs.highlightElement(codeEl);
        }, 'fullscreen');
      }
    }
    function closeAutoFullScreenCode() {
      const overlay = document.getElementById('auto-fullscreen-code-overlay');
      if (overlay) overlay.remove();
      // Sau khi đóng overlay, highlight lại code trong chat
      setTimeout(() => {
        document.querySelectorAll('.modern-code-body code').forEach(block => {
          hljs.highlightElement(block);
        });
      }, 10);
    }

    // Xử lý nút đóng thông báo tính năng AI
    document.addEventListener('DOMContentLoaded', function() {
      const note = document.getElementById('ai-feature-note');
      const closeBtn = document.getElementById('ai-feature-note-close');
      if (closeBtn) {
        closeBtn.onclick = function() {
          note.style.display = 'none';
          localStorage.setItem('aiFeatureNoteClosed', '1');
        };
      }
      // Nếu đã đóng trước đó thì ẩn luôn
      if (localStorage.getItem('aiFeatureNoteClosed') === '1') {
        note.style.display = 'none';
      }
    });

    // === DARK MODE THEME LOGIC ===
    function setTheme(theme) {
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        document.getElementById('theme-toggle-icon').textContent = 'light_mode';
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        document.getElementById('theme-toggle-icon').textContent = 'dark_mode';
      }
    }
    function toggleTheme() {
      const isDark = document.documentElement.classList.contains('dark');
      setTheme(isDark ? 'light' : 'dark');
    }
    // Tự động nhận diện theme hệ điều hành nếu chưa chọn
    (function() {
      let theme = localStorage.getItem('theme');
      if (!theme) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      setTheme(theme);
    })();
    document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

    let isDevMode = false;
    let prevTheme = null;
    const DEV_SYSTEM_PROMPT = `
Bạn là trợ lý AI chuyên về lập trình, code, debug, giải thích lỗi, tạo test case.
- Luôn trả lời chi tiết, giải thích từng phần code.
- Nếu người dùng gửi yêu cầu code, hãy trả về code hoàn chỉnh, mạnh mẽ, nhiều dòng, nhiều token nhất, không rút gọn, đủ để chạy được, không bỏ qua phần nào.
- Ưu tiên trả lời bằng tiếng Việt, trình bày rõ ràng, có ví dụ minh họa.
- Nếu có thể, hãy highlight code, giải thích từng dòng, và đưa ra lưu ý thực tế.
- Không bao giờ trả về code tóm tắt hoặc chỉ một phần, luôn trả về code đầy đủ nhất có thể.
`;

    // Thêm sự kiện cho nút chuyển chế độ AI lập trình
    document.getElementById('dev-mode-toggle').addEventListener('click', function() {
      isDevMode = !isDevMode;
      hideWelcomeMessage();
      this.classList.toggle('active', isDevMode);
      // Ẩn welcome-message nếu chưa có tin nhắn
      if (!hasMessages) {
        document.getElementById('welcome-message').classList.add('hidden');
        hasMessages = true;
      }
      // Đổi giao diện khi bật/tắt chế độ lập trình
      if (isDevMode) {
        // Lưu trạng thái theme trước đó
        prevTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        if (!document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.add('dark');
        }
        document.body.classList.add('dev-mode-hacker');
        // Hiện animation hướng dẫn tắt chế độ
        showDevModeHint();
      } else {
        // Trả lại trạng thái theme trước đó
        if (prevTheme === 'light') {
          document.documentElement.classList.remove('dark');
        }
        document.body.classList.remove('dev-mode-hacker');
        removeDevModeHint();
      }
      addMessage('assistant', isDevMode
        ? '🧑‍💻 Đã bật chế độ AI hỗ trợ lập trình. Hãy gửi code hoặc câu hỏi về lập trình để mình giúp nhé!'
        : 'Đã tắt chế độ AI hỗ trợ lập trình.');
    });

    // Animation hướng dẫn tắt chế độ lập trình
    function showDevModeHint() {
      removeDevModeHint();
      const chatContainer = document.getElementById('chat-container');
      const hintDiv = document.createElement('div');
      hintDiv.className = 'dev-mode-hint';
      hintDiv.innerHTML = `
        <span class="dev-mode-arrow">↓</span>
        <span>Bấm lại <b><i class='material-icons' style='vertical-align:middle'>code</i> Chế độ lập trình</b> phía trên để <u>tắt chế độ này</u>!<br>Hoặc tiếp tục gửi code để được hỗ trợ.</span>
      `;
      chatContainer.prepend(hintDiv);
    }
    function removeDevModeHint() {
      const hint = document.querySelector('.dev-mode-hint');
      if (hint) hint.remove();
    }

    // === HIDE WELCOME MESSAGE LOGIC ===
    function hideWelcomeMessage() {
      const welcome = document.getElementById('welcome-message');
      if (welcome && !welcome.classList.contains('hidden')) {
        welcome.classList.add('hidden');
        hasMessages = true;
        // Ẩn thông báo tính năng AI
        const note = document.getElementById('ai-feature-note');
        if (note) note.style.display = 'none';
      }
    }

    // Hàm nhận diện yêu cầu về code
    function isCodeRequest(message) {
      const codeKeywords = [
        'code', 'viết code', 'python', 'js', 'javascript', 'typescript', 'java', 'c++', 'c#', 'test case', 'giải thích code', 'debug', 'lỗi', 'hàm', 'function', 'class', 'component', 'py'
      ];
      const lower = message.toLowerCase();
      return codeKeywords.some(keyword => lower.includes(keyword));
    }

    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    function togglePlusMenu() {
      const menu = document.getElementById('plus-menu');
      const plusIcon = document.getElementById('plus-icon');
      menu.classList.toggle('hidden');
      if (!menu.classList.contains('hidden')) {
        plusIcon.classList.add('plus-rotate');
        setTimeout(() => {
          document.addEventListener('mousedown', closePlusMenuOnClickOutside);
        }, 10);
      } else {
        plusIcon.classList.remove('plus-rotate');
      }
    }
    function closePlusMenuOnClickOutside(e) {
      const menu = document.getElementById('plus-menu');
      const btn = document.getElementById('file-upload-btn');
      const plusIcon = document.getElementById('plus-icon');
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.add('hidden');
        plusIcon.classList.remove('plus-rotate');
        document.removeEventListener('mousedown', closePlusMenuOnClickOutside);
      }
    }
    function toggleDevModeFromMenu() {
      isDevMode = !isDevMode;
      hideWelcomeMessage();
      // Đổi giao diện khi bật/tắt chế độ lập trình
      if (isDevMode) {
        prevTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        if (!document.documentElement.classList.contains('dark')) {
          document.documentElement.classList.add('dark');
        }
        document.body.classList.add('dev-mode-hacker');
        showDevModeHint();
        addMessage('assistant', '🧑‍💻 Đã bật chế độ AI hỗ trợ lập trình. Hãy gửi code hoặc câu hỏi về lập trình để mình giúp nhé!');
      } else {
        if (prevTheme === 'light') {
          document.documentElement.classList.remove('dark');
        }
        document.body.classList.remove('dev-mode-hacker');
        removeDevModeHint();
        addMessage('assistant', 'Đã tắt chế độ AI hỗ trợ lập trình.');
      }
      document.getElementById('plus-menu').classList.add('hidden');
    }

    function showNewChatPopup() {
      // Nếu đã có popup thì không tạo thêm
      if (document.getElementById('new-chat-popup-overlay')) return;
      const overlay = document.createElement('div');
      overlay.id = 'new-chat-popup-overlay';
      overlay.innerHTML = `
        <div id="new-chat-popup">
          <button class="new-chat-close" onclick="closeNewChatPopup()">&times;</button>
          <div class="new-chat-title">
            🚀 Bắt đầu cuộc trò chuyện mới
          </div>
          <div style="color:#374151;font-size:1.08em;margin-bottom:0.5em;">
            Bạn muốn bắt đầu một cuộc trò chuyện mới với <b>Hie AI</b>?
          </div>
          <div class="new-chat-btns">
            <button class="new-chat-btn" onclick="startNewChat()">Bắt đầu chat mới</button>
            <button class="new-chat-btn" style="background:linear-gradient(90deg,#43e97b 0%,#38f9d7 100%);" onclick="startAnonymousChat()">Chat ẩn danh</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      // Đóng popup khi click ra ngoài
      overlay.addEventListener('mousedown', function(e) {
        if (e.target === overlay) closeNewChatPopup();
      });
    }
    function closeNewChatPopup() {
      const overlay = document.getElementById('new-chat-popup-overlay');
      if (overlay) overlay.remove();
    }
    function startNewChat() {
      closeNewChatPopup();
      newChat();
    }
    function startAnonymousChat() {
      closeNewChatPopup();
      // Logic chat ẩn danh: xóa lịch sử, đặt biến ẩn danh, reload lại giao diện
      chatHistory = [];
      localStorage.removeItem('khoaAI_chatHistory');
      // Có thể đặt biến isAnonymous = true nếu muốn
      location.reload();
    }
  </script>
</body>
</html>
